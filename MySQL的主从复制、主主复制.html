<html>
<head>
  <title>MySQL的主从复制、主主复制</title>
  <basefont face="宋体" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="YXBJ Windows/600718 (zh-CN, DDL); Windows/10.0.0 (Win64);"/>
  <style>
    body, td {
      font-family: 宋体;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="1433"/>
<h1>MySQL的主从复制、主主复制</h1>

<div>
<span style="word-wrap: break-word; -webkit-nbsp-mode: space; -webkit-line-break: after-white-space;">
mysqlbinlog 日志名
<div>查看二进制文件内容（起始时间和结束位置）</div><div>mysqlbinlog --start-datetime=&quot;2010-07-01 13:20:20&quot; --stop-datetime=&quot;2010-07-01 13:20:50&quot; mysqlbinlogxxxx | mysql -uusername -p                         <font color="#328712"><i>#按时间恢复</i></font></div><div>mysqlbinlog --start-position=&quot;111&quot; --stop-position=&quot;333&quot; mysql-bin.123456 | mysql -uroot -p</div><div><i><font color="#328712">#按位置恢复</font></i></div><div><br/></div><div>**********************************************************************************</div><div><font color="#DE5700">主从复制：</font></div><div>主数据库IP：192.168.216.16</div><div>从数据库IP：192.168.216.17</div><div>    <font color="#DE5700"> 1、修改主服务器master：</font></div><div># vim /etc/my.cnf</div><div>     [mysqld]</div><div>     log-bin=mysql-bin                                   <i><font color="#328712">#</font><font color="#E30000">[必须]</font><font color="#328712">启用二进制日志</font></i></div><div>     server-id=1                                              <i><font color="#328712">#</font><font color="#E30000">[必须]</font><font color="#328712">服务器唯一ID，默认是1，一般取IP最后一段</font></i></div><div>     <font color="#DE5700">2、修改从服务器slave：</font></div><div># vim /etc/my.cnf</div><div>     [mysqld]</div><div>     log-bin=mysql-bin                                   <i><font color="#328712">#</font><font color="#E30000">[非必须]</font><font color="#328712">启用二进制日志</font></i></div><div>     server-id=2                                              <i><font color="#328712">#</font><font color="#E30000">[必须]</font><font color="#328712">服务器唯一ID，默认是1，一般取IP最后一段</font></i></div><div>    <font color="#DE5700"> 3、重启两台服务器的mysql</font></div><div>/etc/init.d/mysqld restart</div><div>     <font color="#DE5700">4、在主服务器上建立账户并授权slave：</font></div><div># mysql -uroot -p密码</div><div>mysql&gt;grant replication slave on *.* to 'zhangsan'@'%' identified by '123456';</div><div><i><font color="#328712">#一般不用root账号，&quot;%&quot;表示所有的客户端都可能连，只要账号，密码正确，此处可用具体客户端IP代替，如192.168.216.17，加强安全。</font></i></div><div>    <font color="#DE5700"> 5、登录主服务器的mysql，查询master的状态</font></div><div>mysql&gt;show master status;</div><div>   +------------------+----------+--------------+------------------+<br/>
   | File                        | Position | Binlog_Do_DB | Binlog_Ignore_DB |<br/>
   +------------------+----------+--------------+------------------+<br/>
   | mysql-bin.000001 |       98     |                      |                             |<br/>
   +------------------+----------+--------------+------------------+<br/>
   1 row in set (0.00 sec)</div><div>注：执行完此步骤后不要再操作主服务器mysql，防止服务器状态值position变化，下一步会用到</div><div>    <font color="#DE5700"> 6、配置从服务器slave：</font></div><div>mysql&gt;change master to master_host=&quot;192.168.216.16&quot;，master_user='zhangsan',master_password='123456'，master_log_file='mysql-bin.000001',master_log_pos=98;</div><div><i><font color="#328712">#注意不要断开，98不要加引号</font></i></div><div>mysql&gt;start slave;                                   <i><font color="#328712">#开启从服务器复制功能</font></i></div><div>    <font color="#DE5700"> 7、检查从服务器复制功能状态</font></div><div>mysql&gt;show slave status\G;</div><div>输出信息有以下两则配置就成功：</div><div>Slave_IO_Running：Yes</div><div>Slave_SQL_Running：Yes</div><div>     <font color="#DE5700">8、在主服务器上创建数据库测试</font></div><div><br/></div><div>*************************************************************************************</div><div><br/></div><div><font color="#DE5700">主主复制：</font></div><div>A服务器：192.168.216.16</div><div>B服务器：192.168.216.17</div><div><font color="#DE5700">一、修改参数</font></div><div>服务器A配置如下：</div><div># vim /etc/my.cnf</div><div>log-bin=mysql-bin</div><div>server-id=1</div><div>expire-logs-days=99</div><div>replicate-do-db=test</div><div>binlog-ignore-db=mysql</div><div>binlog-ignore-db=information_schema</div><div>auto-increment-increment=2</div><div>auto-increment-offset=1</div><div><br/></div><div>服务器B配置如下：</div><div># vim /etc/my.cnf</div><div>log-bin=mysql-bin</div><div>server-id=2</div><div>expire-logs-days=99</div><div>replicate-do-db=test</div><div>binlog-ignore-db=mysql</div><div>binlog-ignore-db=information_schema</div><div>auto-increment-increment=2</div><div>auto-increment-offset=2</div><div><br/></div><div>两台服务器都重启</div><div>mysql&gt;service mysqld restart</div><div>注：二者只有server-id和auto-incremetn-offset不同</div><div>     <font color="#E30000">auto-increment-offset</font>是用来设定数据库中自动增长起点的，因为这两台服务器都设定了一次自动增长值2，所以它们的起点必须得不同，这样才能避免两台服务器数据同步时出现主键冲突</div><div>     <font color="#E30000">replicate-do-db</font>指定同步的数据库，这里只在两台服务器间同步test数据库</div><div>另：<font color="#E30000">auto-increment-increment</font>的值应设为整个结构中服务器的总数，本案例用到两台服务器，所以值为2。</div><div><font color="#DE5700">二、同步数据</font></div><div>myaql&gt; flush tables with read lock;</div><div># mysqldump -uroot -p --database test &gt; /tmp/test.sql</div><div>msql&gt; unlock tables;</div><div><font color="#DE5700">三、相互授权用户（在A服务器授权一个允许B访问的用户，反之亦然）</font></div><div>在服务器A上</div><div>mysql&gt;grant replication slave on *.* to 'zhangsan'@'192.168.216.17' identified by '123456';</div><div>mysql&gt;flush privileges;</div><div>在服务器B上</div><div>mysql&gt;grant replication slave on *.* to 'zhangsan'@'192.168.216.16' identified by '123456';</div><div>mysql&gt;flush privileges;</div><div><font color="#DE5700">四、互告bin-log信息</font></div><div>在服务器A</div><div>mysql&gt;show master status;</div><div>+------------------+----------+--------------+--------------------------+<br/>
| File                       | Position   | Binlog_Do_DB | Binlog_Ignore_DB            |<br/>
+------------------+----------+--------------+--------------------------+<br/>
| mysql-bin.000006 |         106 |                      |mysql,information_schema|<br/>
+------------------+----------+--------------+--------------------------+</div><div>在服务器B</div><div>mysql&gt;show master status;</div><div>+------------------+----------+--------------+--------------------------+<br/>
| File                       | Position   | Binlog_Do_DB |     Binlog_Ignore_DB        |<br/>
+------------------+----------+--------------+--------------------------+<br/>
| mysql-bin.000008|         192 |                      |mysql,information_schema|<br/>
+------------------+----------+--------------+--------------------------+</div><div>在A服务器上执行</div><div>mysql&gt;change master to master_host='192.168.216.17',master_user='zhangsan',master_password='123456',master_log_file='mysql-bin.000008',master_log_pos=192;</div><div>在B服务器上执行</div><div>mysql&gt;change master to master_host='192.168.216.16',master_user='zhangsan',master_password='123456',master_log_file='mysql-bin.000006',master_log_pos=106;</div><div><font color="#DE5700">五、在两台服务器都执行以下命令</font></div><div>mysql&gt;start slave;</div><div><font color="#DE5700">六、在两台服务器上分别查看状态</font></div><div>mysql&gt;show slave status\G;</div><div>有以下两项则配置成功：</div><div>Slave_IO_Running：Yes</div><div>Slave_SQL_Running：Yes</div><div><font color="#DE5700">七、测试</font></div><div>在test库中创建表测试</div></span>
</div></body></html> 