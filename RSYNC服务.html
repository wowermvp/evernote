<html>
<head>
  <title>RSYNC服务</title>
  <basefont face="宋体" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="YXBJ Windows/600718 (zh-CN, DDL); Windows/10.0.0 (Win64);"/>
  <style>
    body, td {
      font-family: 宋体;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="1354"/>
<h1>RSYNC服务</h1>

<div>
<span style="word-wrap: break-word; -webkit-nbsp-mode: space; -webkit-line-break: after-white-space;"><font color="#DE5700">简介</font><div>     Rsync（remote synchronize）是一个远程数据同步工具，可通过LAN/WAN快速同步多台主机间文件，也中可以使用Rsync同步本地硬盘中的不同目录。</div><div>     Rsync是用于取代rcp的一个工具，Rsync使用所谓的“Rsync算法”来使用本地和远程两个主机之间的文件达到同步，这个算法只传送两个文件的不同部分，而不是每次都整份传送，因此速度相当快。（可以参考How Rsync Works A Practical Overview进一步了解rsync的动作机制）。</div><div>     Rsync支持大多数Unix系统，无论是linux、solaris还是BSD上都经过了良好的测试。此外，它在windows平台下也有相应的版本，比较知名的有cwRsync和Sync2NAS。</div><div><font color="#DE5700">特点：</font></div><div>     能更新整个目录和树和文件系统；</div><div>     有选择性的保持符号链接、硬链接、文件属于、权限、设备以及时间等；</div><div>     对于安装来说，无任何特殊权限要求；</div><div>     对于多个文件来说，内部流水线减少文件等待的延时；</div><div>     能用rsh、ssh或直接端口做为传输入端口；</div><div>     支持匿名rsync同步文件，是理想的镜像工具。</div><div><font color="#DE5700">rsync同步源：</font></div><div>     指备份操作的远程服务器，也称为备份源</div><div>     主要包括两种：rsync源、ssh源</div><div><img src="RSYNC服务_files/Image.png" type="image/png" data-filename="Image.png" height="377" style="cursor: default;cursor: default;cursor: default;cursor: default;cursor: default;cursor: default;cursor: default;" width="784"/></div><div><font color="#DE5700">rsync命令的用法：</font></div><div><font color="#E30000">基本格式：rsync [选项] 原始位置 目标位置</font></div><div>选项：</div><div>-a：<font color="#328712">归档模式，递归并保留对象属性，等同于-rlptgoD</font></div><div>-v：<font color="#328712">显示同步过程的详细（verbose）信息</font></div><div>-z：<font color="#328712">在传输文件时进行压缩（compress）</font></div><div>-H：<font color="#328712">保留硬链接文件</font></div><div>-A：<font color="#328712">保留ACL属性</font></div><div>--delete：<font color="#328712">删除目标位置有而原始位置没有的文件</font></div><div>-r：<font color="#328712">递归模式，包含目录及子目录中所有文件</font></div><div>-l：<font color="#328712">对于符号链接文件仍然复制为符号链接文件</font></div><div>-p：<font color="#328712">保留文件的权限标记</font></div><div>-t：<font color="#328712">保留文件的时间标记</font></div><div>-g：<font color="#328712">保留文件的属组标记（仅超级用户使用）</font></div><div>-o：<font color="#328712">保留文件的属主标记（仅超级用户使用）</font></div><div>-D：<font color="#328712">保留设备文件及其他特殊文件</font></div><div><br/></div><div>  <img src="RSYNC服务_files/Image [1].png" type="image/png" data-filename="Image.png" style="cursor: default;cursor: default;cursor: default;cursor: default;cursor: default;cursor: default;cursor: default;"/></div><div>调整inotify内核参数</div><div>     max_queue_event：监控队列大小</div><div>     max_user_instrances：最多监控实例数</div><div>     max_user_watches：每个实例最多监控文件数</div><div>安装intotify-tools辅助工具</div><div>     inotifywait：用于持续监控，实时输出结果</div><div>     inotifywatch：用于短期监控，任务完成后再出结果</div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><font color="#DE5700">笔记部分</font></div><div><font color="#DE5700">一、rsync远程同步服务器</font></div><div>服务器端：同步源</div><div>客户端：发起端</div><div>同步源的搭建方式：ssh或rsync</div><div>访问控制列表：</div><div>     <font color="#328712">setfacl：设置特殊权限</font></div><div><font color="#328712">                    -m 添加权限 setfacl -m u:manager:r-x hr</font></div><div><font color="#328712">                    -x  删除一条特殊权限 setfacl -x u:manager hr</font></div><div><font color="#328712">                    -b  删除所有特殊权限 setfacl -b hr</font></div><div><font color="#328712">                    -R  递归</font></div><div><font color="#328712">                    default 设置默认权限（对未来创建的文件也生效）</font></div><div><font color="#DE5700">二、利用SSH搭建同步源</font></div><div><font color="#DE5700">服务器端：创建同步目录：</font>mkdir /var/ssh</div><div>                <font color="#DE5700">创建测试用文件：</font>touch /var/ssh/ssh.txt</div><div>                <font color="#DE5700">设置权限：</font>          useradd a1     <font color="#328712">用来上传</font></div><div>                                          useradd  a2     <font color="#328712">用来下载</font></div><div>                                          chown a1:a1 /var/ssh</div><div><font color="#DE5700">客户端：创建同步目录：</font> mkdir /ssh</div><div>             <font color="#DE5700">同步服务器数据：</font>rsync -avz a1@192.168.1.1:/var/ssh/* /ssh</div><div><font color="#DE5700">三、利用RSYNC搭建同步源</font></div><div>     <font color="#DE5700">服务器端：</font></div><div><font color="#DE5700">创建同步目录：</font>mkdir /var/rsync</div><div><font color="#DE5700">创建测试用文件：</font>touch /var/rsync/rsync.txt</div><div><font color="#DE5700">创建主配置文件：</font>vim /etc/rsyncd.conf</div><div>                         use chroot = yes</div><div>                         address = 服务器IP地址</div><div>                         port 873</div><div><font color="#2D4FC9">                         </font>log file = /var/log/rsyncd.log     <font color="#328712"><i>#rsyncd的日志文件</i></font></div><div>                         pid file = /var/run/rsyncd.pid     <font color="#328712"><i>#rsyncd进程ID保存文件</i></font></div><div>                         [share]                                        <font color="#328712"><i>#共享文件名</i></font></div><div>                         path = /var/rsync                       <i><font color="#328712">#共享的文件夹（绝对路径）</font></i></div><div>                         comment = this is rsync directory</div><div>                         read only = yes                           <i><font color="#328712">#为yes时只能下载文件，为no时可以下载和上传</font></i></div><div>                         dont compress = *.gz *.bz2 *.tar.gz *.rar *.zip</div><div>                         <font color="#328712"><i>#不压缩此选项中扩展名文件</i></font></div><div>                        <font color="#2D4FC9"> </font>auth users = aa                                 <i><font color="#328712">#账户</font></i></div><div>                         secrets file = /etc/rsyncd_users.db   <font color="#328712"><i>#密码保存文件</i></font>  </div><div><font color="#DE5700">创建账户文件：</font>vim /etc/rsyncd_users.db <font color="#2D4FC9">   </font>                <font color="#328712"><i>#该文件的权限必须为600</i></font></div><div>                         aa:123456</div><div><font color="#DE5700">开启服务：</font>rsync     --daemon</div><div><font color="#DE5700">关闭服务：</font>kill $(cat /var/run/rsync.pid)</div><blockquote style="margin: 0 0 0 40px; border: none; padding: 0px;"><div><font color="#DE5700">客户端：                    </font></div></blockquote><div><font color="#DE5700">创建同步目录：</font>mkdir/rsync</div><div><font color="#DE5700">同步服务器数据：</font>rsync -avz aa@192.168.1.1::share /rsync</div><div>                          rsync -avz rsync://aa@192.168.1.1/share /rsync</div><div><font color="#E30000">注：--delete选项可以使客户端的同步目录的内容和服务器同步目录保持完全一致</font></div><div><font color="#DE5700">四、同步脚本</font></div><div><font color="#DE5700">     基于SSH的远程同步服务器：</font></div><div><font color="#DE5700">客户端：</font>ssh-keygen -t rsa</div><div>             ssh-copy-id a2@192.168.1.1</div><div>             ssh gg@192.168.1.1</div><div>             rsync -avz gg@192.168.1.1:/var/ssh/* /ssh</div><div>     <font color="#DE5700">基于rsync的远程同步服务器：</font></div><div><font color="#DE5700">客户端：</font>export RSYNC_PASSWORD=123456</div><div>             rsync -avz aa@192.168.1.1::share /rsync</div><div><font color="#DE5700">五、自动备份</font></div><div>    <font color="#DE5700"> inotify两个组件：</font></div><div>inotifywait：<font color="#328712">持续监控，一有变动，立即输出结果</font></div><div>inotifywatch：<font color="#328712">收集文件系统变化情况，并在运行结束后输出汇总的变化情况</font></div><div><font color="#DE5700">修改内核参数：</font></div><div>max_queued_evnents：<font color="#DE5700">监控队列</font></div><div>max_user_instances：<font color="#DE5700">最多监控实例数</font></div><div>max_user_watches：<font color="#DE5700">每个实例最多监控文件数</font></div><div>[root@localhost ~]# vi /etc/sysctl.conf</div><div>......省略......</div><div>fs.inotify.max_queued_events = 16384</div><div>fs.inotify.max_user_instances = 1024</div><div>fs.inotify.max_user_watches = 1048576</div><div>[root@localhost ~]# sysctl -p</div><div><br/></div><div><font color="#E30000">inotifywait -mrq -e modify,create,move,delete /var/www/html</font></div><div>m     持续监控</div><div>r       所有子对象</div><div>q      简化输出</div><div>e      指定监控的事件类型</div><div><br/></div><div><font color="#2D4FC9">#！/bin/bash</font></div><div><font color="#2D4FC9">INOTIFY_CMD=&quot;inotifywait -mrq -e modify,create,atrrib,move,delete /var/www/html/&quot;</font></div><div><font color="#2D4FC9">RSYNC_CMD=&quot;rsync -azH --delete /var/www/html/ rput@192.168.4.4:/var/www/html&quot;</font></div><div><font color="#2D4FC9">$INOTIFY_CMD | while read DIRECTORY EVENT FILE</font></div><div><font color="#2D4FC9">do</font></div><div><font color="#2D4FC9">     if [ $(grep rsync | wc -l) -le 0 ]; then</font></div><div><font color="#2D4FC9">          #RSYNC_CMD</font></div><div><font color="#2D4FC9">     fi</font></div><div><font color="#2D4FC9">done</font></div><div><br/></div><div><font color="#DE5700">双向同步</font></div><div><font color="#DE5700">第一步，保证两台服务器之间可以通过ssh无密码访问，操作如下（这里以root用户为例）：</font></div><div><font color="#DE5700">分别在server1和server2下，创建密钥</font></div><div>mkdir ~/.ssh</div><div>ssh-keygen -t rsa</div><div>ssh-copy-id 192.168.216.17</div><div>分别在两台机器上执行如下测试</div><div>ssh -p 22 192.168.216.17 date</div><div>ssh -p 22 192.168.216.16 date</div><div>至此用户授权完成</div><div><font color="#DE5700">第二步，安装</font></div><div><font color="#DE5700">安装unison</font></div><div><font color="#DE5700">首先安装ocaml，版本至少为3.07或更高</font></div><div>下载地址：http://caml.inria.fr/pub/distrib/ocaml-3.01/</div><div>tar -zxf ocaml-3.10.2.tar.gz</div><div>cd ocaml-3.10.2</div><div>./configure</div><div>make world opt</div><div>make install</div><div>cd ..</div><div><font color="#DE5700">安装unison</font></div><div>下载：http://www.seas.upenn.edu/~bcpierce/unison//download/releases/uniso-2.13.16/</div><div>tar -zxf unison-2.13.16.tar.gz</div><div>cd unison-2.13.16</div><div>make UISTYLE=text THREADS=true STATIC=true</div><div>cp unison /usr/local/bin</div><div>cd ..</div><div><font color="#DE5700">安装inotify</font></div><div>下载地址：http://inotify-tools.sourceforge.net</div><div>tar -zxf inotify-tools-3.14.tar.gz</div><div>cd inotify-tools-3.14</div><div>./configure</div><div>make</div><div>make install</div><div>cd ..</div><div>至此所需的软件都已经安装完毕，可以在server1服务器上执行这个命令，来查看两台服务器之间是否可以同步文件，<font color="#2D4FC9">unison -batch /home/server1/ ssh://192.168.10.2//home/server2</font>，如果这时候抱如下错误：</div><div><font color="#E30000">/usr/local/bin/inotifywait：error while loading shared libraries：libinotify</font></div><div>可以执行下这个命令：</div><div>ln -sv /usr/local/lib/libinotify* /usr/lib/</div><div>执行成功后，看目录下的文件是否同步</div><div><font color="#DE5700">第三步，同步脚本</font></div><div><font color="#DE5700">第三步，创建.sh脚本来执行同步</font></div><div><font color="#DE5700">1）server1上创建脚本/root/inotify.sh(chmod a+x /root/inotify.sh):</font></div><div>#/bin/bash</div><div>ip2=&quot;192.168.216.17&quot;</div><div>src2=&quot;/server1/&quot;</div><div>dst2=&quot;/server2/&quot;</div><div>/usr/local/bin/inotifywait -mrq -e create,delete,modify,move $src2 | while read line; </div><div>do</div><div>/usr/local/bin/unison -batch $src2 ssh://$ip2/$dst2</div><div>echo -n &quot;$line&quot; &gt;&gt; /var/log/inotify.log</div><div>echo $(date | cut -d &quot; &quot; -f1-4) &gt;&gt; /var/log/inotify.log</div><div>done</div><div><font color="#DE5700">2）server2上创建脚本/root/inotify.sh(chmod a+x /root/inotify.sh)</font></div><div>#!/bin/bash</div><div>ip2=&quot;192.168.216.16&quot;</div><div>src1=&quot;/server2/&quot;</div><div>dst1=&quot;/server1/&quot;</div><div>/usr/local/bin/inotifywait -mrq -e create,delete,modify,move $src1 | while read line; </div><div>do</div><div>/usr/local/bin/unison -batch $src2 ssh://$ip2/$dst2</div><div>echo -n &quot;$line&quot; &gt;&gt; /var/log/inotify.log</div><div>echo $(date | cut -d &quot; &quot; -f1-4) &gt;&gt; /var/log/inotify.log</div><div>done</div></span>
</div></body></html> 