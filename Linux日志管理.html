<html>
<head>
  <title>Linux日志管理</title>
  <basefont face="宋体" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="YXBJ Windows/600718 (zh-CN, DDL); Windows/10.0.0 (Win64);"/>
  <style>
    body, td {
      font-family: 宋体;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="1352"/>
<h1>Linux日志管理</h1>

<div>
<span><div style="word-wrap: break-word; -webkit-nbsp-mode: space; -webkit-line-break: after-white-space;"><font color="#DE5700"><b>一、日志简介</b></font><div><font color="#DE5700">1、日志相关服务</font></div><div>     在CentOS 6.x中日志服务已经由rsyslogd取代了原先的syslogd服务。Redhat认为syslogd已经不能满足在工作中的需求，rsyslogd相比syslogd具有一些新的特点：</div><div>     基于TCP网络协议传输日志信息；</div><div>     更安全网络传输方式；</div><div>     有日志消息的及时分析框架；</div><div>     后台数据库；</div><div>     配置文件中可以简单的逻辑判断；</div><div>     与syslogd配置文件相兼容。</div><div><font color="#DE5700">2、系统中常见的日志文件</font></div><div><table border="1" cellpadding="2" cellspacing="0" style="width:701px;" width="100%"><tr><td style="text-align: center;width:16.405135520684734%;" valign="top">日志文件</td><td style="text-align: center;width:83.3095577746077%;" valign="top">说明</td></tr><tr><td valign="top">/var/log/cron</td><td valign="top">记录了系统定时任务相关的日志</td></tr><tr><td valign="top">/vat/log/cups</td><td valign="top">记录了打印信息日志</td></tr><tr><td valign="top">/var/log/dmesg</td><td valign="top">记录了系统在开机时内核自检的信息。也可以使用dmesg命令直接查看内核自检信息。</td></tr><tr><td valign="top">/var/log/btmp</td><td valign="top">记录错误的日志。这个文件是二进制文件，不能vi直接查看，而要使用lastb命令查看。</td></tr><tr><td valign="top">/var/log/lastlog</td><td valign="top">记录系统中所有用户最后一次登录时间的日志。这个文件也是二进制文件，不能直接vi，而要用lastlog命令查看。</td></tr><tr><td valign="top">/var/log/mailog</td><td valign="top">记录邮件信息。</td></tr><tr><td valign="top">/var/log/message</td><td valign="top">记录系统重要信息的日志。这个日志文件会记录Linux系统的绝大多数重要信息，如果系统出现问题时，首先应该检查的就应该是这个日志文件。</td></tr><tr><td valign="top">/var/log/secure</td><td valign="top">记录验证和授权信息，只要涉及账户和密码的程序都会记录。比如系统登录，ssh登录，su切换用户，sudo授权，甚至添加用户和修改用户密码都记录在这个日志文件中</td></tr><tr><td valign="top">/var/log/wtmp</td><td valign="top">永久记录所有用户的登录、注销信息，同时记录系统的启动、重启、关机事件。同样这个二进制文件，不能直接vi，而需要用last命令查看。</td></tr><tr><td valign="top">/var/log/utmp</td><td valign="top">记录当前已经登录的用户的信息。这个文件会随着用户的登录和注销而不断变化，只记录当前登录用户的信息。同样这个文件不能直接vi，而使用w，who，users等命令来查询。</td></tr></table><div>     除了系统默认的日志之外，采用RPM方式安装的系统服务也会默认把日志记录在/var/log/目录中（源码包安装的服务日志是在源码包指定目录中）。不过这些日志不是由rsyslogd服务来记录和管理的，而是各个服务使用自己的日志管理文档来记录自身日志。</div></div><div><table border="1" cellpadding="2" cellspacing="0" style="width:701px;" width="100%"><tr><td style="text-align: center;width:30.099857346647646%;" valign="top">日志文件</td><td style="text-align: center;width:69.6148359486448%;" valign="top">说    明</td></tr><tr><td valign="top">/var/log/httpd/</td><td valign="top">RPM包安装的apache服务的默认日志记录</td></tr><tr><td valign="top">/var/log/mail/</td><td valign="top">RPM包安装的邮件服务有额外日志记录</td></tr><tr><td valign="top">/var/log/samba/</td><td valign="top">RPM包安装的samba服务的日志记录</td></tr><tr><td valign="top">/var/log/sssd/</td><td valign="top">守护进程安全服务目录</td></tr></table><div><b><font color="#DE5700">二、日志服务rsyslogd</font></b></div></div><div><font color="#DE5700">1、日志文件格式</font></div><div>     只要是由日志服务rsyslogd记录的日志文件，他们的格式是一样的。基本日志格式包含以下四列：</div><div>     a、事件产生的时间；</div><div>     b、发生事件的服务器的主机名；</div><div>     c、产生事件的服务名或程序名；</div><div>     d、事件的具体信息。</div><div><font color="#DE5700">2、rsyslogd服务的配置文件</font></div><div>     <font color="#DE5700">1）/etc/rsyslogd.conf配置文件格式</font></div><div>authpriv.*                                              /var/log/secure</div><div><i>#服务名称[连接符号]日志等级                    日志记录位置</i></div><div>#<i>认证相关服务，所有日志等级                   记录在/var/log/secure日志中</i></div><div>     服务名称</div><div>     首先确定rsyslogd服务可以识别哪些服务的日志，也可以理解为以下这些服务委托了rsyslogd服务来代为管理日志。这些服务如表：</div><div><table border="1" cellpadding="2" cellspacing="0" style="width:701px;" width="100%"><tr><td style="text-align: center;width:23.39514978601997%;" valign="top">服务名称</td><td style="text-align: center;width:76.31954350927246%;" valign="top">说    明</td></tr><tr><td valign="top">auth(LOG_AUTH)</td><td valign="top">安全和认证相关消息（不推荐使用authpriv替代）</td></tr><tr><td valign="top">authpriv(LOG_AUTHPRIV)</td><td valign="top">安全和认证相关消息（私有的）</td></tr><tr><td valign="top">cron(LOG_CRON)</td><td valign="top">系统定时任务crond和at产生的日志</td></tr><tr><td valign="top">daemon(LOG_DAEMON)</td><td valign="top">和各个守护进程相关的日志</td></tr><tr><td valign="top">ftp(LOG_FTP)</td><td valign="top">ftp守护进程产生的日志</td></tr><tr><td valign="top">kern(LOG_KERN)</td><td valign="top">内核产生的日志（不是用户进程产生的）</td></tr><tr><td valign="top">local0-local7(LOG_LOCAL0-7)</td><td valign="top">为本地使用预留的服务</td></tr><tr><td valign="top">lpr(LOG_LPR)</td><td valign="top">打印产生的日志</td></tr><tr><td valign="top">mail(LOG_MAIL)</td><td valign="top">邮件收发信息</td></tr><tr><td valign="top">news(LOG_NEWS)</td><td valign="top">与新闻服务器相关的日志</td></tr><tr><td valign="top">syslog(LOG_SYSLOG)</td><td valign="top">由syslogd服务产生的日志信息（虽然服务名称已经改为rsyslogd，但是很多配置都还是沿用了syslogd的，这里并没有修改服务名）</td></tr><tr><td valign="top">user(LOG_USER)</td><td valign="top">用户等级类别的日志信息</td></tr><tr><td valign="top">uucp(LOG_UUCP)</td><td valign="top">uucp子系统的日志信息，uucp是早期Linux系统时行数据的协议，后来也常用在新闻组服务中</td></tr></table><div>     连接符号</div></div><div>     日志服务连接日志等级的格式是：</div><div>日志服务[连接符号]日志等级          日志记录位置</div><div>     在这里连接符号可以识别为：</div><div>     “.”代表只要比后面等级高的（包含该等级）日志都记录下来。比如：“cron.info”代表cron服务产生的日志，只要日志等级大于info级别，就记录。</div><div>     “.=”代表只记录所需等级的日志，其他等级的都不记录。比如：“*.=emerg”代表人和日志服务产生的日志，只要等级是emerg等级记录。这种用法极少见，了解就好</div><div>     “.!”代表不等于，也就是除了该等级的日志外，其他等级的日志都记录。</div><div>     日志等级</div><div><table border="1" cellpadding="2" cellspacing="0" style="width:701px;" width="100%"><tr><td style="text-align: center;width:23.25249643366619%;" valign="top">等级名称</td><td style="text-align: center;width:76.46219686162625%;" valign="top">说     明</td></tr><tr><td valign="top">debug(LOG_DEBUG)</td><td valign="top">一般的调试信息说明</td></tr><tr><td valign="top">info(LOG_INFO)</td><td valign="top">基本的通知信息</td></tr><tr><td valign="top">notice(LOG_NOTICE)</td><td valign="top">普通信息，但是有一定的重要性</td></tr><tr><td valign="top">warning(LOG_WARNING)</td><td valign="top">警告信息，但是还不会影响到服务或系统运行</td></tr><tr><td valign="top">err(LOG_ERR)</td><td valign="top">错误信息，一般达到err等级的信息已经可以影响到服务或系统的运行了</td></tr><tr><td valign="top">crit(LOG_CRIT)</td><td valign="top">临界状况信息，比err等级还要严重</td></tr><tr><td valign="top">alert(LOG_ALERT)</td><td valign="top">警告状态信息，比crit还要严重。必须立即采取行动</td></tr><tr><td valign="top">emerg(LOG_EMERG)</td><td valign="top">疼痛等级信息，系统已经无法使用了</td></tr><tr><td valign="top">*</td><td valign="top">代表所有日志等级，比如：“authpriv.*”代表authpriv认证信息服务产生的日志，所有的日志等级都记录</td></tr></table><div>     日志等级这里还可以识别“none”，如果日志等级是none，就说明忽略这个日志服务，该服务的所有日志都不再记录。</div></div><div>     日志记录位置</div><div>     日志记录位置就是当前日志输出到哪个日志文件中保存，当然也可以把日志输出到打印机打印，或输出到远程日志服务器上（当然日志服务器要允许接收才行）。日志的记录位置也是固定的如下：</div><div>     日志文件的绝对路径。这是最常见的日志保存方法，如“/var/log/secure”就是保存验证和授权信息日志的。</div><div>     系统设备文件。如“/dev/lp0”代表第一台打印机，如果日志保存位置是打印机设备，当有日志时就会在打印机打印。</div><div>     转发给远程主机。因为可以选择使用TCP协议和UDP协议传输日志信息，所以有两种发送格式。如使用“@192.168.0.210:514”，就会把日志内容使用UDP协议发送到192.168.0.210的UDP 514端口上；如果使用“@@192.168.0.210:514”就会把日志内容使用TCP协议发送到192.168.0.210的TCP 514端口上，其中514是日志服务默认端口。当然只要192.168.0.210同意接收此日志，就可以把日志内容保存在日志服务器上。</div><div>     用户名。如“root”，就会把日志发送给root用户，当然root要在线，否则就收不到日志信息了。发送日志给用户时，可以使用“*”代表发送给所有在线用户，如“mail.* *”就会把mail服务产生的所有级别的日志发送给所有在线用户。如果需要把日志发送给多个在线用户，用户名之间用“,”分隔。忽略或丢弃日志。如果接受日志的对象是“~”，代表这个日志不会记录，而直接被丢弃。如“local.* ~”代表忽略local3服务类型所有的日志都不记录。</div><div>  <font color="#DE5700">   2）/etc/rsyslog.conf配置文件的内容</font></div><div>[root@localhost ~]# vi /etc/rsyslog.conf<br/><i><font color="#328712">#查看配置文件内容</font></i></div><div># rsyslog v5 configuration file<br/><br/>
# For more information see /usr/share/doc/rsyslog-*/rsyslog_conf.html<br/>
# If you experience problems, see http://www.rsyslog.com/doc/troubleshoot.html<br/><br/>
#### MODULES ####</div><div><i><font color="#328712">#加载模块</font></i><br/><br/>
$ModLoad imuxsock # provides support for local system logging (e.g. via logger command)</div><div><i><font color="#328712">#加载imuxsock模块，为本地系统登录提供支持</font></i><br/>
$ModLoad imklog   # provides kernel logging support (previously done by rklogd)</div><div><i><font color="#328712">#加载imklog模块，为内核登录提供支持</font></i><br/>
#$ModLoad immark  # provides --MARK-- message capability</div><div><i><font color="#328712">#加载immark模块，提供标记信息的能力</font></i><br/><br/>
# Provides UDP syslog reception<br/>
#$ModLoad imudp<br/>
#$UDPServerRun 514</div><div><i><font color="#328712">#加载UDP模块，允许使用UDP的514端口接收采用UDP协议转发的日志</font></i><br/><br/>
# Provides TCP syslog reception<br/>
#$ModLoad imtcp<br/>
#$InputTCPServerRun 514</div><div><font color="#328712">#<i>加载TCP模块，允许使用TCP的514端口接收采用TCP协议转发的日志</i></font><br/><br/><br/>
#### GLOBAL DIRECTIVES ####</div><div><i><font color="#328712">#定义全局设置</font></i><br/><br/>
# Use default timestamp format<br/>
$ActionFileDefaultTemplate RSYSLOG_TraditionalFileFormat</div><div><i><font color="#328712">#定义日志的时间使用默认的时间戳格式</font></i><br/><br/>
# File syncing capability is disabled by default. This feature is usually not required,<br/>
# not useful and an extreme performance hit<br/>
#$ActionFileEnableSync on</div><div><i><font color="#328712">#文件同步功能。默认没有开启，是注释的</font></i><br/><br/>
# Include all config files in /etc/rsyslog.d/<br/>
$IncludeConfig /etc/rsyslog.d/*.conf</div><div><i><font color="#328712">#包含/etc/rsyslog.d/目录中所有的“.conf”子配置文件。也就是说这个目录中的所有子配置文件也同时生效。</font></i></div><div><br/><br/><br/>
#### RULES ####</div><div><i><font color="#328712">#日志文件保存规则</font></i><br/><br/>
# Log all kernel messages to the console.<br/>
&quot;/etc/rsyslog.conf&quot; 80L, 2875C                                                                                                                                               12,1         顶端<br/><br/>
# Log all kernel messages to the console.<br/>
# Logging much else clutters up the screen.<br/>
#kern.*                                                 /dev/console</div><div><i><font color="#328712">#kern服务.所有日志级别                         保存在/dev/console</font></i></div><div><i><font color="#328712">#这个日志默认没有开启，如果需要，则取消注释</font></i><br/><br/>
# Log anything (except mail) of level info or higher.<br/>
# Don't log private authentication messages!<br/>
*.info;mail.none;authpriv.none;cron.none                /var/log/messages</div><div><i><font color="#328712">#所有服务.info以上级别的日志保存在/var/log/messages日志中。</font></i></div><div><i><font color="#328712">#mail，authpriv，cron的日志不记录在/var/log/messages日志文件中，因为它们都有自己的日志文件。</font></i></div><div><i><font color="#328712">#所以/var/log/messages日志是最重要的系统日志文件，需要经常查看！</font></i><br/><br/>
# The authpriv file has restricted access.<br/>
authpriv.*                                              /var/log/secure</div><div><font color="#328712"><i>#用户认证服务所有级别的日志保存在/var/log/secure日志中</i><br/></font><br/>
# Log all the mail messages in one place.<br/>
mail.*                                                  -/var/log/maillog</div><div><i><font color="#328712">#mail服务的所有级别的日志保存在/var/log/maillog日志中</font></i></div><div><i><font color="#328712">#&quot;-&quot;号的含义是日志先在内存之中保存，当日志够多之后，再向文件中保存<br/></font></i><br/><br/>
# Log cron stuff<br/>
cron.*                                                  /var/log/cron</div><div><i><font color="#328712">#计划任务的所有日志保存在/var/log/cron日志中</font><br/></i><br/>
# Everybody gets emergency messages<br/>
*.emerg                                                 *</div><div><i><font color="#328712">#所有日志服务的疼痛等级日志对所有在线用户广播</font></i><br/><br/>
# Save news errors of level crit and higher in a special file.<br/>
uucp,news.crit                                          /var/log/spooler</div><div><i><font color="#328712">#uucp和news日志服务的crit以上的日志保存在/var/log/spooler日志文件中</font></i><br/><br/>
# Save boot messages also to boot.log<br/>
local7.*                                                /var/log/boot.log</div><div><i><font color="#328712">#local7日志服务的所有日志写入/var/log/boot.log日志中</font></i></div><div><i><font color="#328712">#会把开机时的检测信息在显示到屏幕的同时，写入/var/log/boot.log日志中</font></i><br/><br/><br/>
# ### begin forwarding rule ###</div><div><i><font color="#328712">#定义转发规则</font></i><br/>
# The statement between the begin ... end define a SINGLE forwarding<br/>
# rule. They belong together, do NOT split them. If you create multiple<br/>
# forwarding rules, duplicate the whole block!<br/>
# Remote Logging (we use TCP for reliable delivery)<br/>
#<br/>
# An on-disk queue is created for this action. If the remote host is<br/>
                                                                                                                                                                             <br/>
# ### end of the forwarding rule ###</div><div>     <font color="#DE5700">3）定义自己的日志</font></div><div>[root@localhost ~]# vi /etc/rsyslog.conf</div><div>*.crit                              /var/log/alert.log</div><div><i><font color="#328712">#把所有服务的“临界点”以上的错误都保存在/var/log/alert.log日志中</font></i></div><div>[root@localhost ~]# service rsyslog restart</div><div>关闭系统日志记录器：                                                       [确定]</div><div>启动系统日志记录器：                                                       [确定]</div><div><i><font color="#328712">#重启rsyslog服务</font></i></div><div><i>     </i><font color="#DE5700">4）日志服务器的配置</font></div><div>     如何实现日志服务器的功能，首先需要分清服务端和客户端。假设服务端的服务器IP地址是192.168.0.210，主机名是localhost.localdomain；客户端服务器IP地址是192.168.0.211，主机名www1。现在要做的是把192.168.0.211的日志保存在192.168.0.210这台服务器上。实验过程如下：</div><div><i>#<font color="#328712">服务器端设定192.168.0.210</font></i></div><div>[root@localhost ~]# vi /etc/rsyslog.conf</div><div>......省略部分内容......</div><div># Provides TCP syslog reception<br/>
$ModLoad imtcp<br/>
$InputTCPServerRun 514</div><div><i><font color="#328712">#取消这两名话的注释，允许服务器使用TCP 514端口接收日志</font></i></div><div>......省略部分输出......</div><div>[root@localhost ~]# service rsyslog restart</div><div><font color="#328712">#重启rsyslog日志服务</font></div><div>[root@localhost ~]# netstat -nltu | grep 514</div><div><font color="#328712">#查看514端口已经打开</font></div><div><br/></div><div><font color="#328712">#客户端192.168.0.211</font></div><div>[root@www1 ~]# vi /etc/rsyslog.conf</div><div><font color="#328712">#修改日志服务配置文件</font></div><div>*.*                                                            @@192.168.0.210:514</div><div><font color="#328712">#把所有日志采用TCP协议发送到192.168.0.210的514端口上</font></div><div>[root@www1 ~]# service rsyslog restart</div><div><font color="#328712">#重启日志服务</font></div><div>     这样日志服务器和客户端就搭建完成了，以后192.168.0.211这台客户机上所产生的所有日志都会记录到192.168.0.210上面一份。比如：</div><div><font color="#328712">#在客户机上（192.168.0.211）</font></div><div>[root@www1 ~]# useradd shenchao</div><div>[root@www1 ~]# passwd shenchao</div><div><font color="#328712">#添加shenchao用户（注意提示符的主机名是www1）</font></div><div><br/></div><div><font color="#328712">#在服务器（192.168.0.210）上</font></div><div>[root@localhost ~]# vi /var/log/secure</div><div><font color="#328712">#查看服务器的secure日志</font></div><div>     注意日志服务是通过主机名来区别不同的服务器的所以我们真配置了日志服务，需要给所有的服务器分配不同的主机名。</div><div><b><font color="#DE5700">三、日志轮替</font></b></div><div><font color="#DE5700">1、日志文件的命名规则</font></div><div>     日志轮替的主要作用就是把旧的日志文件移动并改名，同时建立新的空日志文件，当旧日志文件超出保存范围之后，就会时行删除。那么旧的日志文件改名之后如何命名呢，主要依靠/etc/logrotate.conf配置文件中“dateext”参数：</div><div>     如果配置文件中拥有“dateext”参数，那么日志会用日期来作为日志文件的后缀，例如“secure-20130605”。这样的话日志文件名不会重叠，所以也就就需要日志文件的改名，只需要保存指定的日志文件个数，删除多余的日志文件即可。</div><div>     如果配置文件中没有“dateext”参数，那么日志文件就需要进行改名了。当第一次进行日志轮替时，当前的“secure”日志会自动改名为“secure.1”，然后新建“secure”日志，用来保存新日志。当第二次进行日志轮替时，“secure.1”会自动改名为“secure.2”，当前的“secure”日志会自动改名为“secure.1“，然后也会新建”secure“日志，用来保存新的日志，以此类推。</div><div><font color="#DE5700">2、logrotate配置文件</font></div><div>[root@localhost ~]# vi /etc/logrotate.conf</div><div># see &quot;man logrotate&quot; for details<br/>
# rotate log files weekly<br/>
weekly</div><div><i><font color="#328712">#每周对日志文件进行一次轮替</font></i><br/><br/>
# keep 4 weeks worth of backlogs<br/>
rotate 4</div><div><i><font color="#328712">#保存4 个日志文件，也就是说如果时行了5次日志轮替，就会删除第一个备份日志</font></i><br/><br/>
# create new (empty) log files after rotating old ones<br/>
create</div><div><i><font color="#328712">#在日志轮替时，自动创建新的日志文件</font></i><br/><br/>
# use date as a suffix of the rotated file<br/>
dateext</div><div><i><font color="#328712">#使用日期作为日志轮替文件的后缀</font></i><br/><br/>
# uncomment this if you want your log files compressed<br/>
#compress</div><div><i><font color="#328712">#日志文件是否压缩。如果取消注释，则日志会在转储的同时进行压缩</font></i></div><div><br/></div><div><i><font color="#328712">#以上日志配置为默认配置，如果需要轮替的日志没有设定独立参数，那么都会遵守以上参数</font></i></div><div><i><font color="#328712">#如果轮替日志配置了独立参数，那么独立参数优先级更高。</font></i></div><div>--------------------------------------------------------------------------------------- <br/>
# RPM packages drop log rotation information into this directory<br/>
include /etc/logrotate.d</div><div><i><font color="#328712">#包含/etc/logrotate.d/目录中所有的子配置文件。也就是说会把这个目录中所有子配置文件读取进来，进行日志轮替</font></i><br/><br/>
# no packages own wtmp and btmp -- we'll rotate them here</div><div><i><font color="#328712">#以下两个轮替日志有自己的独立参数，如果和默认的参数冲突，则独立参数生效。</font></i><br/>
/var/log/wtmp {</div><div><i><font color="#328712">#以下参数仅对此目录有效</font></i><br/>
    monthly</div><div>     <i><font color="#328712">#每月对日志文件时行一次轮替</font></i><br/>
    create 0664 root utmp</div><div>     <i><font color="#328712">#建立新的日志文件，权限是0644，所有者是root，所属组是utmp组</font></i><br/>
        minsize 1M</div><div>          <i><font color="#328712">#日志文件最小轮替大小是1MB。也就是日志一定要超过1MB都会轮替，否则就算时间达到一个月</font></i></div><div><i><font color="#328712">          #也不进行日志转储</font></i><br/>
    rotate 1</div><div>     <i><font color="#328712">#仅保留一个日志备份。也就是只有wtmp和wtmp.1日志保留而已</font></i><br/>
}<br/><br/>
/var/log/btmp {</div><div><i><font color="#328712">#以下参数只对/var/log/btmp生效</font></i><br/>
    missingok</div><div>     <i><font color="#328712">#如果日志不存在，则忽略该日志的警告信息</font></i></div><div>    monthly<br/>
    create 0600 root utmp<br/>
    rotate 1<br/>
}<br/><br/>
# system-specific logs may be also be configured here.</div><div>     logrotate配置文件的主要参数，如下表：</div><div><table border="1" cellpadding="2" cellspacing="0" style="width:701px;" width="100%"><tr><td style="text-align: center;width:24.10841654778887%;" valign="top">参    数</td><td style="text-align: center;width:75.60627674750357%;" valign="top">参  数  说  明</td></tr><tr><td valign="top">daily</td><td valign="top">日志的轮替周期是每天</td></tr><tr><td valign="top">weekly</td><td valign="top">日志的轮替周期是每周</td></tr><tr><td valign="top">monthly</td><td valign="top">日志的轮替周期是每月</td></tr><tr><td valign="top">rotate 数字</td><td valign="top">保留的日志文件个数。0指没有备份</td></tr><tr><td valign="top">compress</td><td valign="top">日志轮替时，旧的日志进行压缩</td></tr><tr><td valign="top">create mode owner group</td><td valign="top">建立新日志，同时指定新日志的权限与所有者和所属组。如create 0600 root utmp</td></tr><tr><td valign="top">mail address</td><td valign="top">当日志轮替时，输出内容通过邮件发送到指定的邮件地址。如mail shenc@lamp.net</td></tr><tr><td valign="top">missngok</td><td valign="top">如果日志不存在，则忽略该日志的警告信息</td></tr><tr><td valign="top">notifempty</td><td valign="top">如果日志为空文件，则不进行日志轮替</td></tr><tr><td valign="top">minisize 大小</td><td valign="top">日志轮替最小值。也就是日志一定要达这个最小值才会轮替，否则就算时间达到也不轮替</td></tr><tr><td valign="top">size 大小</td><td valign="top">日志只有大小大于指定大小才进行日志轮替，而不是按照时间轮替。如 size 100k</td></tr><tr><td valign="top">dateext</td><td valign="top">使用日期作为日志轮替文件的后缀。如secure-20130605</td></tr><tr><td valign="top">sharedscripts</td><td valign="top">在些关键字之后的脚本只执行一次</td></tr><tr><td valign="top">prerotate/endscript</td><td valign="top">在日志轮替之前执行脚本命令。endscript标示prerotate脚本结束</td></tr><tr><td valign="top">postrotate/endscript</td><td valign="top">在日志轮替之后执行脚本命令。endscript标示postrotat脚本结束</td></tr></table><div>解释下prerotate/endscript和postrotate/endscript这两个参数，例：</div></div><div>     &quot;/var/log/httpd/access.log&quot; /var/log/httpd/error.log {</div><div>          rotate 5</div><div>          <i><font color="#328712">#轮替5次</font></i></div><div>          mail www@my.org</div><div>          <i><font color="#328712">#信息发送到指定邮箱</font></i></div><div>          size 100k</div><div>          <i><font color="#328712">#日志大于100KB时才进行日志轮替，不再按照时间轮替</font></i></div><div>          sharescripts</div><div>          <font color="#328712">#以下脚本只执行一次</font></div><div>          postrotate</div><div>          <i><font color="#328712">#在日志轮替结束之后，执行以下脚本</font></i></div><div>               /usr/bin/kilall -HUP httpd</div><div>               <i><font color="#328712">#平滑重启apache服务</font></i></div><div>          endscript</div><div>          <i><font color="#328712">#脚本结束</font></i></div><div>     }</div><div>     prerotate和postrotate主要用于在日志轮替的同时，执行指定脚本。一般用于日志轮替之后重启服务，不过这里有个典型应用就是给予特定的日志加入chattr的a属性，如果系统文件加入了a属性，那么这个文件就只能增加数据，但是不能删除和修改已有的数据，而且root用户也不例外。所以我们会给重要的日志加入a属性，这样可以保护日志文件不被恶意修改。不过一旦加入了a属性，那么日志轮替时，这个日志文件是不能改名的，当然也就不能进行日志轮替了。所以可以利用prerotate和postrotate来修改日志文件的chattr的a属性。</div><div>3、把自己的日志加入日志轮替</div><div>     这里有两个方法：第一种方法是直接在/etc/logrotate.conf配置文件中写入该日志的轮替策略，从而把日志加入轮替；<font color="#E30000">第二种方法是在/etc/logrotate.d/目录中新建立该日志的轮替文件，在该轮替文件中写入轮替策略</font>，因为该目录中的文件都会被“include”到主配置文件中，所以也中可以把日志加入轮替。我们这里推荐第二种方法，因为系统中需要轮替的日志非常多，如果全都写入/etc/logrotate.conf配置文件，那么这个文件的管理性就会非常差，不利于些文件的维护。</div><div>     举个例子，还记得我们自己生产的/var/log/alert.log日志，这个日志不是系统默认日志，而是我们通过/etc/rsyslog.conf配置文件自己生成的日志，所以默认的这个日志是不会轮替的。那么我们需要将这个日志加入日志轮替的策略，该如何实现。采用第二种方法，也就是在/etc/logrotate.d/目录中建立此日志的轮替文件。具体步骤如下：</div><div>[root@localhost ~]# chattr +a /var/log/alert.log</div><div><i>#先给日志文件赋予chattr的a属性，保证日志安全</i></div><div>[root@localhost ~]# vi /etc/logrotate.d/alter</div><div><i>#创建alter轮替文件，把/var/log/alert.log加入轮替</i></div><div>/var/log/alert.log{</div><div>     weekly                                                                  <i><font color="#328712">#每周轮替一次</font></i></div><div>     rotate 6                                                                <i><font color="#328712">#保留6个日志轮替</font></i></div><div>     sharedscripts                                                        <i><font color="#328712">#以下命令只执行一次</font></i></div><div>     prerotate                                                              <i><font color="#328712">#在日志轮替之前执行</font></i></div><div>          /usr/bin/chattr -a/var/log/alert.log                 <i><font color="#328712">#日志轮替之前取消a属性，以便让日志可以轮替</font></i></div><div>     endscript                                                              <i><font color="#328712">#脚本结束</font></i></div><div>     sharedscripts</div><div>     postrotate                                                            <i><font color="#328712">#在日志轮替之后执行</font></i></div><div>          /usr/bin/chattr +a /var/log/alert.log               <i><font color="#328712">#日志轮替之后，重新加入a属性</font></i></div><div>     endscript</div><div>}</div><div>4、<font color="#DE5700">logrotate命令</font></div><div>     日志轮替之所以可以在指定时间的备份日志，其实也依赖系统定时任务。如果大家记得/etc/cron.daily目录，就会发现这个目录中是有logrotate文件的，查看下这个文件：</div><div>[root@localhost logs]# vi /etc/cron.daily/logrotate<br/>
#!/bin/sh<br/><br/>
/usr/sbin/logrotate /etc/logrotate.conf &gt;/dev/null 2&gt;&amp;1</div><div><i><font color="#328712">#最主要就是执行了logrotate命令</font></i><br/>
EXITVALUE=$?<br/>
if [ $EXITVALUE != 0 ]; then<br/>
    /usr/bin/logger -t logrotate &quot;ALERT exited abnormally with [$EXITVALUE]&quot;<br/>
fi</div><div>exit 0</div><div>     也就是说，每天系统都会执行/etc/cron.daily/logrotate文件，运行这个文件中“/usr/sbin/logrotate /etc/logrotate.conf &gt;/dev/null 2&gt;&amp;1”命令。<font color="#E30000">logrotate命令会依据/etc/logrotate.conf配置文件的配置，来判断配置文件中的日志是否已经符合了日志轮替条件（比如日志备份时间已经满了一周了），如果符合日志轮替条件，日志就会进行转储，所以日志轮替还是由crond服务发起的。daily，weekly，monthly的定时执行时间在/etc/crontab文件中。</font></div><div>    <font color="#DE5700"> logrotate命令的格式：</font></div><div>[root@localhost logs]# logrotate [选项] 配置文件名</div><div>选项：</div><div>     如果此命令没有选项，则会按照配置文件中的条件进行日志轮替</div><div>     -v：显示日志轮替过程。加入了-v选项，会显示日志的轮替的过程</div><div>     -f：强制进行日志轮替。不管日志轮替的条件是否已经符合，强制配置文件中所有的日志进行轮替</div><div>四、日志分析工具</div><div>     在CentOS中，自带一日志分析工具，就是logwatch。这个工具默认是没有安装的，手工安装：</div><div>[root@localhost Packages]# yum -y install logwatch</div><div>     安装完成后，需要手工创建logwatch配置文件，默认配置文件是“/etc/logwatch/conf/logwatch.conf”,不过这个配置文件是空的，需要把模板配置文件复制过来。命令如下：</div><div>[root@localhost ~]# cp /usr/share/logwatch/default.conf/logwatch.conf /etc/logwatch/conf/logwatch.conf                    <i><font color="#328712">#复制配置文件</font></i></div><div>     <font color="#DE5700">这个配置文件中的内容大多是注释，我们注释去掉，那么这个配置文件的内容就如下所示：</font></div><div>[root@localhost ~]# vi /etc/logwatch/conf/logwatch.conf</div><div>LogDir = /var/log                              <i><font color="#328712">#logwatch会分析和统计/var/log中的日志</font></i></div><div>TmpDir = /var/cache/logwatch         <i><font color="#328712">#指定logwatch的临时目录</font></i></div><div>MailTo = root                                    <i><font color="#328712">#日志分析结果，发送邮件给root用</font><font color="#939600">户</font></i></div><div>MailFrom = Logwatch                       <i><font color="#328712">#邮件的发送者是Logwatch，在接收邮件时显示</font></i></div><div>Print =                                              </div><div><i><font color="#328712">#是否打印。如果选择“yes”，日志分析会被打印到标准输出，而且不会发送邮件，</font></i></div><div>#Save = /tmp/logwatch                    </div><div><i><font color="#328712">#如果开启这项，日志分析就不会发送邮件，而是保存在/tmp/logwatch文件中</font></i></div><div>Range = yesterday                            </div><div><i><font color="#328712">#分析哪天的日志。可以识别“ALL”,&quot;Today&quot;,&quot;Yesterday&quot;用来“分析日志”“今天日志”“明天日志”</font></i></div><div>Detail = Low</div><div><i><font color="#328712">#日志的详细程度。可以识别“Low”“Med”“High”。也可以用数字表示，范围“0-10”，0代表最不详细</font></i></div><div><i><font color="#328712">#10代表最详细</font></i></div><div>Service = All</div><div><i><font color="#328712">#分析和监控所有日志</font></i></div><div>Service = &quot;-zz-network&quot;</div><div><font color="#328712"><i>#但是不监控“-zz-network”服务的日志。“-服务名”表示不分析和监控此服务的日</i>志</font></div><div>Service = &quot;-zz-sys&quot;</div><div>Service = &quot;-eximstats&quot;</div><div>     这个配置文件基本不需要修改（实验时，把Range项改为了ALL，否则一会的实验可以分析的日志过少），它就会默认每天执行。logwatch一但安装，就会在/etc/cron.daily/目录中建立“0logwatch”文件，用于第天定时执行logwatch命令，分析和监控相关日志。</div><div>     如果想要这个日志分析马上执行，只需执行logwatch命令即可，命令如下：</div><div>[root@localhost ~]# logwatch</div><div><i><font color="#328712">#马上执行@logwatch日志分析工具</font></i></div><div><br/></div><div><br/></div></div></span>
</div></body></html> 