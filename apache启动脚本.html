<html>
<head>
  <title>apache启动脚本</title>
  <basefont face="宋体" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="YXBJ Windows/600718 (zh-CN, DDL); Windows/10.0.0 (Win64);"/>
  <style>
    body, td {
      font-family: 宋体;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="757"/>
<h1>apache启动脚本</h1>

<div>
<span><div>#!/bin/sh</div><div>### BEGIN INIT INFO</div><div># Provides:          apache2</div><div># Required-Start:    $local_fs $remote_fs $network $syslog $named</div><div># Required-Stop:     $local_fs $remote_fs $network $syslog $named</div><div># Default-Start:     2 3 4 5</div><div># Default-Stop:      0 1 6</div><div># X-Interactive:     true</div><div># Short-Description: Apache2 web server</div><div># Description:       Start the web server and associated helpers</div><div>#  This script will start apache2, and possibly all associated instances.</div><div>#  Moreover, it will set-up temporary directories and helper tools such as</div><div>#  htcacheclean when required by the configuration.</div><div>### END INIT INFO</div><div><br/></div><div>DESC=&quot;web server&quot;</div><div>NAME=apache2</div><div>DAEMON=/usr/sbin/$NAME</div><div><br/></div><div>SCRIPTNAME=&quot;${0##*/}&quot;</div><div>SCRIPTNAME=&quot;${SCRIPTNAME##[KS][0-9][0-9]}&quot;</div><div>if [ -n &quot;$APACHE_CONFDIR&quot; ] ; then</div><div>    if [ &quot;${APACHE_CONFDIR##/etc/apache2-}&quot; != &quot;${APACHE_CONFDIR}&quot; ] ; then</div><div>            DIR_SUFFIX=&quot;${APACHE_CONFDIR##/etc/apache2-}&quot;</div><div>    else</div><div>            DIR_SUFFIX=</div><div>    fi</div><div>elif [ &quot;${SCRIPTNAME##apache2-}&quot; != &quot;$SCRIPTNAME&quot; ] ; then</div><div>    DIR_SUFFIX=&quot;-${SCRIPTNAME##apache2-}&quot;</div><div>    APACHE_CONFDIR=/etc/apache2$DIR_SUFFIX</div><div>else</div><div>    DIR_SUFFIX=</div><div>    APACHE_CONFDIR=/etc/apache2</div><div>fi</div><div>if [ -z &quot;$APACHE_ENVVARS&quot; ] ; then</div><div>    APACHE_ENVVARS=$APACHE_CONFDIR/envvars</div><div>fi</div><div>export APACHE_CONFDIR APACHE_ENVVARS</div><div><br/></div><div>ENV=&quot;env -i LANG=C PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin&quot;</div><div>if [ &quot;$APACHE_CONFDIR&quot; != /etc/apache2 ] ; then</div><div>    ENV=&quot;$ENV APACHE_CONFDIR=$APACHE_CONFDIR&quot;</div><div>fi</div><div>if [ &quot;$APACHE_ENVVARS&quot; != &quot;$APACHE_CONFDIR/envvars&quot; ] ; then</div><div>    ENV=&quot;$ENV APACHE_ENVVARS=$APACHE_ENVVARS&quot;</div><div>fi</div><div><br/></div><div><br/></div><div>#edit /etc/default/apache2 to change this.</div><div>HTCACHECLEAN_RUN=auto</div><div>HTCACHECLEAN_MODE=daemon</div><div>HTCACHECLEAN_SIZE=300M</div><div>HTCACHECLEAN_DAEMON_INTERVAL=120</div><div>HTCACHECLEAN_PATH=/var/cache/apache2$DIR_SUFFIX/mod_cache_disk</div><div>HTCACHECLEAN_OPTIONS=&quot;&quot;</div><div><br/></div><div># Read configuration variable file if it is present</div><div>if [ -f /etc/default/apache2$DIR_SUFFIX ] ; then</div><div>    . /etc/default/apache2$DIR_SUFFIX</div><div>elif [ -f /etc/default/apache2 ] ; then</div><div>    . /etc/default/apache2</div><div>fi</div><div><br/></div><div>PIDFILE=$(. $APACHE_ENVVARS &amp;&amp; echo $APACHE_PID_FILE)</div><div><br/></div><div>VERBOSE=no</div><div>if [ -f /etc/default/rcS ]; then</div><div>    . /etc/default/rcS</div><div>fi</div><div>. /lib/lsb/init-functions</div><div><br/></div><div><br/></div><div># Now, set defaults:</div><div>APACHE2CTL=&quot;$ENV apache2ctl&quot;</div><div>HTCACHECLEAN=&quot;$ENV htcacheclean&quot;</div><div>PIDFILE=$(. $APACHE_ENVVARS &amp;&amp; echo $APACHE_PID_FILE)</div><div>APACHE2_INIT_MESSAGE=&quot;&quot;</div><div><br/></div><div>CONFTEST_OUTFILE=</div><div>cleanup() {</div><div>    if [ -n &quot;$CONFTEST_OUTFILE&quot; ] ; then</div><div>        rm -f &quot;$CONFTEST_OUTFILE&quot;</div><div>    fi</div><div>}</div><div>trap cleanup 0  # &quot;0&quot; means &quot;EXIT&quot;, but &quot;EXIT&quot; is not portable</div><div><br/></div><div><br/></div><div>apache_conftest() {</div><div>    [ -z &quot;$CONFTEST_OUTFILE&quot; ] || rm -f &quot;$CONFTEST_OUTFILE&quot;</div><div>    CONFTEST_OUTFILE=$(mktemp)</div><div>    if ! $APACHE2CTL configtest &gt; &quot;$CONFTEST_OUTFILE&quot; 2&gt;&amp;1 ; then</div><div>        return 1</div><div>    else</div><div>        rm -f &quot;$CONFTEST_OUTFILE&quot;</div><div>        CONFTEST_OUTFILE=</div><div>        return 0</div><div>    fi</div><div>}</div><div><br/></div><div>clear_error_msg() {</div><div>    [ -z &quot;$CONFTEST_OUTFILE&quot; ] || rm -f &quot;$CONFTEST_OUTFILE&quot;</div><div>    CONFTEST_OUTFILE=</div><div>    APACHE2_INIT_MESSAGE=</div><div>}</div><div><br/></div><div>print_error_msg() {</div><div>    [ -z &quot;$APACHE2_INIT_MESSAGE&quot; ] || log_warning_msg &quot;$APACHE2_INIT_MESSAGE&quot;</div><div>    if [ -n &quot;$CONFTEST_OUTFILE&quot; ] ; then</div><div>        echo &quot;Output of config test was:&quot; &gt;&amp;2</div><div>        cat &quot;$CONFTEST_OUTFILE&quot; &gt;&amp;2</div><div>        rm -f &quot;$CONFTEST_OUTFILE&quot;</div><div>        CONFTEST_OUTFILE=</div><div>    fi</div><div>}</div><div><br/></div><div>apache_wait_start() {</div><div>    local STATUS=$1</div><div>    local i=0</div><div><br/></div><div>    if [ $STATUS != 0 ] ; then</div><div>            return $STATUS</div><div>    fi</div><div>    while : ; do</div><div>            PIDTMP=$(pidofproc -p $PIDFILE $DAEMON)</div><div>            if [ -n &quot;${PIDTMP:-}&quot; ] &amp;&amp; kill -0 &quot;${PIDTMP:-}&quot; 2&gt; /dev/null; then</div><div>                    return $STATUS</div><div>            fi</div><div><br/></div><div>            if [ $i = &quot;20&quot; ] ; then</div><div>                    APACHE2_INIT_MESSAGE=&quot;The apache2$DIR_SUFFIX instance did not start within 20 seconds. Please read the log files to discover problems&quot;</div><div>                    return 2</div><div>            fi</div><div><br/></div><div>            [ &quot;$VERBOSE&quot; != no ] &amp;&amp; log_progress_msg &quot;.&quot;</div><div>            sleep 1</div><div>            i=$(($i+1))</div><div>    done</div><div>}</div><div><br/></div><div>apache_wait_stop() {</div><div>    local STATUS=$1</div><div><br/></div><div>    if [ $STATUS != 0 ] ; then</div><div>            return $STATUS</div><div>    fi</div><div><br/></div><div>    PIDTMP=$(pidofproc -p $PIDFILE $DAEMON)</div><div>    if [ -n &quot;${PIDTMP:-}&quot; ] &amp;&amp; kill -0 &quot;${PIDTMP:-}&quot; 2&gt; /dev/null; then</div><div>            local i=0</div><div>            while kill -0 &quot;${PIDTMP:-}&quot; 2&gt; /dev/null;  do</div><div>                    if [ $i = '60' ]; then</div><div>                            break</div><div>                            STATUS=2</div><div>                    fi</div><div>                    [ &quot;$VERBOSE&quot; != no ] &amp;&amp; log_progress_msg &quot;.&quot;</div><div>                    sleep 1</div><div>                    i=$(($i+1))</div><div>            done</div><div>            return $STATUS</div><div>    else</div><div>        return $STATUS</div><div>    fi</div><div>}</div><div><br/></div><div><br/></div><div>#</div><div># Function that starts the daemon/service</div><div>#</div><div>do_start()</div><div>{</div><div>    # Return</div><div>    #   0 if daemon has been started</div><div>    #   1 if daemon was already running</div><div>    #   2 if daemon could not be started</div><div><br/></div><div>    if pidofproc -p $PIDFILE &quot;$DAEMON&quot; &gt; /dev/null 2&gt;&amp;1 ; then</div><div>            return 1</div><div>    fi</div><div><br/></div><div>    if apache_conftest ; then</div><div>            $APACHE2CTL start</div><div>            apache_wait_start $?</div><div>            return $?</div><div>    else</div><div>            APACHE2_INIT_MESSAGE=&quot;The apache2$DIR_SUFFIX configtest failed.&quot;</div><div>            return 2</div><div>    fi</div><div>}</div><div><br/></div><div>#</div><div># Function that stops the daemon/service</div><div>#</div><div>do_stop()</div><div>{</div><div>    # Return</div><div>    #   0 if daemon has been stopped</div><div>    #   1 if daemon was already stopped</div><div>    #   2 if daemon could not be stopped</div><div>    #   other if a failure occurred</div><div><br/></div><div>    # either &quot;stop&quot; or &quot;graceful-stop&quot;</div><div>    local STOP=$1</div><div>    # can't use pidofproc from LSB here</div><div>    local AP_RET=0</div><div><br/></div><div>    if pidof $DAEMON &gt; /dev/null 2&gt;&amp;1 ; then</div><div>            if [ -e $PIDFILE ] &amp;&amp; pidof $DAEMON | tr ' ' '\n' | grep -w $(cat $PIDFILE) &gt; /dev/null 2&gt;&amp;1 ; then</div><div>                    AP_RET=2</div><div>            else</div><div>                    AP_RET=1</div><div>            fi</div><div>    else</div><div>        AP_RET=0</div><div>    fi</div><div><br/></div><div>    # AP_RET is:</div><div>    # 0 if Apache (whichever) is not running</div><div>    # 1 if Apache (whichever) is running</div><div>    # 2 if Apache from the PIDFILE is running</div><div><br/></div><div>    if [ $AP_RET = 0 ] ; then</div><div>            return 1</div><div>    fi</div><div><br/></div><div>    if [ $AP_RET = 2 ] &amp;&amp; apache_conftest ; then</div><div>            $APACHE2CTL $STOP &gt; /dev/null 2&gt;&amp;1</div><div>            apache_wait_stop $?</div><div>            return $?</div><div>    else</div><div>            if [ $AP_RET = 2 ]; then</div><div>                    clear_error_msg</div><div>                    APACHE2_INIT_MESSAGE=&quot;The apache2$DIR_SUFFIX configtest failed, so we are trying to kill it manually. This is almost certainly suboptimal, so please make sure your system is working as you'd expect now!&quot;</div><div>                    killproc -p $PIDFILE $DAEMON</div><div>                    apache_wait_stop $?</div><div>                    return $?</div><div>            elif [ $AP_RET = 1 ] ; then</div><div>                    APACHE2_INIT_MESSAGE=&quot;There are processes named 'apache2' running which do not match your pid file which are left untouched in the name of safety, Please review the situation by hand&quot;.</div><div>                    return 2</div><div>            fi</div><div>    fi</div><div><br/></div><div>}</div><div><br/></div><div><br/></div><div>#</div><div># Function that sends a SIGHUP to the daemon/service</div><div>#</div><div>do_reload() {</div><div>    if apache_conftest; then</div><div>            if ! pidofproc -p $PIDFILE &quot;$DAEMON&quot; &gt; /dev/null 2&gt;&amp;1 ; then</div><div>                    APACHE2_INIT_MESSAGE=&quot;Apache2 is not running&quot;</div><div>                    return 2</div><div>            fi</div><div>            $APACHE2CTL graceful &gt; /dev/null 2&gt;&amp;1</div><div>            return $?</div><div>    else</div><div>            APACHE2_INIT_MESSAGE=&quot;The apache2$DIR_SUFFIX configtest failed. Not doing anything.&quot;</div><div>            return 2</div><div>    fi</div><div>}</div><div><br/></div><div><br/></div><div>check_htcacheclean() {</div><div>    [ &quot;$HTCACHECLEAN_MODE&quot; = &quot;daemon&quot; ] || return 1</div><div>    [ &quot;$HTCACHECLEAN_RUN&quot;  = &quot;yes&quot;    ] &amp;&amp; return 0</div><div><br/></div><div>    MODSDIR=$(. $APACHE_ENVVARS &amp;&amp; echo $APACHE_MODS_ENABLED)</div><div>            [ &quot;$HTCACHECLEAN_RUN&quot;  = &quot;auto&quot; \</div><div>                    -a -e ${MODSDIR:-$APACHE_CONFDIR/mods-enabled}/cache_disk.load ] &amp;&amp; \</div><div>                    return 0</div><div>    return 1</div><div>}</div><div><br/></div><div>start_htcacheclean() {</div><div>       $HTCACHECLEAN $HTCACHECLEAN_OPTIONS -d$HTCACHECLEAN_DAEMON_INTERVAL \</div><div>            -i -p$HTCACHECLEAN_PATH -l$HTCACHECLEAN_SIZE</div><div>}</div><div><br/></div><div>stop_htcacheclean() {</div><div>    pkill -P 1 -f &quot;htcacheclean.* -p$HTCACHECLEAN_PATH &quot; 2&gt; /dev/null || return 1</div><div>}</div><div><br/></div><div><br/></div><div># Sanity checks. They need to occur after function declarations</div><div>[ -x $DAEMON ] || exit 0</div><div><br/></div><div>if [ ! -x $DAEMON ] ; then</div><div>    echo &quot;No apache-bin package installed&quot;</div><div>    exit 0</div><div>fi</div><div><br/></div><div>if [ -z &quot;$PIDFILE&quot; ] ; then</div><div>    echo ERROR: APACHE_PID_FILE needs to be defined in $APACHE_ENVVARS &gt;&amp;2</div><div>    exit 2</div><div>fi</div><div><br/></div><div>if check_htcacheclean ; then</div><div>    if [ ! -d &quot;$HTCACHECLEAN_PATH&quot; ] ; then</div><div>            echo &quot;htcacheclean is configured, but directory $HTCACHECLEAN_PATH does not exist!&quot; &gt;&amp;2</div><div>            exit 2</div><div>    fi</div><div>fi</div><div><br/></div><div><br/></div><div><br/></div><div>case &quot;$1&quot; in</div><div>  start)</div><div>    log_daemon_msg &quot;Starting $DESC&quot; &quot;$NAME&quot;</div><div>    do_start</div><div>    RET_STATUS=$?</div><div>    case &quot;$RET_STATUS&quot; in</div><div>        0|1)</div><div>            log_success_msg</div><div>            [ &quot;$VERBOSE&quot; != no ] &amp;&amp; [ $RET_STATUS = 1 ] &amp;&amp; log_warning_msg &quot;Server was already running&quot;</div><div>            if check_htcacheclean ; then</div><div>                [ &quot;$VERBOSE&quot; != no ] &amp;&amp; log_daemon_msg &quot;Starting HTTP cache cleaning daemon&quot; &quot;htcacheclean&quot;</div><div>                start_htcacheclean</div><div>                [ &quot;$VERBOSE&quot; != no ] &amp;&amp; log_end_msg $?</div><div>            fi</div><div>            ;;</div><div>        2)</div><div>            log_failure_msg</div><div>            print_error_msg</div><div>            exit 1</div><div>            ;;</div><div>    esac</div><div>    ;;</div><div>  stop|graceful-stop)</div><div>    log_daemon_msg &quot;Stopping $DESC&quot; &quot;$NAME&quot;</div><div>    do_stop &quot;$1&quot;</div><div>    RET_STATUS=$?</div><div>    case &quot;$RET_STATUS&quot; in</div><div>        0|1)</div><div>            log_success_msg</div><div>            [ &quot;$VERBOSE&quot; != no ] &amp;&amp; [ $RET_STATUS = 1 ] &amp;&amp; log_warning_msg &quot;Server was not running&quot;</div><div>            ;;</div><div>        2)</div><div>            log_failure_msg</div><div>            print_error_msg</div><div>            exit 1</div><div>            ;;</div><div>    esac</div><div>    print_error_msg</div><div><br/></div><div>    if check_htcacheclean ; then</div><div>        [ &quot;$VERBOSE&quot; != no ] &amp;&amp; log_daemon_msg &quot;Stopping HTTP cache cleaning daemon&quot; &quot;htcacheclean&quot;</div><div>        stop_htcacheclean</div><div>        [ &quot;$VERBOSE&quot; != no ] &amp;&amp; log_end_msg $?</div><div>    fi</div><div><br/></div><div>    ;;</div><div>  status)</div><div>    status_of_proc -p $PIDFILE &quot;apache2&quot; &quot;$NAME&quot;</div><div>    exit $?</div><div>    ;;</div><div>  reload|force-reload|graceful)</div><div>    log_daemon_msg &quot;Reloading $DESC&quot; &quot;$NAME&quot;</div><div>    do_reload</div><div>    RET_STATUS=$?</div><div>    case &quot;$RET_STATUS&quot; in</div><div>        0|1)</div><div>            log_success_msg</div><div>            [ &quot;$VERBOSE&quot; != no ] &amp;&amp; [ $RET_STATUS = 1 ] &amp;&amp; log_warning_msg &quot;Server was already running&quot;</div><div>            ;;</div><div>        2)</div><div>            log_failure_msg</div><div>            print_error_msg</div><div>            exit 1</div><div>            ;;</div><div>    esac</div><div>    print_error_msg</div><div>    ;;</div><div>  restart)</div><div>    log_daemon_msg &quot;Restarting $DESC&quot; &quot;$NAME&quot;</div><div>    do_stop stop</div><div>    case &quot;$?&quot; in</div><div>        0|1)</div><div>            do_start</div><div>            case &quot;$?&quot; in</div><div>                0)</div><div>                    log_end_msg 0</div><div>                    ;;</div><div>                1|*)</div><div>                    log_end_msg 1 # Old process is still or failed to running</div><div>                    print_error_msg</div><div>                    exit 1</div><div>                    ;;</div><div>            esac</div><div>            ;;</div><div>        *)</div><div>            # Failed to stop</div><div>            log_end_msg 1</div><div>            print_error_msg</div><div>            exit 1</div><div>            ;;</div><div>    esac</div><div>    ;;</div><div>  start-htcacheclean)</div><div>    log_daemon_msg &quot;Starting htcacheclean&quot;</div><div>    start_htcacheclean</div><div>    log_end_msg $?</div><div>    exit $?</div><div>    ;;</div><div>  stop-htcacheclean)</div><div>    log_daemon_msg &quot;Stopping htcacheclean&quot;</div><div>    stop_htcacheclean</div><div>    log_end_msg $?</div><div>    exit $?</div><div>    ;;</div><div>  *)</div><div>    echo &quot;Usage: $SCRIPTNAME {start|stop|graceful-stop|restart|reload|force-reload|start-htcacheclean|stop-htcacheclean}&quot; &gt;&amp;2</div><div>    exit 3</div><div>    ;;</div><div>esac</div><div><br/></div><div>exit 0</div><div><br/></div><div># vim: syntax=sh ts=4 sw=4 sts=4 sr noet</div></span>
</div></body></html> 