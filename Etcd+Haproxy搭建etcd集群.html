<html>
<head>
  <title>Etcd+Haproxy搭建etcd集群</title>
  <basefont face="宋体" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="YXBJ Windows/600718 (zh-CN, DDL); Windows/10.0.0 (Win64);"/>
  <style>
    body, td {
      font-family: 宋体;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="1275"/>
<h1>Etcd+Haproxy搭建etcd集群</h1>

<div>
<span><div><div align="center" style="min-height: 21pt;"><font color="#010101" face="宋体" size="4"><span style="font-size:16pt"><b>Etcd+Haproxy搭建etcd集群</b></span></font></div><ol style="margin-top: 0mm; margin-bottom: 0mm; margin-left: 0mm; padding-left: 0pt;"><li style="margin-left: 15pt; margin-right: 0pt; padding-left: -18pt; text-indent:0pt; font-family: ����; font-size: 10pt; color: #010101;"><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt; font-family:����; color:#010101; font-weight:Normal; font-style:Normal; font-decoration:Normal">环境要求：至少需要三台服务器。</span></font></div></li></ol><div align="justify" style="margin-left:0mm; margin-right:0mm; text-indent:7mm; margin-top:0.00mm; margin-bottom:0.00mm;min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">etcd0:172.16.10.130 2379</span></font></div><div align="justify" style="margin-left:0mm; margin-right:0mm; text-indent:7mm; margin-top:0.00mm; margin-bottom:0.00mm;min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">etcd1:172.16.10.132 2379</span></font></div><div align="justify" style="margin-left:0mm; margin-right:0mm; text-indent:7mm; margin-top:0.00mm; margin-bottom:0.00mm;min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">etcd2:172.16.10.133 2379</span></font></div><div align="justify" style="margin-left:0mm; margin-right:0mm; text-indent:7mm; margin-top:0.00mm; margin-bottom:0.00mm;min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">haproxy:172.16.10.132 1985</span></font></div><ol start="2" style="margin-top: 0mm; margin-bottom: 0mm; margin-left: 0mm; padding-left: 0pt;"><li style="margin-left: 15pt; margin-right: 0pt; padding-left: -18pt; text-indent:0pt; font-family: ����; font-size: 10pt; color: #010101;"><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt; font-family:����; color:#010101; font-weight:Normal; font-style:Normal; font-decoration:Normal">应用安装及修改配置</span></font></div></li></ol><div align="justify" style="margin-left:0mm; margin-right:0mm; text-indent:7mm; margin-top:0.00mm; margin-bottom:0.00mm;min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">安装haproxy：# yum install haproxy -y</span></font></div><div align="justify" style="margin-left:0mm; margin-right:0mm; text-indent:7mm; margin-top:0.00mm; margin-bottom:0.00mm;min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">修改配置：# vim /etc/haproxy/haproxy.cfg     ##备份配置再修改</span></font></div><div align="justify" style="margin-left:0mm; margin-right:0mm; text-indent:7mm; margin-top:0.00mm; margin-bottom:0.00mm;min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">...........................</span></font></div><div align="justify" style="margin-left:0mm; margin-right:0mm; text-indent:7mm; margin-top:0.00mm; margin-bottom:0.00mm;min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">..........................                 ####前面部分省略，不需要更改</span></font></div><div align="justify" style="margin-left:0mm; margin-right:0mm; text-indent:7mm; margin-top:0.00mm; margin-bottom:0.00mm;min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">    timeout connect         10s</span></font></div><div align="justify" style="margin-left:0mm; margin-right:0mm; text-indent:7mm; margin-top:0.00mm; margin-bottom:0.00mm;min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">    timeout client          1m</span></font></div><div align="justify" style="margin-left:0mm; margin-right:0mm; text-indent:7mm; margin-top:0.00mm; margin-bottom:0.00mm;min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">    timeout server          1m</span></font></div><div align="justify" style="margin-left:0mm; margin-right:0mm; text-indent:7mm; margin-top:0.00mm; margin-bottom:0.00mm;min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">    timeout http-keep-alive 10s</span></font></div><div align="justify" style="margin-left:0mm; margin-right:0mm; text-indent:7mm; margin-top:0.00mm; margin-bottom:0.00mm;min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">    timeout check           10s</span></font></div><div align="justify" style="margin-left:0mm; margin-right:0mm; text-indent:7mm; margin-top:0.00mm; margin-bottom:0.00mm;min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">    maxconn                 3000</span></font></div><div align="justify" style="margin-left:0mm; margin-right:0mm; text-indent:7mm; margin-top:0.00mm; margin-bottom:0.00mm;min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">##########add by lcq###############</span></font></div><div align="justify" style="margin-left:0mm; margin-right:0mm; text-indent:7mm; margin-top:0.00mm; margin-bottom:0.00mm;min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">listen stats_1985</span></font></div><div align="justify" style="margin-left:0mm; margin-right:0mm; text-indent:7mm; margin-top:0.00mm; margin-bottom:0.00mm;min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">#frontend secure #自定义一个frontend，也可以放在listen或者backend中</span></font></div><div align="justify" style="margin-left:0mm; margin-right:0mm; text-indent:7mm; margin-top:0.00mm; margin-bottom:0.00mm;min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">bind 0.0.0.0:1985 #监听的ip端口号</span></font></div><div align="justify" style="margin-left:0mm; margin-right:0mm; text-indent:7mm; margin-top:0.00mm; margin-bottom:0.00mm;min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">stats enable #开关</span></font></div><div align="justify" style="margin-left:0mm; margin-right:0mm; text-indent:7mm; margin-top:0.00mm; margin-bottom:0.00mm;min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">stats uri /admin?admin #访问的uri ip:8888/admin?admin</span></font></div><div align="justify" style="margin-left:0mm; margin-right:0mm; text-indent:7mm; margin-top:0.00mm; margin-bottom:0.00mm;min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">stats auth admin:admin #认证用户名和密码</span></font></div><div align="justify" style="margin-left:0mm; margin-right:0mm; text-indent:7mm; margin-top:0.00mm; margin-bottom:0.00mm;min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">stats hide-version #隐藏HAProxy的版本号</span></font></div><div align="justify" style="margin-left:0mm; margin-right:0mm; text-indent:7mm; margin-top:0.00mm; margin-bottom:0.00mm;min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">stats admin if TRUE #管理界面，如果认证成功了，可通过webui管理节点</span></font></div><div align="justify" style="margin-left:0mm; margin-right:0mm; text-indent:7mm; margin-top:0.00mm; margin-bottom:0.00mm;min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">stats refresh 30s ##统计页面自动刷新时间</span></font></div><div align="justify" style="margin-left:0mm; margin-right:0mm; text-indent:7mm; margin-top:0.00mm; margin-bottom:0.00mm;min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">listen test1</span></font></div><div align="justify" style="margin-left:0mm; margin-right:0mm; text-indent:7mm; margin-top:0.00mm; margin-bottom:0.00mm;min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">bind 0.0.0.0:2378</span></font></div><div align="justify" style="margin-left:0mm; margin-right:0mm; text-indent:7mm; margin-top:0.00mm; margin-bottom:0.00mm;min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">mode tcp</span></font></div><div align="justify" style="margin-left:0mm; margin-right:0mm; text-indent:7mm; margin-top:0.00mm; margin-bottom:0.00mm;min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">option tcplog #日志类别,采用tcplog</span></font></div><div align="justify" style="margin-left:0mm; margin-right:0mm; text-indent:7mm; margin-top:0.00mm; margin-bottom:0.00mm;min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">maxconn 4086</span></font></div><div align="justify" style="margin-left:0mm; margin-right:0mm; text-indent:7mm; margin-top:0.00mm; margin-bottom:0.00mm;min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">#配置负载及状态检测</span></font></div><div align="justify" style="margin-left:0mm; margin-right:0mm; text-indent:7mm; margin-top:0.00mm; margin-bottom:0.00mm;min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">server s0 172.16.10.130:2379 weight 1 check inter 2000 rise 2 fall 5</span></font></div><div align="justify" style="margin-left:0mm; margin-right:0mm; text-indent:7mm; margin-top:0.00mm; margin-bottom:0.00mm;min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">server s1 172.16.10.132:2379 weight 1 check inter 2000 rise 2 fall 5</span></font></div><div align="justify" style="margin-left:0mm; margin-right:0mm; text-indent:7mm; margin-top:0.00mm; margin-bottom:0.00mm;min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">server s2 172.16.10.133:2379 weight 1 check inter 2000 rise 2 fall 5</span></font></div><div align="justify" style="margin-left:0mm; margin-right:0mm; text-indent:7mm; margin-top:0.00mm; margin-bottom:0.00mm;min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">etcd安装路径：/home/cec/etcd-v2.3.4-linux-amd64</span></font></div><div align="justify" style="margin-left:15mm; margin-right:0mm; text-indent:7mm; margin-top:0.00mm; margin-bottom:0.00mm;min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">  /home/cec/apache-tomcat-7.0.70-ETCD</span></font></div><div align="justify" style="margin-left:0mm; margin-right:0mm; text-indent:7mm; margin-top:0.00mm; margin-bottom:0.00mm;min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">修改配置文件：</span></font></div><div align="justify" style="margin-left:0mm; margin-right:0mm; text-indent:7mm; margin-top:0.00mm; margin-bottom:0.00mm;min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt"># vim ./apache-tomcat-7.0.70-ETCD/webapps/ROOT/WEB-INF/classes/sysconfig.properties</span></font></div><div align="justify" style="margin-left:7mm; margin-right:0mm; text-indent:7mm; margin-top:0.00mm; margin-bottom:0.00mm;min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt"><b>etcd.address=http://172.16.10.132:2378</b></span></font></div><ol start="3" style="margin-top: 0mm; margin-bottom: 0mm; margin-left: 0mm; padding-left: 0pt;"><li style="margin-left: 15pt; margin-right: 0pt; padding-left: -18pt; text-indent:0pt; font-family: ����; font-size: 10pt; color: #010101;"><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt; font-family:����; color:#010101; font-weight:Normal; font-style:Normal; font-decoration:Normal">启动</span></font></div></li></ol><div align="justify" style="margin-left:0mm; margin-right:0mm; text-indent:7mm; margin-top:0.00mm; margin-bottom:0.00mm;min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">haproxy：# /etc/init.d/haproxy start</span></font></div><div align="justify" style="min-height: 39pt;"><img src="Etcd+Haproxy搭建etcd集群_files/Image.png" type="image/png" data-filename="Image.png" alt="graphic" border="0" height="52" width="555"/></div><div align="justify" style="margin-left:0mm; margin-right:0mm; text-indent:7mm; margin-top:0.00mm; margin-bottom:0.00mm;min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">配置中心web：# cd apache-tomcat-7.0.70-ETCD/bin &amp;&amp; ./start.sh</span></font></div><div align="justify" style="margin-left:0mm; margin-right:0mm; text-indent:7mm; margin-top:0.00mm; margin-bottom:0.00mm;min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">etcd：使用脚本启动，脚本在etcd-v2.3.4-linux-amd64/目录下</span></font></div><div align="justify" style="margin-left:0mm; margin-right:0mm; text-indent:7mm; margin-top:0.00mm; margin-bottom:0.00mm;min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">#</span> <span style="font-size:10pt"><b>./etcd_start.sh etcd0:172.16.10.130 etcd1:172.16.10.132 etcd2:172.16.10.133</b></span></font></div><div align="justify" style="min-height: 32pt;"><img src="Etcd+Haproxy搭建etcd集群_files/Image [1].png" type="image/png" data-filename="Image.png" alt="graphic" border="0" height="43" width="554"/></div><ol start="4" style="margin-top: 0mm; margin-bottom: 0mm; margin-left: 0mm; padding-left: 0pt;"><li style="margin-left: 15pt; margin-right: 0pt; padding-left: -18pt; text-indent:0pt; font-family: ����; font-size: 10pt; color: #010101;"><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt; font-family:����; color:#010101; font-weight:Normal; font-style:Normal; font-decoration:Normal">集群状态检测</span></font></div></li></ol><div align="justify" style="margin-left:0mm; margin-right:0mm; text-indent:7mm; margin-top:0.00mm; margin-bottom:0.00mm;min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">haproxy状态页面：</span></font><a href="http://172.16.10.132:1985/admin?admin"><font color="#0000FF" face="Calibri" size="2"><span style="font-size:10pt"><u>http://172.16.10.132:1985/admin?admin</u></span></font></a><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">     admin/admin</span></font></div><div align="justify" style="min-height: 180pt;"><img src="Etcd+Haproxy搭建etcd集群_files/Image [2].png" type="image/png" data-filename="Image.png" alt="graphic" border="0" height="241" width="552"/></div><div align="justify" style="margin-left:0mm; margin-right:0mm; text-indent:7mm; margin-top:0.00mm; margin-bottom:0.00mm;min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">etcd_keys：</span></font><a href="http://172.16.10.132:2378/v2/keys"><font color="#0000FF" face="Calibri" size="2"><span style="font-size:10pt"><u>http://172.16.10.132:2378/v2/keys</u></span></font></a></div><div align="justify" style="min-height: 46pt;"><img src="Etcd+Haproxy搭建etcd集群_files/Image [3].png" type="image/png" data-filename="Image.png" alt="graphic" border="0" height="62" width="552"/></div><div align="justify" style="margin-left:0mm; margin-right:0mm; text-indent:7mm; margin-top:0.00mm; margin-bottom:0.00mm;min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">etcd_members：</span></font><a href="http://172.16.10.132:2378/v2/keys"><font color="#0000FF" face="Calibri" size="2"><span style="font-size:10pt"><u>http://172.16.10.132:2378/v2/members</u></span></font></a></div><ol start="5" style="margin-top: 0mm; margin-bottom: 0mm; margin-left: 0mm; padding-left: 0pt;"><li style="margin-left: 15pt; margin-right: 0pt; padding-left: -18pt; text-indent:0pt; font-family: ����; font-size: 10pt; color: #010101;"><div align="justify" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt; font-family:����; color:#010101; font-weight:Normal; font-style:Normal; font-decoration:Normal">集群故障检测</span></font></div></li></ol><div align="justify" style="margin-left:0mm; margin-right:0mm; text-indent:7mm; margin-top:0.00mm; margin-bottom:0.00mm;min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">5.1 单点故障：手动停止一个etcd服务，测试配置中心注册新节点情况，测试应用可用性情况，测试故障节点恢复后数据同步情况。如下：停10.130的etcd服务。在配置中心注册新节点/123/test成功，并且在活动的etcd上看到数据，应用运行正常。</span></font></div><div align="left" style="min-height: 48pt;"><img src="Etcd+Haproxy搭建etcd集群_files/Image [4].png" type="image/png" data-filename="Image.png" alt="graphic" border="0" height="64" width="551"/></div><div align="left" style="margin-left:0mm; margin-right:0mm; text-indent:7mm; margin-top:0.00mm; margin-bottom:0.00mm;min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">重新启动10.130上的etcd，看到数据有同步。</span></font></div><div align="left" style="min-height: 50pt;"><img src="Etcd+Haproxy搭建etcd集群_files/Image [5].png" type="image/png" data-filename="Image.png" alt="graphic" border="0" height="67" width="551"/></div><div align="left" style="margin-left:0mm; margin-right:0mm; text-indent:7mm; margin-top:0.00mm; margin-bottom:0.00mm;min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">5.2 多点故障：停止10.132和10.133上的etcd，haproxy状态页面看到仅有s0存活，测试发现不能注册新节点。</span></font></div><div align="justify" style="min-height: 159pt;"><img src="Etcd+Haproxy搭建etcd集群_files/Image [6].png" type="image/png" data-filename="Image.png" alt="graphic" border="0" height="212" width="338"/></div><div align="justify" style="margin-left:0mm; margin-right:0mm; text-indent:7mm; margin-top:0.00mm; margin-bottom:0.00mm;min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">测试应用，正常运行。此时etcd集群为可读不可写状态，应用可以读取数据，但是不能写入新数据。</span></font></div><div align="justify" style="margin-left:0mm; margin-right:0mm; text-indent:7mm; margin-top:0.00mm; margin-bottom:0.00mm;min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">重新启动故障的两台etcd，集群功能恢复正常。</span></font></div></div></span>
</div></body></html> 