<html>
<head>
  <title>jvm系列(十一):Java 8-从持久代到metaspace</title>
  <basefont face="宋体" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="YXBJ Windows/600718 (zh-CN, DDL); Windows/10.0.0 (Win64);"/>
  <style>
    body, td {
      font-family: 宋体;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="1021"/>
<h1>jvm系列(十一):Java 8-从持久代到metaspace</h1>

<div>
<span><div style="text-size-adjust: 100%; -webkit-appearance: none; -webkit-tap-highlight-color: rgba(0, 0, 0, 0);"><div style="background-color: rgb(255, 255, 255); letter-spacing: 0.034em; font-size: initial; -webkit-appearance: none; -webkit-tap-highlight-color: rgba(0, 0, 0, 0);"><div style="overflow-wrap:break-word;"><div style="background-color:rgb(255, 255, 255);"><h2 style="font-size: 22px; margin: 0px 0px 14px; padding: 0px;"><span style="font-size: 16px; display: inline-block; min-width: 100%;"><span style="font-size: 22px; line-height: 1.4; color: rgb(51, 51, 51); font-family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-weight: 400;">jvm系列(十一):Java 8-从持久代到metaspace</span></span></h2><div style="margin: 0px 0px 22px; padding: 0px; font-size: 0px; overflow-wrap: break-word; word-break: break-all; position: relative; z-index: 1;"><span style="margin: 0px 10px 10px 0px; padding: 0px; display: inline-block; vertical-align: middle; font-size: 15px; -webkit-tap-highlight-color: rgba(0, 0, 0, 0); line-height: 20px; color: rgba(0, 0, 0, 0.3); font-family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;">译者 梅小西</span> <a href="http://loadhtml/#" style="margin: 0px; padding: 0px; -webkit-tap-highlight-color: rgba(0, 0, 0, 0); font-size: 15px; line-height: 20px; font-family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; color: rgb(87, 107, 149); text-decoration: none;">纯洁的微笑</a> <span style="font-size: 15px; line-height: 20px; color: rgba(0, 0, 0, 0.3); font-family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-style: normal; margin: 0px 10px 10px 0px; padding: 0px; display: inline-block; vertical-align: middle; -webkit-tap-highlight-color: rgba(0, 0, 0, 0);">2017-10-18</span></div><div style="margin: 0px; padding: 0px; overflow: hidden; font-size: 17px; overflow-wrap: break-word; text-align: justify; position: relative; z-index: 0;"><blockquote style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;padding-left:10px;border-left:3px solid rgb(219, 219, 219);"><div style="margin: 0px 0px 1.1em; padding: 0px; max-width: 100%; box-sizing: border-box; overflow-wrap: break-word; clear: both; min-height: 1em;"><span style="font-size: 17px; line-height: 1.6; color: rgb(63, 63, 63); font-family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;">译者 梅小西，原文出处：http://blog.csdn.net/wang8118/article/details/45765869</span></div></blockquote><div style="margin: 0px 0px 1.1em; padding: 0px; max-width: 100%; box-sizing: border-box; overflow-wrap: break-word; clear: both; min-height: 1em;"><span style="font-size: 17px; line-height: 1.6; color: rgb(63, 63, 63); font-family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;">Java 8介绍了一些新语言以及运行时新特点。其中一个特点便是完全移除了持久代(PermGen)，自从Oracle公司发布了JDK1.7后就已经宣布了这个决定。还有比如内部字符串，从JDK1.7开始就从持久代移除了，JDK8的发布彻底废除了它。在这个部分，我们会讨论持久代的继任者：Metaspace。</span></div><div style="margin: 0px 0px 1.1em; padding: 0px; max-width: 100%; box-sizing: border-box; overflow-wrap: break-word; clear: both; min-height: 1em;"><span style="font-size: 17px; line-height: 1.6; color: rgb(63, 63, 63); font-family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;">当执行一个Java程序并出现了“泄露”类元数据对象时我们会比较HotSpot 1.7和HotSpot 1.8的运行时行为的不同点。</span></div><div style="margin: 0px 0px 1.1em; padding: 0px; max-width: 100%; box-sizing: border-box; overflow-wrap: break-word; clear: both; min-height: 1em;"><strong style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;"><span style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box; overflow-wrap: break-word; font-size: 16px; line-height: 1.6; color: rgb(63, 63, 63); font-family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-weight: bold;">Metaspace</span><span style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box; overflow-wrap: break-word; font-size: 16px; line-height: 1.6; color: rgb(63, 63, 63); font-family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-weight: bold;">:一个新的内存空间诞生了</span></strong></div><div style="margin: 0px 0px 1.1em; padding: 0px; max-width: 100%; box-sizing: border-box; overflow-wrap: break-word; clear: both; min-height: 1em;"><span style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box; overflow-wrap: break-word; font-size: 16px; line-height: 1.6; color: rgb(63, 63, 63); font-family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;">JDK8 HotSpot JVM现在使用了本地内存来存储类元数据，被称为Metaspace，和Oracle JRockit以及IBM JVM类似。</span></div><div style="margin: 0px 0px 1.1em; padding: 0px; max-width: 100%; box-sizing: border-box; overflow-wrap: break-word; clear: both; min-height: 1em;"><span style="font-size: 17px; line-height: 1.6; color: rgb(63, 63, 63); font-family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;">好消息是它意味着java.lang.OutOfMemoryError：PermGen space问题会越来越少，也不再需要你去调整和监控内存空间。然而这种变化默认是可不见的，接下来我们给你展示的，是你仍然需要关注类元数据内存占用。请记住，这些新特点并不会很神奇的消除类和类加载器的内存泄露。你需要使用不同的方法和学习新的命名约定来找出问题的根源。</span></div><div style="margin: 0px 0px 1.1em; padding: 0px; max-width: 100%; box-sizing: border-box; overflow-wrap: break-word; clear: both; min-height: 1em;"><span style="font-size: 17px; line-height: 1.6; color: rgb(63, 63, 63); font-family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-weight: bold; margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box; overflow-wrap: break-word;">总结</span><span style="font-size: 17px; line-height: 1.6; color: rgb(63, 63, 63); font-family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;">：</span></div><div style="margin: 0px 0px 1.1em; padding: 0px; max-width: 100%; box-sizing: border-box; overflow-wrap: break-word; clear: both; min-height: 1em;"><div><span style="font-size: 17px; line-height: 1.6; color: rgb(51, 51, 51); font-family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;">1、持久代场景</span></div><div><span style="font-size: 17px; line-height: 1.6; color: rgb(51, 51, 51); font-family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;">    • 这块内存区域被完全移除。 </span></div><div><span style="font-size: 17px; line-height: 1.6; color: rgb(51, 51, 51); font-family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;">    • PermSize和MaxPermSize JVM 参数会被忽略，并且在启动的时候会给出警告信息。</span></div></div><div style="margin: 0px 0px 1.1em; padding: 0px; max-width: 100%; box-sizing: border-box; overflow-wrap: break-word; clear: both; min-height: 1em;"><div><span style="font-size: 17px; line-height: 1.6; color: rgb(51, 51, 51); font-family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;">2、Metaspace 内存分配模型 </span></div><div><span style="font-size: 17px; line-height: 1.6; color: rgb(51, 51, 51); font-family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;">    • 对于类元数据的大多数内存分配都不会发生在本地内存。 </span></div><div><span style="font-size: 17px; line-height: 1.6; color: rgb(51, 51, 51); font-family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;">    • 被用于描述类元数据的类对象被移除。</span></div></div><div style="margin: 0px 0px 1.1em; padding: 0px; max-width: 100%; box-sizing: border-box; overflow-wrap: break-word; clear: both; min-height: 1em;"><div><span style="font-size: 17px; line-height: 1.6; color: rgb(51, 51, 51); font-family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;">3、Metaspace 容量 </span></div><div><span style="font-size: 17px; line-height: 1.6; color: rgb(51, 51, 51); font-family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;">    • 默认的，类元数据分配限制于可用的本地内存 (容量大小依赖于你用32位jvm或者64位jvm的操作系统可用虚拟内存)。 </span></div><div><span style="font-size: 17px; line-height: 1.6; color: rgb(51, 51, 51); font-family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;">     • 新的标记已经可以使用 (MaxMetaspaceSize)，它允许你限制用于类元数据的本地内存大小。如果你没有指定这个标记，Metaspace会根据运行时应用程序的需求来动态的控制大小。</span></div></div><div style="margin: 0px 0px 1.1em; padding: 0px; max-width: 100%; box-sizing: border-box; overflow-wrap: break-word; clear: both; min-height: 1em;"><div><span style="font-size: 17px; line-height: 1.6; color: rgb(51, 51, 51); font-family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;">4、Metaspace 垃圾收集 </span></div><div><span style="font-size: 17px; line-height: 1.6; color: rgb(51, 51, 51); font-family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;">    • 一旦类元数据的使用量达到了“MaxMetaspaceSize”指定的值，对于无用的类和类加载器，垃圾收集此时会触发。 </span></div><div><span style="font-size: 17px; line-height: 1.6; color: rgb(51, 51, 51); font-family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;">    • 为了控制这种垃圾收集的频率和延迟，合适的监控和调整Metaspace非常有必要。过于频繁的Metaspace垃圾收集是类和类加载器发生内存泄露的征兆，同时也说明你的应用程序内存大小不合适，需要调整。</span></div></div><div style="margin: 0px 0px 1.1em; padding: 0px; max-width: 100%; box-sizing: border-box; overflow-wrap: break-word; clear: both; min-height: 1em;"><div><span style="font-size: 17px; line-height: 1.6; color: rgb(51, 51, 51); font-family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;">5、Java 堆空间影响 </span></div><div><span style="font-size: 17px; line-height: 1.6; color: rgb(51, 51, 51); font-family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;">    •一些杂项数据被移到了Java堆空间。这意味着当你更新到JDK8后会观察到Java堆空间的增长。</span></div></div><div style="margin: 0px 0px 1.1em; padding: 0px; max-width: 100%; box-sizing: border-box; overflow-wrap: break-word; clear: both; min-height: 1em;"><div><span style="font-size: 17px; line-height: 1.6; color: rgb(51, 51, 51); font-family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;">6、Metaspace 监控 </span></div><div><span style="font-size: 17px; line-height: 1.6; color: rgb(51, 51, 51); font-family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;">    • Metaspace 的使用可以通过HotSpot 1.8的详细的GC日志输出观察到。 </span></div><div><span style="font-size: 17px; line-height: 1.6; color: rgb(51, 51, 51); font-family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;">    • 在基于b75上测试的时候Jstat 和 JVisualVM 还没有更新，旧的持久代空间引用依然存在。</span></div></div><blockquote style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;padding-left:10px;border-left:3px solid rgb(219, 219, 219);"><div style="margin: 0px 0px 1.1em; padding: 0px; max-width: 100%; box-sizing: border-box; overflow-wrap: break-word; clear: both; min-height: 1em;"><span style="font-size: 17px; line-height: 1.6; color: rgb(63, 63, 63); font-family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;">足够的理论知识就介绍到这，让我们在行动中通过会发生泄露的Java程序来看看新的内存空间…</span></div></blockquote><h3 style="font-size: 16px; margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box; overflow-wrap: break-word;"><span style="font-size: 16px; line-height: 1.6; color: rgb(51, 51, 51); font-family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-weight: bold; margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box; overflow-wrap: break-word;">持久代 vs. Metaspace运行时比较</span></h3><h3 style="font-size: 16px; margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box; overflow-wrap: break-word;"><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;"/></h3><h3 style="font-size: 16px; margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box; overflow-wrap: break-word;"><span style="font-size: 16px; line-height: 1.6; color: rgb(51, 51, 51); font-family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-weight: 400;">为了能更好的理解新的metaspace内存空间在运行时的行为，我们创建了一个会发生元数据泄露的java程序。你可以从这里下载。</span></h3><div style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box; overflow-wrap: break-word; clear: both; min-height: 1em;"><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;"/></div><div style="margin: 0px 0px 1.1em; padding: 0px; max-width: 100%; box-sizing: border-box; overflow-wrap: break-word; clear: both; min-height: 1em;"><div><span style="font-size: 17px; line-height: 1.6; color: rgb(63, 63, 63); font-family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;">下面的场景将会被测试: </span></div><div><span style="font-size: 17px; line-height: 1.6; color: rgb(63, 63, 63); font-family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;">    • 使用JDK1.7运行这个Java程序，目的是为了监控和消耗设置好的128M持久代空间。 </span></div><div><span style="font-size: 17px; line-height: 1.6; color: rgb(63, 63, 63); font-family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;">    • 使用JDK1.8(b75)运行这个Java程序，目的是为了监控Metaspace内存空间的动态增长和垃圾收集。 </span></div><div><span style="font-size: 17px; line-height: 1.6; color: rgb(63, 63, 63); font-family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;">    • 使用JDK1.8(b75)运行这个Java程序，设置MaxMetaspaceSize为128M，目的是为了模拟Metaspace空间的消耗。</span></div></div><div style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box; overflow-wrap: break-word; clear: both; min-height: 1em; text-align: left;"><div><span style="font-size: 17px; line-height: 1.6; color: rgb(51, 51, 51); font-family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;">JDK 1.7 @64-bit – 持久代消耗 </span></div><div><span style="font-size: 17px; line-height: 1.6; color: rgb(51, 51, 51); font-family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;">    • 一个包含5万个配置好的迭代的程序 </span></div><div><span style="font-size: 17px; line-height: 1.6; color: rgb(51, 51, 51); font-family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;">    • 1024M的java堆 </span></div><div><span style="font-size: 17px; line-height: 1.6; color: rgb(51, 51, 51); font-family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;">    • 128M java持久代(-XX:MaxPermSize=128m) </span></div></div><div style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box; overflow-wrap: break-word; clear: both; min-height: 1em; text-align: center;"><div><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;"/></div><div><img src="jvm系列(十一)Java 8-从持久代到metaspace_files/permgendepletion.webp" type="image/webp" data-filename="permgendepletion.webp"/></div></div><div style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box; overflow-wrap: break-word; clear: both; min-height: 1em; text-align: center;"><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;"/></div><div style="margin: 0px 0px 1.1em; padding: 0px; max-width: 100%; box-sizing: border-box; overflow-wrap: break-word; clear: both; min-height: 1em; text-align: left;"><span style="font-size: 17px; line-height: 1.6; color: rgb(63, 63, 63); font-family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;">从JVisualVM里可以看到，持久代的消耗在加载了超过3万个类之后几乎达到了临界。我们也可以从Java程序和GC输出中看到这种消耗。 </span></div><div style="margin: 0px 0px 1.1em; padding: 0px; max-width: 100%; box-sizing: border-box; overflow-wrap: break-word; clear: both; min-height: 1em; text-align: center; text-indent: 2em;"><img src="jvm系列(十一)Java 8-从持久代到metaspace_files/permgenspace.webp" type="image/webp" data-filename="permgenspace.webp"/><span style="font-size: 17px; line-height: 1.6; color: rgb(63, 63, 63); font-family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;"> </span></div><div style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box; overflow-wrap: break-word; clear: both; min-height: 1em;"><span style="font-size: 17px; line-height: 1.6; color: rgb(51, 51, 51); font-family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;">现在让我们用HotSpot JDK 1.8 来执行这个程序。</span></div><div style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box; overflow-wrap: break-word; clear: both; min-height: 1em;"><div><span style="font-size: 17px; line-height: 1.6; color: rgb(51, 51, 51); font-family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;">JDK 1.8 @64-bit – Metaspace 动态大小 </span></div><div><span style="font-size: 17px; line-height: 1.6; color: rgb(51, 51, 51); font-family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;">    • 一个包含5万个配置好的迭代的程序 </span></div><div><span style="font-size: 17px; line-height: 1.6; color: rgb(51, 51, 51); font-family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;">    • 1024M的堆 </span></div><div><span style="font-size: 17px; line-height: 1.6; color: rgb(51, 51, 51); font-family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;">    • Java Metaspace空间：无限(默认) </span></div></div><div style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box; overflow-wrap: break-word; clear: both; min-height: 1em; text-align: center;"><div><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;"/></div><div><img src="jvm系列(十一)Java 8-从持久代到metaspace_files/metaspace.webp" type="image/webp" data-filename="metaspace.webp"/><span style="font-size: 17px; line-height: 1.6; color: rgb(51, 51, 51); font-family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;"> </span></div></div><div style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box; overflow-wrap: break-word; clear: both; min-height: 1em; text-align: center;"><div><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;"/></div><div><img src="jvm系列(十一)Java 8-从持久代到metaspace_files/metaspacelog.webp" type="image/webp" data-filename="metaspacelog.webp"/></div></div><div style="margin: 0px 0px 1.1em; padding: 0px; max-width: 100%; box-sizing: border-box; overflow-wrap: break-word; clear: both; min-height: 1em;"><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;"/></div><div style="margin: 0px 0px 1.1em; padding: 0px; max-width: 100%; box-sizing: border-box; overflow-wrap: break-word; clear: both; min-height: 1em;"><span style="font-size: 17px; line-height: 1.6; color: rgb(63, 63, 63); font-family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;">从详细的GC输出可以看到，JVM的metaspace的确动态的把本地内存从20M扩展到了320M，目的是为了适应增长的Java程序中类元数据的内存占用。我们也可以观察到JVM会尝试进行垃圾收集的事件，目的是为了消灭无用的类和类加载器对象。自从我们的Java程序开始泄露内存，JVM没有选择，只能动态扩展Metaspace内存空间。</span></div><div style="margin: 0px 0px 1.1em; padding: 0px; max-width: 100%; box-sizing: border-box; overflow-wrap: break-word; clear: both; min-height: 1em;"><span style="font-size: 17px; line-height: 1.6; color: rgb(63, 63, 63); font-family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;">这个程序可以运行5万次迭代而不会发生OOM事件，并且加载了超过5万个类。</span></div><div style="margin: 0px 0px 1.1em; padding: 0px; max-width: 100%; box-sizing: border-box; overflow-wrap: break-word; clear: both; min-height: 1em;"><span style="font-size: 17px; line-height: 1.6; color: rgb(63, 63, 63); font-family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;">让我们转移到我们最后一次测试场景：</span></div><div style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box; overflow-wrap: break-word; clear: both; min-height: 1em;"><div><span style="font-size: 17px; line-height: 1.6; color: rgb(51, 51, 51); font-family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;">JDK 1.8 @64-bit – Metaspace 消耗 </span></div><div><span style="font-size: 17px; line-height: 1.6; color: rgb(51, 51, 51); font-family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;">    • 一个包含5万个配置好的迭代的程序 </span></div><div><span style="font-size: 17px; line-height: 1.6; color: rgb(51, 51, 51); font-family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;">    • 1024M的堆 </span></div><div><span style="font-size: 17px; line-height: 1.6; color: rgb(51, 51, 51); font-family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;">     • Java Metaspace空间：128 MB (-XX:MaxMetaspaceSize=128m) </span></div></div><div style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box; overflow-wrap: break-word; clear: both; min-height: 1em; text-align: center;"><div><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;"/></div><div><img src="jvm系列(十一)Java 8-从持久代到metaspace_files/metaspace11.webp" type="image/webp" data-filename="metaspace11.webp"/></div></div><div style="margin: 0px 0px 1.1em; padding: 0px; max-width: 100%; box-sizing: border-box; overflow-wrap: break-word; clear: both; min-height: 1em;"><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;"/></div><div style="margin: 0px 0px 1.1em; padding: 0px; max-width: 100%; box-sizing: border-box; overflow-wrap: break-word; clear: both; min-height: 1em;"><span style="font-size: 17px; line-height: 1.6; color: rgb(63, 63, 63); font-family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;">从JVisualVM里可以看到，在加载了超过3万个类后，Metaspace消耗达到了临界，和用JDK1.7运行的结果类似。我们可以从程序和GC输出中看到这个结果。另一个有意思的观察结果是本地内存占用是指定最大值的2倍。这或许可以说明，一种好的调整metaspace扩容的策略有可能避免本地内存的浪费。</span></div><div style="margin: 0px 0px 1.1em; padding: 0px; max-width: 100%; box-sizing: border-box; overflow-wrap: break-word; clear: both; min-height: 1em;"><span style="font-size: 17px; line-height: 1.6; color: rgb(63, 63, 63); font-family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;">和用JDK1.7运行一样，我们指定了metaspace最大容量为128M，但它在我们程序里并不能完成5万次的迭代。新的OOM会被抛出。上面的OOM事件是在内存分配失败后由JVM从metaspace里抛出的。.</span></div><h3 style="font-size: 16px; margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box; overflow-wrap: break-word;"><span style="font-size: 16px; line-height: 1.6; color: rgb(51, 51, 51); font-family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-weight: bold; margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box; overflow-wrap: break-word;">关于metaspace的总结</span></h3><div style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box; overflow-wrap: break-word; clear: both; min-height: 1em;"><strong style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;"><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;"/></strong></div><div style="margin: 0px 0px 1.1em; padding: 0px; max-width: 100%; box-sizing: border-box; overflow-wrap: break-word; clear: both; min-height: 1em;"><span style="font-size: 17px; line-height: 1.6; color: rgb(63, 63, 63); font-family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;">目前观察到的结果完全说明了合适的监控和调优是非常必要的，目的是为了尽量避免类似我们最后一种测试场景中过多的metaspace GC或者OOM触发的问题。</span></div><div style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box; overflow-wrap: break-word; clear: both; min-height: 1em;"><br/></div><div style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box; overflow-wrap: break-word; clear: both; min-height: 1em;"><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;"/></div></div></div></div></div></div><div><br/></div></span>
</div></body></html> 