<html>
<head>
  <title>squid代理服务器</title>
  <basefont face="宋体" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="YXBJ Windows/600718 (zh-CN, DDL); Windows/10.0.0 (Win64);"/>
  <style>
    body, td {
      font-family: 宋体;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="1421"/>
<h1>squid代理服务器</h1>

<div>
<span style="word-wrap: break-word; -webkit-nbsp-mode: space; -webkit-line-break: after-white-space;">
     squid是一个在GNU/GPL协议下发布的既可作为代理服务器，同时也可作为web缓存守护进程的应用软件。squid主要是支持像HTTP和FTP那样的协议，但是对其它的协议比如HTTPS，SSL，TLS等同样也能支持。其特点是web缓存守护进程通过从经常上访问的网站时缓存Web和DNS数据，从而让上网速度更快。Squid支持所有的主流平台，包括Linux、UNIX，微软公司的Windows和苹果公司的Mac。
<div>优势：提高访问速度，减少重复访问</div><div>          隐藏客户机的真实地址</div><div>类型：<font color="#DE5700">传统代理（普通代理）</font></div><div><font color="#DE5700">          透明代理</font></div><div><font color="#DE5700">          反向代理</font></div><div>     每一台代理服务器上都有若干颗硬盘，每个硬盘又分割成多个分区，每一个分区又可以建立多个目录，目录下存放文件，squid称这些文件为object。</div><div>     查询方式：通过查询表的方式来定位某个资源的位置，所查询的表叫hash table和digest table。digest类似于摘要或索引，记录了每个分区，每个目录存放的缓存摘要；hash类似于目录或提纲，它记录了所有的digest表的信息；squid接收到请求后，先查看hash，再根据hash所指向的digest去查询所需要的信息。</div><div><br/></div><div><font color="#DE5700">[传统代理]</font></div><div>1.SQUID被绑定到代理服务器的3128端口。</div><div>2.客户端浏览器被配置使用代理服务器的3128端口。</div><div>3.客户端不需要配置DNS。</div><div>4.代理服务器上需要配置DNS。</div><div>5.客户端不需要配置缺省路由。</div><div><font color="#DE5700">[透明代理]</font></div><div>透明代理的意思是客户端根本不需要知道代理服务器的存在。</div><div>1.配置透明代理服务器软件运行在代理服务器的3128端口。</div><div>2.配置代理服务器将所有对80端口的连接重定向到3128端口。</div><div>3.配置客户端浏览器直接连接到Internet。</div><div>4.在客户端配置好DNS。</div><div>5.配置客户端的缺省网关为192.168.1.1。</div><div><br/></div><div>服务名：squid</div><div>商品号：3128</div><div>配置文件：/etc/squid/squid.conf</div><div><br/></div><div>cache_mem 缓存程序所使用的空间</div><div>maximum_object_size 限制squid能够在本地缓存的文件大小</div><div>reply_body_max_size 用户通过squid能够下载的最大文件大小</div><div>reply_body_max_size 10MB</div><div>error_directory /usr/share/squid/errors/Simplify_Chinese 中文错误信息</div><div>hirerarchy_stoplist cgi-bin ?     用来强制某些特定的对象不被缓存，主要是处于安全的目的</div><div>coredump_dir /var/log/squid     定义dump的目录</div><div>refresh_partern     刷新缓存的规则</div><div><br/></div><div><font color="#DE5700">传统代理：</font></div><div>1、搭建网站，创建首页文件/var/www/html/index.html，并开启服务service httpd start</div><div>2、配置代理服务器，安装软件yum -y install squid</div><div>          修改配置文件vim /etc/squid/squid.conf</div><div>                              visiable_hostname www.xdl.com</div><div>                              service squid start</div><div>3、客户端测试：</div><div>     a、图形化测试</div><div>          修改火狐浏览器设置：编辑-首选项-高级-网络-设置     添加代理服务器地址与3128端口号</div><div>     b、字符界面测试：</div><div>          安装字符浏览器：yum -y install elinks</div><div>          修改全局配置文件，以启用配置：vim /etc/profile</div><div>                                                            HTTP_PROXY=http://代理服务器:3128</div><div>                                                            export HTTP_PROXY</div><div>     注销，重新登录，加载配置项</div><div>     测试、访问网站成功，关闭代理服务器后，再次访问，出现connection refused字样，连接被拒绝。</div><div><br/></div><div><font color="#DE5700">透明代理：</font></div><div>1、内网测试机：配置网关，地址为代理服务器内网口地址</div><div>2、外网网站：创建首页文件，/var/www/html/index.html，并开启服务</div><div>3、代理服务器：两块网卡</div><div>     修改内核配置：vim /etc/sysctl.conf</div><div>                             net.ipv4.ip_forward=1          <i><font color="#328712">#为1时支持IP转发</font></i></div><div>     sysctl -p     <font color="#328712"><i>#刷新配置</i></font></div><div>     配置代理服务器，安装软件yum -y install squid</div><div>     修改配置文件 vim /etc/squid/squid.conf</div><div>                         http_port 代理服务器内网IP:3128 transparent</div><div>                         visiable_hostname www.xdl.com</div><div>      sevice squid start</div><div>     配置防火墙策略：iptables -t nat -I PREROUTING -i 内网接口名 -s 内网网段 -p tcp -dport 80 \</div><div>                               -j REDIRECT --to-ports 3128</div><div>4、用内网测试机，访问外网，可正常显示网页内容</div><div>5、限制下载大小：</div><div>          a、在网站服务器创建一个15M的测试文件1.txt和5M的测试文件2.txt</div><div>               dd if=/dev/zero of=文件名 bs=1M count=15</div><div>          b、在客户机访问http://网站服务器地址/1.txt 访问失败，显示：响应太大</div><div>          c、在客户机访问http://网站服务器地址/2.txt 访问成功，显示下载页面</div><div><br/></div><div><font color="#DE5700">反向代理：</font></div><div>1、代理服务器：两块网卡</div><div>配置代理服务器，修改配置文件：</div><div># vim /etc/squid/squid.conf</div><div>http_port 200.200.200.1:80 vhost                    //这个参数用于支持主机映射（IP地址为外网网关）</div><div>cache_peer 192.168.1.2 parent 80 0 originserver name=a     //指定第1台真实服务器的位置</div><div>cache_peer 192.168.1.3 parent 80 0 originserver name=b     //指定第2台真实服务器的位置</div><div>cache_peer_domain a www.qq.com</div><div>cache_peer_domain b www.baidu.com</div><div># service squid restart</div><div>2、内网网站：</div><div>server1：创建首页文件，/var/www/html/index.html，并开启服务</div><div>server2：创建首页文件，/var/www/html/index.html，并开启服务</div><div>3、用外网测试机，访问内网</div><div>     在浏览器访问200.200.200.1这个外网网关，测试能否正常访问内网网站，关闭其中一台内网Web服务器，测试能否访问另一台Web服务器。</div><div><br/></div><div><br/></div><div>HTTP_PROXY 为HTTP协议提供代理</div><div>HTTPS_PROXY 为HTTPS协议提供代理</div><div>FTP_PROXY 为FTP协议提供代理</div><div>NO_PROXY 添加不使用代理的客户机地址</div><div><br/></div><div><font color="#DE5700">ACL访问控制：</font></div><div>acl：定义列表名称</div><div>http_access：应用列表名称，进行访问控制</div><div>访问规则：</div><div>1、从上至下依次查看</div><div>2、没有任何规则时，默认拒绝squid访问</div><div>3、有规则，但没有匹配的项时，采取与最后一条相反的操作。</div><div><br/></div><div><font color="#DE5700">实例：</font></div><div>1、清除squid缓存</div><div>a、首先停止Squid代理服务，然后从这个'/var/lib/squid/cache'目录中删除缓存</div><div># service squid stop</div><div># rm -rf /var/lib/squid/cache/*</div><div>b、创建交换分区目录</div><div># squid -z</div><div><br/></div><div>2、屏蔽域名</div><div>屏蔽域名是一个配置文件中实现的功能模块。只需要执行一个小的手动配置即可，建议如下。</div><div>a、在'/etc/squid'目录下创建一个名为'blacklist'的文件。</div><div># touch /etc/squid/blacklist</div><div>b、用vim编辑器打开这个文件</div><div># vim /etc/squid/blacklist</div><div>c、以每行一个域名的方式将想要屏蔽的域名写进这个文件里</div><div>.facebook.com</div><div>.twitter.com</div><div>.gmail.com</div><div>.yahoo.com</div><div>......</div><div>d、保存退出，然后从'/etc/squid/squid.conf'打开squid配置文件</div><div># vim /etc/squid/squid.conf</div><div>e、在配置文件中添加如下行</div><div>acl BLACKLIST dstdom_regex -i &quot;/etc/squid/blacklist&quot;</div><div>http_access deny blacklist</div><div>f、保存配置文件并退出，重启squid服务让其生效</div><div># service squid restart</div></span>
</div></body></html> 