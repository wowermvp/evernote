<html>
<head>
  <title>搭建DNS服务</title>
  <basefont face="宋体" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="YXBJ Windows/600718 (zh-CN, DDL); Windows/10.0.0 (Win64);"/>
  <style>
    body, td {
      font-family: 宋体;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="1452"/>
<h1>搭建DNS服务</h1>

<div>
<span style="word-wrap: break-word; -webkit-nbsp-mode: space; -webkit-line-break: after-white-space;">
一、概述
<div>     DNS（Domain Name Server）是域名解析服务器，提供域名和IP地址之间一种相互的转换机制。</div><div>     域名空间结构</div><div>          根域</div><div>          顶级域</div><div>               组织域</div><div>               国家/地区域名</div><div>          二级域名</div><div>          FQDN=主机名.DNS后缀</div><div><img src="搭建DNS服务_files/Image.png" type="image/png" data-filename="Image.png" height="436" style="cursor: default;cursor: default;cursor: default;cursor: default;cursor: default;" width="674"/></div><div>     从查询方式分类</div><div>递归查询（recursion）</div><div>     客户端得到结果只能是成功或失败</div><div>迭代查询（iteration）</div><div>     DNS服务器如有客户机请求数据则返回正确地址，DNS服务器没有请求数据则返回一个指针，按指针继续查询</div><div>     从查询内容分类</div><div>正向查询：由域名查找IP地址</div><div>反向查询：由IP地址查找域名</div><div>二、DNS查询过程</div><div><img src="搭建DNS服务_files/Image [1].png" type="image/png" data-filename="Image.png" height="512" style="cursor: default;cursor: default;cursor: default;cursor: default;cursor: default;" width="968"/></div><div>     本地文件</div><div>     默认先查找本地/etc/hosts文件，然后再查找DNS服务器，这是由于/etc/nsswitch.conf文件决定</div><div>     规定DNS服务器文件为/etc/resolv.conf</div><div>     如果客户端地址为DHCP动态获取，可能会覆盖/etc/resolv.conf文件中的配置，可以在网卡的配置文件/etc/sysconfig/network-scripts/ifcfg-eth0中增加一行内容：PEERDN=no中，重启网络即可</div><div>     hosts文件的格式如下：</div><div>     IP地址     主机名/域名     主机别名</div><div>     相关软件包</div><div style="language:zh-CN;margin-top:4.75pt;margin-bottom:0pt; margin-left:.81in;text-indent:-.31in;text-align:left;direction:ltr;unicode-bidi: embed;mso-line-break-override:none;word-break:normal;punctuation-wrap:hanging"><span style="color: rgb(251, 99, 5);">bind-9.7.0-5.P2.el6_0.1.x86_64 </span>       </div><p style="language:zh-CN;margin-top:4.75pt;margin-bottom:0pt;margin-left:.81in; text-indent:-.31in;text-align:left;direction:ltr;unicode-bidi:embed;mso-line-break-override: none;word-break:normal;punctuation-wrap:hanging">        就是 bind 主程序所需软件</p><div style="language:zh-CN;margin-top:4.75pt;margin-bottom:0pt; margin-left:.81in;text-indent:-.31in;text-align:left;direction:ltr;unicode-bidi: embed;mso-line-break-override:none;word-break:normal;punctuation-wrap:hanging"> <span style="color: rgb(251, 99, 5);">bind-utils-9.7.0-5.P2.el6_0.1.x86_64</span></div><p style="language:zh-CN;margin-top:4.75pt;margin-bottom:0pt;margin-left:.81in; text-indent:-.31in;text-align:left;direction:ltr;unicode-bidi:embed;mso-line-break-override: none;word-break:normal;punctuation-wrap:hanging">        这个是客户端查询主机名的相关指令</p><div style="language:zh-CN;margin-top:4.75pt;margin-bottom:0pt; margin-left:.81in;text-indent:-.31in;text-align:left;direction:ltr;unicode-bidi: embed;mso-line-break-override:none;word-break:normal;punctuation-wrap:hanging"><span style="color: rgb(251, 99, 5);">bind-libs-9.7.0-5.P2.el6_0.1.x86_64</span></div><p style="language:zh-CN;margin-top:4.75pt;margin-bottom:0pt;margin-left:.81in; text-indent:-.31in;text-align:left;direction:ltr;unicode-bidi:embed;mso-line-break-override: none;word-break:normal;punctuation-wrap:hanging">        给 bind 与相关指令使用的函式库</p><div style="language:zh-CN;margin-top:4.75pt;margin-bottom:0pt; margin-left:.81in;text-indent:-.31in;text-align:left;direction:ltr;unicode-bidi: embed;mso-line-break-override:none;word-break:normal;punctuation-wrap:hanging"><span style="color: rgb(251, 99, 5);">bind-chroot-9.7.0-5.P2.el6_0.1.x86_64</span></div><div>                    将 bind 主程序锁定在/var/named/chroot中</div><p style="language:zh-CN;margin-top:0pt;margin-bottom:0pt;text-align:left; direction:ltr;unicode-bidi:embed;vertical-align:baseline">BIND（Berkeley Internet Name Daemon）</p><p style="language:zh-CN;margin-top:0pt;margin-bottom:0pt;text-align:left; direction:ltr;unicode-bidi:embed;vertical-align:baseline">伯克利Internet域名服务</p><p style="language:zh-CN;margin-top:0pt;margin-bottom:0pt;text-align:left; direction:ltr;unicode-bidi:embed;vertical-align:baseline">官方站点：https://www.isc.org/</p><p style="language:zh-CN;margin-top:0pt;margin-bottom:0pt;text-align:left; direction:ltr;unicode-bidi:embed;vertical-align:baseline">软件包：bind-9.3.3-7.el5.i386.rpm</p><p style="language:zh-CN;margin-top:0pt;margin-bottom:0pt;text-align:left; direction:ltr;unicode-bidi:embed;vertical-align:baseline">服务名：named</p><p style="language:zh-CN;margin-top:0pt;margin-bottom:0pt;text-align:left; direction:ltr;unicode-bidi:embed;vertical-align:baseline">端口号：53</p><p style="language:zh-CN;margin-top:0pt;margin-bottom:0pt;text-align:left; direction:ltr;unicode-bidi:embed;vertical-align:baseline">主配置文件：/etc/named.conf</p><div><span style="text-align: left;">保存</span><span style="text-align: left;">DNS</span><span style="text-align: left;">解析记录的数据文件位于：</span> <span style="text-align: left;">/</span><span style="text-align: left;">var</span><span style="text-align: left;">/named/</span></div><div>     主域名服务器：</div><div>特定DNS区域的官方服务器，具有唯一性</div><div>负责维护该区域内所有域名-&gt;IP地址的映射记录</div><div>     从域名服务器：</div><div>也称为辅助域名服务器</div><div>其维护的 域名-&gt;IP地址记录 来源于主域名服务器</div><div>三、配置DNS服务器</div><div>1、配置主配置文件</div><div>[root@localhost ~]# vim /etc/named.conf</div><div>options {</div><div>     listen-on port 53 { 192.168.216.234; };</div><div>     listen-on-v6 port 53 { : : 1; };</div><div>     directory     &quot;/var/named&quot;;</div><div>     dump-file     &quot;/var/named/data/cache_dump.db&quot;;</div><div>     statistics-file &quot;/var/named/data/named_stats.txt&quot;;</div><div>     memstatistics-file &quot;/var/named/data/named_mem_stats.txt&quot;;</div><div>     allow-query     { 192.168.216.0/24; };</div><div>     rescursion yes;</div><div>     </div><div>     dnssec-enable yes;</div><div>     dnssec-validation yes;</div><div>     dnssec-lookaside auto;</div><div><br/></div><div>     /* path to ISC DLV kdy */</div><div>     bindkeys-file &quot;/etc/named.iscdlv.key&quot;;</div><div><br/></div><div>     managed-keys-directory &quot;/var/named/dynamic&quot;;</div><div>};</div><div>logging {</div><div>     channel default_debug {</div><div>          file &quot;data/named.run&quot;;</div><div>          severity dynamic;</div><div>     };</div><div>};  </div><div>2、区域配置文件</div><div>[root@localhost ~]# vim /etc/named.rfc1912.conf</div><div>zone &quot;xdl.com&quot; IN {</div><div>     type master;</div><div>    <font color="#E30000"> file &quot;xdl.localhost&quot;;</font></div><div>     allow-update { none; };</div><div>};</div><div>zone &quot;216.168.192.in-addr_arpa&quot; IN {</div><div>     type master;</div><div>     <font color="#E30000">flie &quot;xdl.empty&quot;;</font></div><div>     allow-update { none; };</div><div>};</div><div>3、配置正向数据文件</div><div>[root@localhost ~]# vim /var/named/xdl.localhost</div><div>STTL 1D</div><div>@     IN     SOA     xdl.com.     rname.invalid. (</div><div>                                                                 0     ; serial</div><div>                                                                 1D   ; refresh</div><div>                                                                 1H   ; retry</div><div>                                                                 1W  ; expire</div><div>                                                                 3H)  ; minimum</div><div>          NS          dns.xdl.com.</div><div>          MX  5      mail.xdl.com.</div><div>dns     A             192.168.216.234</div><div>mail    A             192.168..216.235</div><div>www   A             192.168.216.236</div><div>ftp     CNAME    www</div><div>*         A             192.168.216.100</div><div>[root@localhost ~]# vim /var/named/xdl.empty</div><div>STTL 1D</div><div>@ IN     SOA     xdl.com.     rname.invalid.  (</div><div>                                                                 0     ; serial</div><div>                                                                 1D   ; refresh</div><div>                                                                 1H   ; retry</div><div>                                                                 1W  ; expire</div><div>                                                                 3H)  ; minimum</div><div>          NS          dns.xdl.com.</div><div>          MX  5      mail.xdl.com.</div><div>234     PRT         dns.xdl.com.</div><div>235     PRT         mail.xdl.com.</div><div>236     PRT         www.xdl.com.</div><div>*         PRT          xxx.xdl.com.</div><div>四、从DNS服务器</div><div>1、修改主DNS配置文件</div><div>[root@localhost ~]# vim /etc/named.conf</div><div>options {</div><div>     listen-on port 53 { 192.168.216.234; };</div><div>     listen-on-v6 port 53 { : : 1; };</div><div>     directory     &quot;/var/named&quot;;</div><div>     dump-file     &quot;/var/named/data/cache_dump.db&quot;;</div><div>     statistics-file &quot;/var/named/data/named_stats.txt&quot;;</div><div>     memstatistics-file &quot;/var/named/data/named_mem_stats.txt&quot;;</div><div>     allow-query     { 192.168.216.0/24; };</div><div>    <font color="#E30000"> allow-transfer     { 192.168.216.235; };</font></div><div>     rescursion yes;</div><div>     </div><div>     dnssec-enable yes;</div><div>     dnssec-validation yes;</div><div>     dnssec-lookaside auto;</div><div><br/></div><div>     /* path to ISC DLV kdy */</div><div>     bindkeys-file &quot;/etc/named.iscdlv.key&quot;;</div><div>......省略部分内容......</div><div><br/></div><div>2、修改从DNS配置文件</div><div>[root@localhost ~]# <font color="#2D4FC9">vim /etc/named.conf</font></div><div>options {</div><div>     listen-on port 53 { 192.168.216.235; };</div><div>     listen-on-v6 port 53 { : : 1; };</div><div>     directory     &quot;/var/named&quot;;</div><div>     dump-file     &quot;/var/named/data/cache_dump.db&quot;;</div><div>     statistics-file &quot;/var/named/data/named_stats.txt&quot;;</div><div>     memstatistics-file &quot;/var/named/data/named_mem_stats.txt&quot;;</div><div>     allow-query     { 192.168.216.0/24; };</div><div>     rescursion yes;</div><div>     </div><div>     dnssec-enable yes;</div><div>     dnssec-validation yes;</div><div>     dnssec-lookaside auto;</div><div><br/></div><div>     /* path to ISC DLV kdy */</div><div>     bindkeys-file &quot;/etc/named.iscdlv.key&quot;;</div><div>......省略部分内容......</div><div>3、配置从DNS区域文件</div><div>[root@localhost ~]# vim /etc/named.rfc1912.conf</div><div>zone &quot;xdl.com&quot; IN {</div><div>     <font color="#E30000">type slave;</font></div><div>     <font color="#E30000">file &quot;slaves/xdl.localhost&quot;;</font></div><div>     allow-update { none; };</div><div>     <font color="#E30000">masters { 192.168.216.234; };</font></div><div>};</div><div>zone &quot;216.168.192.in-addr_arpa&quot; IN {</div><div>     <font color="#E30000">type slave;</font></div><div><font color="#E30000">     flie &quot;slaves/xdl.empty&quot;;</font></div><div>     allow-update { none; };</div><div>     <font color="#E30000">masters { 192.168.216.234; };</font></div><div>};</div><div>五、分离解析DNS服务器</div><div>作用：将相同的域名解析为不同的IP地址</div><div>实验环境：</div><div>     三台虚拟机：</div><div>     1、第一个网段测试机</div><div>     2、网关、分离解析DNS</div><div>     3、第二个网段测试机</div><div>修改主配置文件</div><div>[root@localhost ~]# vim /etc/named.conf</div><div>options {</div><div>     listen-on port 53 { any; };</div><div>     listen-on-v6 port 53 { : : 1; };</div><div>     directory     &quot;/var/named&quot;;</div><div>     dump-file     &quot;/var/named/data/cache_dump.db&quot;;</div><div>     statistics-file &quot;/var/named/data/named_stats.txt&quot;;</div><div>     memstatistics-file &quot;/var/named/data/named_mem_stats.txt&quot;;</div><div>     allow-query     { any; };</div><div>     rescursion yes;</div><div>     </div><div>     dnssec-enable yes;</div><div>     dnssec-validation yes;</div><div>     dnssec-lookaside auto;</div><div><br/></div><div>     /* path to ISC DLV kdy */</div><div>     bindkeys-file &quot;/etc/named.iscdlv.key&quot;;</div><div>......省略部分内容......</div><div><font color="#E30000">#zone &quot;.&quot; IN {</font></div><div><font color="#E30000">#     type hint;</font></div><div><font color="#E30000">#     file &quot;name.ca&quot;;</font></div><div><font color="#E30000">#};                              </font><i><font color="#328712">#将这部分内容注释掉</font></i></div><div>view lan {</div><div><font color="#E30000">     match-clients { 192.168.216.0/24; };</font></div><div><font color="#E30000">     </font>zone &quot;.&quot; IN {</div><div>     type hint;</div><div>     file &quot;named.ca&quot;;</div><div>     };</div><div><font color="#E30000">include &quot;/etc/named/named.lan&quot;;</font></div><div>};</div><div>view wan {</div><div><font color="#E30000">     match-clients { any; };</font></div><div><font color="#E30000">     </font>zone &quot;.&quot; IN {</div><div>     type hint;</div><div>     file &quot;named.ca&quot;;</div><div>     };</div><div><font color="#E30000">include &quot;/etc/named/named.wan&quot;;</font></div><div>};</div><div>修改区域配置文件</div><div>[root@localhost ~]# <font color="#E30000">vim /etc/name.lan</font></div><div>     zone &quot;xdl.com&quot; IN {</div><div>          type master;</div><div>          file &quot;xdl-lan.localhost&quot;;</div><div>          allow-update { none; };</div><div>     };</div><div>     zone &quot;216.168.192.in-addr.arpa&quot; IN {</div><div>          type master;</div><div>          file &quot;xdl-lan.empty&quot;;</div><div>          allow-update { none; };</div><div>     };</div><div>[root@localhost ~]# <font color="#E30000">vim /etc/name.wan</font></div><div>     zone &quot;xdl.com&quot; IN {</div><div>          type master;</div><div>          file &quot;xdl-wan.localhost&quot;;</div><div>          allow-update { none; };</div><div>     };</div><div>     zone &quot;200.200.200.in-addr.arpa&quot; IN {</div><div>          type master;</div><div>          file &quot;xdl-wan.empty&quot;;</div><div>          allow-update { none; };</div><div>     };</div><div>修改数据配置文件</div><div>[root@localhost ~]# vim /var/named/xdl-lan.localhost</div><div>     STTL 1D</div><div>     @     IN     SOA     xdl.com.     rname.invalid. (</div><div>                                                                      0     ; serial</div><div>                                                                      1D   ; refresh</div><div>                                                                      1H   ; retry</div><div>                                                                      1W  ; expire</div><div>                                                                      3H)  ; minimum</div><div>               NS          dns.xdl.com.</div><div>               MX  5      mail.xdl.com.</div><div>     dns     A             192.168.216.234</div><div>     mail    A             192.168..216.235</div><div>     www   A             192.168.216.236</div><div>     ftp     CNAME    www</div><div>     *         A             192.168.216.100</div><div>[root@localhost ~]# vim /var/named/xdl-lan.empty</div><div>     STTL 1D</div><div>     @ IN     SOA     xdl.com.     rname.invalid.  (</div><div>                                                                      0     ; serial</div><div>                                                                      1D   ; refresh</div><div>                                                                      1H   ; retry</div><div>                                                                      1W  ; expire</div><div>                                                                      3H)  ; minimum</div><div>               NS          dns.xdl.com.</div><div>               MX  5      mail.xdl.com.</div><div>     234     PRT         dns.xdl.com.</div><div>     235     PRT         mail.xdl.com.</div><div>     236     PRT         www.xdl.com.</div><div>     *         PRT          xxx.xdl.com.</div><div>[root@localhost ~]# vim /var/named/xdl-wan.localhost</div><div>     STTL 1D</div><div>     @     IN     SOA     xdl.com.     rname.invalid. (</div><div>                                                                      0     ; serial</div><div>                                                                      1D   ; refresh</div><div>                                                                      1H   ; retry</div><div>                                                                      1W  ; expire</div><div>                                                                      3H)  ; minimum</div><div>               NS          dns.xdl.com.</div><div>               MX  5      mail.xdl.com.</div><div>     dns     A             200.200.200.2</div><div>     mail    A             200.200.200.3</div><div>     www   A             200.200.200.4</div><div>     ftp     CNAME    www</div><div>     *         A             200.200.200.100</div><div>[root@localhost ~]# vim /var/named/xdl-wan.empty</div><div>     STTL 1D</div><div>     @ IN     SOA     xdl.com.     rname.invalid.  (</div><div>                                                                      0     ; serial</div><div>                                                                      1D   ; refresh</div><div>                                                                      1H   ; retry</div><div>                                                                      1W  ; expire</div><div>                                                                      3H)  ; minimum</div><div>               NS          dns.xdl.com.</div><div>               MX  5      mail.xdl.com.</div><div>     2        PRT         dns.xdl.com.</div><div>     3        PRT         mail.xdl.com.</div><div>     4        PRT         www.xdl.com.</div><div>     *         PRT          xxx.xdl.com.</div></span>
</div></body></html> 