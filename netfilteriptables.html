<html>
<head>
  <title>netfilter/iptables</title>
  <basefont face="宋体" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="YXBJ Windows/600718 (zh-CN, DDL); Windows/10.0.0 (Win64);"/>
  <style>
    body, td {
      font-family: 宋体;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="1414"/>
<h1>netfilter/iptables</h1>

<div>
<span style="word-wrap: break-word; -webkit-nbsp-mode: space; -webkit-line-break: after-white-space;">
netfilter：位于Linux内核中的包过滤功能体系称为Linux防火墙的“内核态”。
<div>iptables：位于/sbin/iptables，用来管理防火墙规则的工具称为Linux防火墙的“用户态”。</div><div>规则表：</div><div>表的作用：容纳各种规则链</div><div>表的划分依据：防火墙规则的作用相似</div><div>默认包括4个规则表：</div><div>raw表：确定是否对该数据包进行状态跟踪</div><div>mangle表：为数据包设置标记</div><div>nat表：修改数据包中的源、目标IP地址或端口</div><div>filter表：确定是否放行该数据包（过滤）</div><div><br/></div><div>规则链：</div><div>规则的作用：对数据包进行过滤或处理</div><div>链的作用：容纳各种防火墙规则</div><div>链的分类依据：处理数据包的不同时机</div><div><br/></div><div><font color="#DE5700">默认包括5种规则链</font></div><div>PREROUTING：在进行路由选择前处理数据包</div><div>INPUT：处理入站数据包</div><div>OUPUT：处理出站数据包</div><div>FORWARD：处理转发数据包</div><div>POSTROUTING：在进行路由选择后处理数据包</div><div><img src="netfilteriptables_files/Image.png" type="image/png" data-filename="Image.png" height="485" style="cursor: default;cursor: default;cursor: default;" width="853"/></div><div><br/></div><div>规则表之间的顺序</div><div>raw---mangle---nat---filter</div><div><br/></div><div><font color="#DE5700">规则链之间的顺序</font></div><div>入站：PREROUTING、INPUT</div><div>出站：OUTPUT、POSTROUTING</div><div>转发：PREROUTING、FORWARD、POSTROUTING</div><div>规则链内的匹配顺序</div><div>按顺序自上而下依次检查，匹配即停止（LOG策略除外）</div><div>若找不到相匹配的规则，则按该链的默认策略处理</div><div><br/></div><div><font color="#DE5700">语法构成</font></div><div>iptables [-t 表名] 选项 [链名] [条件] [-j 控制类型]</div><div>注意事项：</div><div>     不指定表名时，默认指filter表</div><div>     不指定链名时，默认指表内的所有链</div><div>     除非设置链的默认策略，否则必须指定匹配条件</div><div>     选项、链名、控制类型、使用大写字母，其余均为小写</div><div><font color="#DE5700">常见控制类型：</font></div><div>     ACCEPT：允许通过</div><div>     DROP：直接丢弃，不给出任何回应</div><div>     REJECT：拒绝通过，必要时会给出提示</div><div>     LOG：记录日志信息，然后转给下一条规则继续匹配</div><div><font color="#DE5700">添加新规则：</font></div><div>     -A：在链的末尾追加一条规则</div><div>     -I：在链的开头（或指定序号）插入一条规则</div><div>     例：</div><div>     # iptables -t filter -A INPUT -p tcp -j ACCEPT</div><div>     # iptables -I INPUT -p udp -j ACCEPT</div><div>     # iptables -I INPUT 2 -p icmp -j ACCEPT</div><div><font color="#DE5700">查看规则列表</font></div><div>     -L：列出所有的规则条目</div><div>     -n：以数字形式显示地址、端口等信息</div><div>     -v：以更详细方式显示规则信息</div><div>     --line-numbers：查看规则时，显示规则的序号</div><div>     例：# iptables -L INPUT --line-numbers</div><div><font color="#DE5700">删除、清空规则</font></div><div>     -D：删除链内指定序号（或内容）的一条规则</div><div>     -F：清空所有的规则</div><div>     # iptables -D INPUT 3                         #删除INPUT链中第3条规则</div><div><font color="#DE5700">设置默认策略</font></div><div>     -P：为指定的链设置默认规则</div><div>     例：# iptables -t filter -P FORWARD DROP</div><div>     # iptables -P OUTPUT ACCEPT</div><div><img src="netfilteriptables_files/Image [1].png" type="image/png" data-filename="Image.png" height="464" style="cursor: default;cursor: default;cursor: default;" width="841"/></div><div>通用匹配</div><div>     可直接使用，不依赖于其他条件或扩展</div><div>     包括网络协议、IP地址、网络接口条件</div><div>隐含匹配</div><div>     要求以特定的协议匹配作为前提</div><div>     包括端口、TCP标记、ICMP类型等条件</div><div>显式匹配</div><div>     要求以“-m 扩展模块”的形式明确指出类型</div><div>     包括多端口、MAC地址、IP范围、数据包状态等条件</div><div><font color="#DE5700">常见的通用匹配条件</font></div><div>     协议匹配：-p 协议名</div><div>     地址匹配：-s 源地址、-d 目的地址</div><div>     接口匹配：-i 入站网卡、-o 出站网卡</div><div>例：# iptables -A FORWARD -s 192.168.1.11 -j REJECT</div><div>      # iptables -I INPUT -s 10.20.30.0/24 -j DROP</div><div>      # iptables -I INPUT -p icmp -j DROP</div><div>      # iptables -A FORWARD -p ! icmp -j REJECT</div><div>      # iptables -A INPUT -i eth1 -s 192.168.0.0/16 -j DROP</div><div>      # iptables -A INPUT -i eth1 -s 10.0.0.0/8 -j DROP</div><div>      # iptables -A INPUT -i eth1 -s 172.16.0.0/12 -j DROP</div><div><font color="#DE5700">常用的隐含匹配条件</font></div><div>     端口匹配：--sport 源端口、--dport 目的端口</div><div>     ICMP类型匹配：--icmp-type ICMP类型</div><div>例：# iptables -A FORWARD -s 192.168.4.0/24 -p udp --dport 53 -j ACCEPT</div><div>      # iptables -A INPUT -p tcp --dport 20:21 -j ACCEPT</div><div>      # iptables -A INPUT -p icmp --icmp-type 8 -j DROP</div><div>      # iptables -A INPUT -p icmp --icmp-type 0 -j ACCEPT</div><div>      # iptables -A INPUT -p icmp --icmp-type 3 -j ACCEPT</div><div>      # iptables -A INPUT -p icmp -j DROP</div><div><font color="#DE5700">常用的显式匹配条件</font></div><div>     多端口匹配：-m multiport --sport 源端口列表</div><div>                         -m multiport --dport 目的端口列表</div><div>     IP范围匹配：-m iprange --src-range IP范围</div><div>     MAC地址匹配：-m mac --mac-source MAC地址</div><div>     状态匹配：-m state --state 连接状态</div><div>例：# iptables -A INPUT -p tcp -m multiport --dport 25,80,110,143 -j ACCEPT</div><div>      # iptables -A FORWARD -p tcp -m iprange --src-range 192.168.4.21-192.168.4.28 -j ACCEPT</div><div>      # iptables -A INPUT -m mac --mac-source 00:0C:29:C0:55:3F -j DROP</div><div>      # iptables -I INPUT -p tcp -m multiport --dport 80 -j ACCEPT</div><div>      # iptabes -I INPUT -p tcp -m state --state ESTABLISHED,RELATED -j ACCEPT</div><div><img src="netfilteriptables_files/Image [2].png" type="image/png" data-filename="Image.png" height="509" style="cursor: default;cursor: default;cursor: default;" width="834"/></div><div><br/></div><div>SNAT策略的典型应用环境</div><div>     局域网主机共享单个公网IP地址接入Internet</div><div>SNAT策略的原理</div><div>     源地址转换，Source Network Address Translation</div><div>     修改数据包的源地址</div><div><img src="netfilteriptables_files/Image [3].png" type="image/png" data-filename="Image.png" height="492" style="cursor: default;cursor: default;cursor: default;" width="741"/></div><div>前提条件</div><div>     局域网的web服务器能够访问Ineternet</div><div>     网关的外网IP地址有正确的DNS解析记录</div><div>     Linux网关支持IP路由转发</div><div>实现方法</div><div>     编写DNAT转换规则</div><div># iptabes -t nat -A PREROUTING -i eth0 -d 218.29.30.31 -p tcp --dport 80 -j DNAT --to-destination 192.168.1.6</div><div><br/></div><div>导出（备份）规则</div><div>iptables-save工具，可结合重定向输出保存到指定文件</div><div>导入（还原）规则</div><div>iptables-restore工具，可结合重定向输入指定规则来源</div><div><br/></div><div>iptables服务</div><div>脚本位置：/etc/init.d/iptables</div><div>规则文件位置：/etc/sysconfig/iptables</div></span>
</div></body></html> 