<html>
<head>
  <title>搭建redis-sentinel集群</title>
  <basefont face="宋体" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="YXBJ Windows/600718 (zh-CN, DDL); Windows/10.0.0 (Win64);"/>
  <style>
    body, td {
      font-family: 宋体;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="1283"/>
<h1>搭建redis-sentinel集群</h1>

<div>
<span><div><div align="center" style="min-height: 21pt;"><font color="#010101" face="宋体" size="4"><span style="font-size:16pt"><b>搭建redis-sentinel集群</b></span></font></div><ol style="margin-top: 0mm; margin-bottom: 0mm; margin-left: 0mm; padding-left: 0pt;"><li style="margin-left: 15pt; margin-right: 0pt; padding-left: -18pt; text-indent:0pt; font-family: ����; font-size: 12pt; color: #010101;"><font color="#010101" face="宋体"><span style="font-size:12pt; font-family:����; color:#010101; font-weight:Normal; font-style:Normal; font-decoration:Normal">环境要求：redis-sentinel集群最少需要三个redis实例，环境如下：</span></font></li></ol><div align="left" style="margin-left:0mm; margin-right:0mm; text-indent:7mm; margin-top:0.00mm; margin-bottom:0.00mm;min-height: 15pt;"><font color="#010101" face="宋体"><span style="font-size:12pt">172.16.10.131 6379   redis01           26379  sentinel01</span></font></div><div align="left" style="margin-left:0mm; margin-right:0mm; text-indent:7mm; margin-top:0.00mm; margin-bottom:0.00mm;min-height: 15pt;"><font color="#010101" face="宋体"><span style="font-size:12pt">172.16.10.133     6379   redis02           26379  sentinel02</span></font></div><div align="left" style="margin-left:0mm; margin-right:0mm; text-indent:7mm; margin-top:0.00mm; margin-bottom:0.00mm;min-height: 15pt;"><font color="#010101" face="宋体"><span style="font-size:12pt">172.16.10.134     6379   redis03           26379  sentinel03</span></font></div><ol start="2" style="margin-top: 0mm; margin-bottom: 0mm; margin-left: 0mm; padding-left: 0pt;"><li style="margin-left: 15pt; margin-right: 0pt; padding-left: -18pt; text-indent:0pt; font-family: ����; font-size: 12pt; color: #010101;"><font color="#010101" face="宋体"><span style="font-size:12pt; font-family:����; color:#010101; font-weight:Normal; font-style:Normal; font-decoration:Normal">安装</span></font></li></ol><div align="left" style="margin-left:0mm; margin-right:0mm; text-indent:7mm; margin-top:0.00mm; margin-bottom:0.00mm;min-height: 15pt;"><font color="#010101" face="宋体"><span style="font-size:12pt">Redis安装路径：/home/cec/redis</span></font></div><div align="left" style="margin-left:0mm; margin-right:0mm; text-indent:7mm; margin-top:0.00mm; margin-bottom:0.00mm;min-height: 15pt;"><font color="#010101" face="宋体"><span style="font-size:12pt">安装方法：# tar zxf redis-3.0.4.tar.gz</span></font></div><div align="left" style="margin-left:22mm; margin-right:0mm; text-indent:7mm; margin-top:0.00mm; margin-bottom:0.00mm;min-height: 15pt;"><font color="#010101" face="宋体"><span style="font-size:12pt"># mv redis-3.0.4 redis</span></font></div><div align="left" style="margin-left:22mm; margin-right:0mm; text-indent:7mm; margin-top:0.00mm; margin-bottom:0.00mm;min-height: 15pt;"><font color="#010101" face="宋体"><span style="font-size:12pt"># vim redis.conf</span></font></div><div align="left" style="margin-left:30mm; margin-right:0mm; text-indent:7mm; margin-top:0.00mm; margin-bottom:0.00mm;min-height: 15pt;"><font color="#010101" face="宋体"><span style="font-size:12pt"><b>dir /home/cec/redis</b></span></font></div><div align="left" style="margin-left:22mm; margin-right:0mm; text-indent:7mm; margin-top:0.00mm; margin-bottom:0.00mm;min-height: 15pt;"><font color="#010101" face="宋体"><span style="font-size:12pt"># make</span></font></div><div align="left" style="margin-left:22mm; margin-right:0mm; text-indent:7mm; margin-top:0.00mm; margin-bottom:0.00mm;min-height: 15pt;"><font color="#010101" face="宋体"><span style="font-size:12pt"># 开放防火墙6379端口        ##测试环境直接关闭防火墙</span></font></div><ol start="3" style="margin-top: 0mm; margin-bottom: 0mm; margin-left: 0mm; padding-left: 0pt;"><li style="margin-left: 15pt; margin-right: 0pt; padding-left: -18pt; text-indent:0pt; font-family: ����; font-size: 12pt; color: #010101;"><font color="#010101" face="宋体"><span style="font-size:12pt; font-family:����; color:#010101; font-weight:Normal; font-style:Normal; font-decoration:Normal">修改配置文件</span></font></li></ol><div align="left" style="margin-left:0mm; margin-right:0mm; text-indent:7mm; margin-top:0.00mm; margin-bottom:0.00mm;min-height: 15pt;"><font color="#010101" face="宋体"><span style="font-size:12pt">3.1 修改master配置文件redis.conf</span></font></div><div align="left" style="margin-left:7mm; margin-right:0mm; text-indent:7mm; margin-top:0.00mm; margin-bottom:0.00mm;min-height: 16pt;"><font color="#010101" face="宋体"><span style="font-size:12pt"><b>logfile</b></span></font> <font color="#010101" face="Calibri"><span style="font-size:12pt"><b>“</b></span></font><font color="#010101" face="宋体"><span style="font-size:12pt"><b>/home/cec/redis/logs/redis.log</b></span></font><font color="#010101" face="Calibri"><span style="font-size:12pt"><b>”</b></span></font><font color="#010101" face="宋体"><span style="font-size:12pt"><b> </b></span><span style="font-size:12pt">   ##开启日志，新建logs目录</span></font></div><div align="left" style="margin-left:0mm; margin-right:0mm; text-indent:7mm; margin-top:0.00mm; margin-bottom:0.00mm;min-height: 15pt;"><font color="#010101" face="宋体"><span style="font-size:12pt">3.2 修改slave配置文件redis.conf</span></font></div><div align="left" style="margin-left:7mm; margin-right:0mm; text-indent:7mm; margin-top:0.00mm; margin-bottom:0.00mm;min-height: 16pt;"><font color="#010101" face="宋体"><span style="font-size:12pt"><b>logfile</b></span></font> <font color="#010101" face="Calibri"><span style="font-size:12pt"><b>“</b></span></font><font color="#010101" face="宋体"><span style="font-size:12pt"><b>/home/cec/redis/logs/redis.log</b></span></font><font color="#010101" face="Calibri"><span style="font-size:12pt"><b>”</b></span></font></div><div align="left" style="margin-left:7mm; margin-right:0mm; text-indent:7mm; margin-top:0.00mm; margin-bottom:0.00mm;min-height: 15pt;"><font color="#010101" face="宋体"><span style="font-size:12pt"><b>slaveof 172.16.10.131 6379</b></span></font></div><div align="left" style="margin-left:0mm; margin-right:0mm; text-indent:7mm; margin-top:0.00mm; margin-bottom:0.00mm;min-height: 15pt;"><font color="#010101" face="宋体"><span style="font-size:12pt">3.3 修改三个sentinel配置文件sentinel.conf</span></font></div><div align="left" style="margin-left:7mm; margin-right:0mm; text-indent:7mm; margin-top:0.00mm; margin-bottom:0.00mm;min-height: 15pt;"><font color="#010101" face="宋体"><span style="font-size:12pt"><b>port 26379</b></span></font></div><div align="left" style="margin-left:7mm; margin-right:0mm; text-indent:7mm; margin-top:0.00mm; margin-bottom:0.00mm;min-height: 15pt;"><font color="#010101" face="宋体"><span style="font-size:12pt"><b>dir /home/cec/redis/tmp</b></span><span style="font-size:12pt">                ##新建tmp目录</span></font></div><div align="left" style="margin-left:7mm; margin-right:0mm; text-indent:7mm; margin-top:0.00mm; margin-bottom:0.00mm;min-height: 15pt;"><font color="#010101" face="宋体"><span style="font-size:12pt">#####修改master name ip#####</span></font></div><div align="left" style="margin-left:7mm; margin-right:0mm; text-indent:7mm; margin-top:0.00mm; margin-bottom:0.00mm;min-height: 15pt;"><font color="#010101" face="宋体"><span style="font-size:12pt"><b>sentinel monitor mymaster 172.16.10.131 6379 2</b></span></font></div><div align="left" style="margin-left:7mm; margin-right:0mm; text-indent:7mm; margin-top:0.00mm; margin-bottom:0.00mm;min-height: 16pt;"><font color="#010101" face="宋体"><span style="font-size:12pt"><b>logfile</b></span></font> <font color="#010101" face="Calibri"><span style="font-size:12pt"><b>“</b></span></font><font color="#010101" face="宋体"><span style="font-size:12pt"><b>/home/cec/redis/logs/sentinel.conf</b></span></font><font color="#010101" face="Calibri"><span style="font-size:12pt"><b>”</b></span></font></div><ol start="4" style="margin-top: 0mm; margin-bottom: 0mm; margin-left: 0mm; padding-left: 0pt;"><li style="margin-left: 15pt; margin-right: 0pt; padding-left: -18pt; text-indent:0pt; font-family: ����; font-size: 12pt; color: #010101;"><font color="#010101" face="宋体"><span style="font-size:12pt; font-family:����; color:#010101; font-weight:Normal; font-style:Normal; font-decoration:Normal">启动服务</span></font></li></ol><div align="left" style="margin-left:0mm; margin-right:0mm; text-indent:7mm; margin-top:0.00mm; margin-bottom:0.00mm;min-height: 15pt;"><font color="#010101" face="宋体"><span style="font-size:12pt"># /home/cec/redis/src/redis-server /home/cec/redis/redis.conf &amp;</span></font></div><div align="left" style="margin-left:0mm; margin-right:0mm; text-indent:7mm; margin-top:0.00mm; margin-bottom:0.00mm;min-height: 15pt;"><font color="#010101" face="宋体"><span style="font-size:12pt"># /home/cec/redis/src/redis-sentinel /home/cec/redis/sentinel.conf &amp;</span></font></div><div align="left" style="min-height: 77pt;"><img src="搭建redis-sentinel集群_files/Image.png" type="image/png" data-filename="Image.png" alt="graphic" border="0" height="103" width="575"/></div><div align="left" style="min-height: 16pt;"><font color="#010101" face="Calibri"><span style="font-size:12pt">5</span></font><font color="#010101" face="宋体"><span style="font-size:12pt">、开发需要修改程序代码，添加redis集群模块。</span></font></div><div align="left" style="min-height: 15pt;"><font color="#010101" face="宋体"><span style="font-size:12pt">6、相关命令</span></font></div><div align="left" style="margin-left:0mm; margin-right:0mm; text-indent:7mm; margin-top:0.00mm; margin-bottom:0.00mm;min-height: 15pt;"><font color="#010101" face="宋体"><span style="font-size:12pt"># redis-cli -p 6379 info Replication   </span></font></div><div align="left" style="margin-left:0mm; margin-right:0mm; text-indent:7mm; margin-top:0.00mm; margin-bottom:0.00mm;min-height: 15pt;"><font color="#010101" face="宋体"><span style="font-size:12pt">###查看主的信息###</span></font></div><div align="left" style="min-height: 147pt;"><img src="搭建redis-sentinel集群_files/Image [1].png" type="image/png" data-filename="Image.png" alt="graphic" border="0" height="196" width="535"/></div><div align="left" style="margin-left:0mm; margin-right:0mm; text-indent:7mm; margin-top:0.00mm; margin-bottom:0.00mm;min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">###查看从的信息###</span></font></div><div align="left" style="min-height: 173pt;"><img src="搭建redis-sentinel集群_files/Image [2].png" type="image/png" data-filename="Image.png" alt="graphic" border="0" height="231" width="551"/></div><div align="left" style="margin-left:0mm; margin-right:0mm; text-indent:7mm; margin-top:0.00mm; margin-bottom:0.00mm;min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt"># redis-cli -p 26379 info Sentinel          ##查看哨兵监测到的信息</span></font></div><div align="left" style="min-height: 87pt;"><img src="搭建redis-sentinel集群_files/Image [3].png" type="image/png" data-filename="Image.png" alt="graphic" border="0" height="117" width="555"/></div><ol start="5" style="margin-top: 0mm; margin-bottom: 0mm; margin-left: 0mm; padding-left: 0pt;"><li style="margin-left: 15pt; margin-right: 0pt; padding-left: -18pt; text-indent:0pt; font-family: ����; font-size: 10pt; color: #010101;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt; font-family:����; color:#010101; font-weight:Normal; font-style:Normal; font-decoration:Normal">故障及恢复</span></font></li></ol><div align="left" style="margin-left:0mm; margin-right:0mm; text-indent:7mm; margin-top:0.00mm; margin-bottom:0.00mm;min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">三台redis集群能够支撑两台redis出现故障。</span></font></div><div align="left" style="margin-left:0mm; margin-right:0mm; text-indent:7mm; margin-top:0.00mm; margin-bottom:0.00mm;min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">6.1 测试slave故障：slave故障后，重新启动redis即可，故障期间的数据会自动同步。如下：关闭10.133的redis服务，在master上可以看到slave只剩下一台。</span></font><img src="搭建redis-sentinel集群_files/Image [4].png" type="image/png" data-filename="Image.png" alt="graphic" border="0" height="145" width="553"/></div><div align="left" style="margin-left:0mm; margin-right:0mm; text-indent:7mm; margin-top:0.00mm; margin-bottom:0.00mm;min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">此时在master上写入一个新数据，待133的redis重启后再在133上get，数据是可以同步的。测试两台slave故障情况类似。</span></font></div><div align="left" style="margin-left:0mm; margin-right:0mm; text-indent:7mm; margin-top:0.00mm; margin-bottom:0.00mm;min-height: 72pt;"><img src="搭建redis-sentinel集群_files/Image [5].png" type="image/png" data-filename="Image.png" alt="graphic" border="0" height="96" width="462"/></div><div align="left" style="margin-left:0mm; margin-right:0mm; text-indent:7mm; margin-top:0.00mm; margin-bottom:0.00mm;min-height: 75pt;"><img src="搭建redis-sentinel集群_files/Image [6].png" type="image/png" data-filename="Image.png" alt="graphic" border="0" height="100" width="553"/></div><div align="left" style="margin-left:0mm; margin-right:0mm; text-indent:7mm; margin-top:0.00mm; margin-bottom:0.00mm;min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">6.2 测试master故障，master故障后，集群通过sentinel会在两台slave中选举新的master，如下：关闭master 10.134的redis，10.131就转变成了新的master，此时集群是能正常提供服务的。</span></font></div><div align="left" style="margin-left:0mm; margin-right:0mm; text-indent:7mm; margin-top:0.00mm; margin-bottom:0.00mm;min-height: 80pt;"><img src="搭建redis-sentinel集群_files/Image [7].png" type="image/png" data-filename="Image.png" alt="graphic" border="0" height="107" width="502"/></div><div align="left" style="margin-left:0mm; margin-right:0mm; text-indent:7mm; margin-top:0.00mm; margin-bottom:0.00mm;min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">然后重新启动10.134的redis，此时134的角色就成了slave。</span></font></div><div align="left" style="margin-left:0mm; margin-right:0mm; text-indent:7mm; margin-top:0.00mm; margin-bottom:0.00mm;min-height: 63pt;"><img src="搭建redis-sentinel集群_files/Image [8].png" type="image/png" data-filename="Image.png" alt="graphic" border="0" height="84" width="530"/></div><div align="left" style="margin-left:0mm; margin-right:0mm; text-indent:7mm; margin-top:0.00mm; margin-bottom:0.00mm;min-height: 15pt;"><div><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">测试期间，有测试工程师协助测试应用性能，上述故障情况，应用能正常工作。</span></font></div></div></div></span>
</div></body></html> 