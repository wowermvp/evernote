<html>
<head>
  <title>Keepalived+Nginx架构整理版 | Linux运维笔记</title>
  <basefont face="宋体" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="YXBJ Windows/600718 (zh-CN, DDL); Windows/10.0.0 (Win64);"/>
  <style>
    body, td {
      font-family: 宋体;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="1293"/>
<h1>Keepalived+Nginx架构整理版 | Linux运维笔记</h1>

<div><span><div style="-evernote-webclip:true"><br/><div style="font-size: 16px"><div style="font-family:inherit;font-size:62.5%;font-style:inherit;outline:0px;vertical-align:baseline;box-sizing:border-box;overflow-y:scroll;text-size-adjust:100%;"><div style="font-variant:normal;font-family:&quot;Microsoft YaHei&quot;, Helvetica, Arial, &quot;Lucida Grande&quot;, Tahoma, sans-serif;font-style:normal;outline:0px;vertical-align:baseline;box-sizing:inherit;font-size:14px;font-weight:normal;font-stretch:normal;color:rgb(68, 68, 68);line-height:180%;background:rgb(241, 241, 241);"><div style="box-sizing:inherit;font-family:inherit;font-size:100%;font-style:inherit;outline:0px;vertical-align:baseline;"><div style="box-sizing:inherit;font-family:inherit;font-size:100%;font-style:inherit;outline:0px;vertical-align:baseline;"><div style="box-sizing:inherit;font-family:inherit;font-size:100%;font-style:inherit;outline:0px;vertical-align:baseline;transition-duration:0.5s;"><span style="box-sizing:inherit;"><div style="box-sizing:inherit;font-family:inherit;font-size:100%;font-style:inherit;outline:0px;vertical-align:baseline;animation-duration:1s;animation-fill-mode:both;animation-delay:0.3s;"><div style="box-sizing:inherit;font-family:inherit;font-size:100%;font-style:inherit;outline:0px;vertical-align:baseline;background:rgb(255, 255, 255);box-shadow:rgba(0, 0, 0, 0.0392157) 0px 1px 1px;border-radius:2px;">
		<div style="box-sizing:inherit;border:0px;font-family:inherit;font-size:100%;font-style:inherit;margin:0px;outline:0px;padding:0px;vertical-align:baseline;display:block;">
					<h1 style="padding:5px 20px;text-align:center;border:0px;font-family:inherit;font-size:1.8rem;font-style:inherit;outline:0px;margin:35px -20px 20px;vertical-align:baseline;box-sizing:inherit;position:relative;line-height:30px;border-left:5px solid rgb(47, 136, 154);border-right:5px solid rgb(47, 136, 154);">Keepalived+Nginx架构整理版</h1>			</div>

	<div style="box-sizing:inherit;border:0px;font-family:inherit;font-size:100%;font-style:inherit;margin:0px;outline:0px;padding:0px;vertical-align:baseline;">
					<div style="box-sizing:inherit;border:0px;font-family:inherit;font-style:inherit;margin:0px;outline:0px;padding:0px;vertical-align:baseline;font-size:1.5rem;line-height:1.8;">
				
				
				
			

<span style="padding:0px;border:0px;font-size:100%;font-style:inherit;box-sizing:inherit;outline:0px;font-family:inherit;vertical-align:baseline;margin:8px -21px;float:left;height:30px;border-left:5px solid rgb(47, 136, 154);"></span><h4 style="outline:0px;border:0px;box-sizing:inherit;font-style:inherit;margin:0px;font-family:inherit;vertical-align:baseline;padding:70px 30px 5px;font-size:1.6rem;line-height:280%;margin-top:-70px;">Keepalived介绍</h4>
<p style="padding:0px;border:0px;font-size:100%;font-style:inherit;box-sizing:inherit;outline:0px;font-family:inherit;vertical-align:baseline;margin:0px 0px 5px;word-wrap:break-word;word-break:break-all;text-indent:2em;">keepalived是一个类似于layer3, 4, 5 交换机制的软件，也就是我们平时说的第3层、第4层和第5层交换。Keepalived的作用是检测web服务器的状态，如果有一台web服务器死机，或工作出现故障，Keepalived将检测到，并将有故障的web服务器从系统中剔除，当web服务器工作正常后Keepalived自动将web服务器加入到服务器群中，这些工作全部自动完成，不需要人工干涉，需要人工做的只是修复故障的web服务器</p>
<p style="padding:0px;border:0px;font-size:100%;font-style:inherit;box-sizing:inherit;outline:0px;font-family:inherit;vertical-align:baseline;margin:0px 0px 5px;word-wrap:break-word;word-break:break-all;text-indent:2em;">官网地址：<a href="https://blog.linuxeye.com/wp-content/themes/begin/inc/go.php?url=http://www.keepalived.org/" style="padding:0px;border:0px;font-size:100%;font-style:inherit;margin:0px;outline:0px;font-family:inherit;vertical-align:baseline;box-sizing:inherit;text-decoration:none;-webkit-tap-highlight-color:rgba(255, 0, 0, 0);color:rgb(47, 136, 154);">http://www.keepalived.org</a></p>
<p style="padding:0px;border:0px;font-size:100%;font-style:inherit;box-sizing:inherit;outline:0px;font-family:inherit;vertical-align:baseline;margin:0px 0px 5px;word-wrap:break-word;word-break:break-all;text-indent:2em;">keepalved官方体系结构图：</p>
<div align="center" style="box-sizing:inherit;border:0px;font-family:inherit;font-size:100%;font-style:inherit;margin:0px;outline:0px;padding:0px;vertical-align:baseline;"><img src="Keepalived+Nginx架构整理版  Linux运维笔记_files/Image.png" type="image/png" data-filename="Image.png" alt="" height="396" style="padding:0px;border:0px;font-size:100%;font-style:inherit;margin:0px;outline:0px;font-family:inherit;box-sizing:inherit;vertical-align:middle;max-width:100%;height:auto;display:block;" title="" width="575"/></div>
<span style="padding:0px;border:0px;font-size:100%;font-style:inherit;box-sizing:inherit;outline:0px;font-family:inherit;vertical-align:baseline;margin:8px -21px;float:left;height:30px;border-left:5px solid rgb(47, 136, 154);"></span><h4 style="outline:0px;border:0px;box-sizing:inherit;font-style:inherit;margin:0px;font-family:inherit;vertical-align:baseline;padding:70px 30px 5px;font-size:1.6rem;line-height:280%;margin-top:-70px;">环境准备</h4>
<div style="vertical-align:baseline;border:1px dashed rgb(204, 204, 204);font-size:100%;font-style:inherit;margin:10px auto;outline:0px;padding:5px;font-family:inherit;box-sizing:inherit;background:rgb(255, 255, 255);width:96%;word-break:break-all;white-space:normal;overflow:auto;">
<ol start="1" style="padding:2px;border:0px;font-size:100%;font-style:inherit;list-style:none;outline:0px;font-family:inherit;vertical-align:baseline;box-sizing:inherit;margin:0px 0px 1px -15px;word-wrap:break-word;word-break:break-all;color:rgb(102, 102, 102);">
<li style="padding:0px;border:0px;font-size:100%;font-style:inherit;box-sizing:inherit;outline:0px;font-family:inherit;vertical-align:baseline;margin:0px 35px 0px 50px;line-height:18px;list-style:decimal;border-left:1px dashed rgb(204, 204, 204);padding-left:10px;">操作系统：CentOS6.6 64位 2台</li>
<li style="padding:0px;border:0px;font-size:100%;font-style:inherit;box-sizing:inherit;outline:0px;font-family:inherit;vertical-align:baseline;margin:0px 35px 0px 50px;line-height:18px;list-style:decimal;border-left:1px dashed rgb(204, 204, 204);padding-left:10px;">Nginx-Master   10.0.0.60</li>
<li style="padding:0px;border:0px;font-size:100%;font-style:inherit;box-sizing:inherit;outline:0px;font-family:inherit;vertical-align:baseline;margin:0px 35px 0px 50px;line-height:18px;list-style:decimal;border-left:1px dashed rgb(204, 204, 204);padding-left:10px;">Nginx-Backup   10.0.0.61</li>
<li style="padding:0px;border:0px;font-size:100%;font-style:inherit;box-sizing:inherit;outline:0px;font-family:inherit;vertical-align:baseline;margin:0px 35px 0px 50px;line-height:18px;list-style:decimal;border-left:1px dashed rgb(204, 204, 204);padding-left:10px;">VIP                      10.0.0.62</li>
</ol>
</div>
<p style="padding:0px;border:0px;font-size:100%;font-style:inherit;box-sizing:inherit;outline:0px;font-family:inherit;vertical-align:baseline;margin:0px 0px 5px;word-wrap:break-word;word-break:break-all;text-indent:2em;">注：未做特别说明，两台服务器(两个节点)都一样操作</p>
<span style="padding:0px;border:0px;font-size:100%;font-style:inherit;box-sizing:inherit;outline:0px;font-family:inherit;vertical-align:baseline;margin:8px -21px;float:left;height:30px;border-left:5px solid rgb(47, 136, 154);"></span><h4 style="outline:0px;border:0px;box-sizing:inherit;font-style:inherit;margin:0px;font-family:inherit;vertical-align:baseline;padding:70px 30px 5px;font-size:1.6rem;line-height:280%;margin-top:-70px;">安装Nginx</h4>
<p style="padding:0px;border:0px;font-size:100%;font-style:inherit;box-sizing:inherit;outline:0px;font-family:inherit;vertical-align:baseline;margin:0px 0px 5px;word-wrap:break-word;word-break:break-all;text-indent:2em;">使用《<a href="https://blog.linuxeye.com/wp-content/themes/begin/inc/go.php?url=https://oneinstack.com" style="padding:0px;border:0px;font-size:100%;font-style:inherit;margin:0px;outline:0px;font-family:inherit;vertical-align:baseline;box-sizing:inherit;text-decoration:none;-webkit-tap-highlight-color:rgba(255, 0, 0, 0);color:rgb(47, 136, 154);">OneinStack</a>》Nginx选择y，其余n</p>
<span style="padding:0px;border:0px;font-size:100%;font-style:inherit;box-sizing:inherit;outline:0px;font-family:inherit;vertical-align:baseline;margin:8px -21px;float:left;height:30px;border-left:5px solid rgb(47, 136, 154);"></span><h4 style="outline:0px;border:0px;box-sizing:inherit;font-style:inherit;margin:0px;font-family:inherit;vertical-align:baseline;padding:70px 30px 5px;font-size:1.6rem;line-height:280%;margin-top:-70px;">安装Keepalived</h4>
<p style="padding:0px;border:0px;font-size:100%;font-style:inherit;box-sizing:inherit;outline:0px;font-family:inherit;vertical-align:baseline;margin:0px 0px 5px;word-wrap:break-word;word-break:break-all;text-indent:2em;">在Nginx-Master、Nginx-Backup：</p>
<div style="vertical-align:baseline;border:1px dashed rgb(204, 204, 204);font-size:100%;font-style:inherit;margin:10px auto;outline:0px;padding:5px;font-family:inherit;box-sizing:inherit;background:rgb(255, 255, 255);width:96%;word-break:break-all;white-space:normal;overflow:auto;">
<div style="box-sizing:inherit;border:0px;font-family:inherit;font-size:100%;font-style:inherit;margin:0px;outline:0px;vertical-align:baseline;padding:2px;"></div>
<ol start="1" style="padding:2px;border:0px;font-size:100%;font-style:inherit;list-style:none;outline:0px;font-family:inherit;vertical-align:baseline;box-sizing:inherit;margin:0px 0px 1px -15px;word-wrap:break-word;word-break:break-all;color:rgb(102, 102, 102);">
<li style="padding:0px;border:0px;font-size:100%;font-style:inherit;box-sizing:inherit;outline:0px;font-family:inherit;vertical-align:baseline;margin:0px 35px 0px 50px;line-height:18px;list-style:decimal;border-left:1px dashed rgb(204, 204, 204);padding-left:10px;">cd ~/oneinstack/src</li>
<li style="padding:0px;border:0px;font-size:100%;font-style:inherit;box-sizing:inherit;outline:0px;font-family:inherit;vertical-align:baseline;margin:0px 35px 0px 50px;line-height:18px;list-style:decimal;border-left:1px dashed rgb(204, 204, 204);padding-left:10px;">wget http://www.keepalived.org/software/keepalived-1.2.22.tar.gz</li>
<li style="padding:0px;border:0px;font-size:100%;font-style:inherit;box-sizing:inherit;outline:0px;font-family:inherit;vertical-align:baseline;margin:0px 35px 0px 50px;line-height:18px;list-style:decimal;border-left:1px dashed rgb(204, 204, 204);padding-left:10px;">tar xzf keepalived-1.2.22.tar.gz</li>
<li style="padding:0px;border:0px;font-size:100%;font-style:inherit;box-sizing:inherit;outline:0px;font-family:inherit;vertical-align:baseline;margin:0px 35px 0px 50px;line-height:18px;list-style:decimal;border-left:1px dashed rgb(204, 204, 204);padding-left:10px;">cd keepalived-1.2.22</li>
<li style="padding:0px;border:0px;font-size:100%;font-style:inherit;box-sizing:inherit;outline:0px;font-family:inherit;vertical-align:baseline;margin:0px 35px 0px 50px;line-height:18px;list-style:decimal;border-left:1px dashed rgb(204, 204, 204);padding-left:10px;">./configure <span style="box-sizing:inherit;border:0px;font-family:inherit;font-size:100%;font-style:inherit;margin:0px;outline:0px;padding:0px;vertical-align:baseline;color:red;">--prefix</span>=/usr/local/keepalived</li>
<li style="padding:0px;border:0px;font-size:100%;font-style:inherit;box-sizing:inherit;outline:0px;font-family:inherit;vertical-align:baseline;margin:0px 35px 0px 50px;line-height:18px;list-style:decimal;border-left:1px dashed rgb(204, 204, 204);padding-left:10px;">make &amp;&amp; make install</li>
</ol>
</div>
<span style="padding:0px;border:0px;font-size:100%;font-style:inherit;box-sizing:inherit;outline:0px;font-family:inherit;vertical-align:baseline;margin:8px -21px;float:left;height:30px;border-left:5px solid rgb(47, 136, 154);"></span><h4 style="outline:0px;border:0px;box-sizing:inherit;font-style:inherit;margin:0px;font-family:inherit;vertical-align:baseline;padding:70px 30px 5px;font-size:1.6rem;line-height:280%;margin-top:-70px;">配置Keepalived</h4>
<p style="padding:0px;border:0px;font-size:100%;font-style:inherit;box-sizing:inherit;outline:0px;font-family:inherit;vertical-align:baseline;margin:0px 0px 5px;word-wrap:break-word;word-break:break-all;text-indent:2em;">在Nginx-Master、Nginx-Backup：</p>
<div style="vertical-align:baseline;border:1px dashed rgb(204, 204, 204);font-size:100%;font-style:inherit;margin:10px auto;outline:0px;padding:5px;font-family:inherit;box-sizing:inherit;background:rgb(255, 255, 255);width:96%;word-break:break-all;white-space:normal;overflow:auto;">
<ol start="1" style="padding:2px;border:0px;font-size:100%;font-style:inherit;list-style:none;outline:0px;font-family:inherit;vertical-align:baseline;box-sizing:inherit;margin:0px 0px 1px -15px;word-wrap:break-word;word-break:break-all;color:rgb(102, 102, 102);">
<li style="padding:0px;border:0px;font-size:100%;font-style:inherit;box-sizing:inherit;outline:0px;font-family:inherit;vertical-align:baseline;margin:0px 35px 0px 50px;line-height:18px;list-style:decimal;border-left:1px dashed rgb(204, 204, 204);padding-left:10px;">ln -s /usr/local/keepalived/etc/keepalived /etc/keepalived</li>
<li style="padding:0px;border:0px;font-size:100%;font-style:inherit;box-sizing:inherit;outline:0px;font-family:inherit;vertical-align:baseline;margin:0px 35px 0px 50px;line-height:18px;list-style:decimal;border-left:1px dashed rgb(204, 204, 204);padding-left:10px;">ln -s /usr/local/keepalived/etc/rc.d/init.d/keepalived /etc/rc.d/init.d/keepalived</li>
<li style="padding:0px;border:0px;font-size:100%;font-style:inherit;box-sizing:inherit;outline:0px;font-family:inherit;vertical-align:baseline;margin:0px 35px 0px 50px;line-height:18px;list-style:decimal;border-left:1px dashed rgb(204, 204, 204);padding-left:10px;">ln -s /usr/local/keepalived/etc/sysconfig/keepalived /etc/sysconfig/keepalived</li>
<li style="padding:0px;border:0px;font-size:100%;font-style:inherit;box-sizing:inherit;outline:0px;font-family:inherit;vertical-align:baseline;margin:0px 35px 0px 50px;line-height:18px;list-style:decimal;border-left:1px dashed rgb(204, 204, 204);padding-left:10px;">ln -s /usr/local/keepalived/sbin/keepalived /usr/bin/keepalived</li>
<li style="padding:0px;border:0px;font-size:100%;font-style:inherit;box-sizing:inherit;outline:0px;font-family:inherit;vertical-align:baseline;margin:0px 35px 0px 50px;line-height:18px;list-style:decimal;border-left:1px dashed rgb(204, 204, 204);padding-left:10px;">chkconfig keepalived on</li>
</ol>
</div>
<p style="padding:0px;border:0px;font-size:100%;font-style:inherit;box-sizing:inherit;outline:0px;font-family:inherit;vertical-align:baseline;margin:0px 0px 5px;word-wrap:break-word;word-break:break-all;text-indent:2em;">在Nginx-Master修改配置文件，vi /etc/keepalived/keepalived.conf</p>
<div style="vertical-align:baseline;border:1px dashed rgb(204, 204, 204);font-size:100%;font-style:inherit;margin:10px auto;outline:0px;padding:5px;font-family:inherit;box-sizing:inherit;background:rgb(255, 255, 255);width:96%;word-break:break-all;white-space:normal;overflow:auto;">
<ol start="1" style="padding:2px;border:0px;font-size:100%;font-style:inherit;list-style:none;outline:0px;font-family:inherit;vertical-align:baseline;box-sizing:inherit;margin:0px 0px 1px -15px;word-wrap:break-word;word-break:break-all;color:rgb(102, 102, 102);">
<li style="padding:0px;border:0px;font-size:100%;font-style:inherit;box-sizing:inherit;outline:0px;font-family:inherit;vertical-align:baseline;margin:0px 35px 0px 50px;line-height:18px;list-style:decimal;border-left:1px dashed rgb(204, 204, 204);padding-left:10px;">! Configuration File for keepalived</li>
<li style="padding:0px;border:0px;font-size:100%;font-style:inherit;box-sizing:inherit;outline:0px;font-family:inherit;vertical-align:baseline;margin:0px 35px 0px 50px;line-height:18px;list-style:decimal;border-left:1px dashed rgb(204, 204, 204);padding-left:10px;"></li>
<li style="padding:0px;border:0px;font-size:100%;font-style:inherit;box-sizing:inherit;outline:0px;font-family:inherit;vertical-align:baseline;margin:0px 35px 0px 50px;line-height:18px;list-style:decimal;border-left:1px dashed rgb(204, 204, 204);padding-left:10px;">global_defs {</li>
<li style="padding:0px;border:0px;font-size:100%;font-style:inherit;box-sizing:inherit;outline:0px;font-family:inherit;vertical-align:baseline;margin:0px 35px 0px 50px;line-height:18px;list-style:decimal;border-left:1px dashed rgb(204, 204, 204);padding-left:10px;">   notification_email {</li>
<li style="padding:0px;border:0px;font-size:100%;font-style:inherit;box-sizing:inherit;outline:0px;font-family:inherit;vertical-align:baseline;margin:0px 35px 0px 50px;line-height:18px;list-style:decimal;border-left:1px dashed rgb(204, 204, 204);padding-left:10px;">       admin@linuxeye.com     #设置报警邮件地址，可以设置多个，每行一个。 需开启本机的sendmail服务</li>
<li style="padding:0px;border:0px;font-size:100%;font-style:inherit;box-sizing:inherit;outline:0px;font-family:inherit;vertical-align:baseline;margin:0px 35px 0px 50px;line-height:18px;list-style:decimal;border-left:1px dashed rgb(204, 204, 204);padding-left:10px;">   }</li>
<li style="padding:0px;border:0px;font-size:100%;font-style:inherit;box-sizing:inherit;outline:0px;font-family:inherit;vertical-align:baseline;margin:0px 35px 0px 50px;line-height:18px;list-style:decimal;border-left:1px dashed rgb(204, 204, 204);padding-left:10px;">   notification_email_from no-reply@linuxeye.com  #设置邮件的发送地址</li>
<li style="padding:0px;border:0px;font-size:100%;font-style:inherit;box-sizing:inherit;outline:0px;font-family:inherit;vertical-align:baseline;margin:0px 35px 0px 50px;line-height:18px;list-style:decimal;border-left:1px dashed rgb(204, 204, 204);padding-left:10px;">   smtp_server 127.0.0.1            #设置smtp server地址</li>
<li style="padding:0px;border:0px;font-size:100%;font-style:inherit;box-sizing:inherit;outline:0px;font-family:inherit;vertical-align:baseline;margin:0px 35px 0px 50px;line-height:18px;list-style:decimal;border-left:1px dashed rgb(204, 204, 204);padding-left:10px;">   smtp_connect_timeout 30    #设置连接smtp server的超时时间</li>
<li style="padding:0px;border:0px;font-size:100%;font-style:inherit;box-sizing:inherit;outline:0px;font-family:inherit;vertical-align:baseline;margin:0px 35px 0px 50px;line-height:18px;list-style:decimal;border-left:1px dashed rgb(204, 204, 204);padding-left:10px;">   router_id LVS_DEVEL              #表示运行keepalived服务器的一个标识。发邮件时显示在邮件主题的信息</li>
<li style="padding:0px;border:0px;font-size:100%;font-style:inherit;box-sizing:inherit;outline:0px;font-family:inherit;vertical-align:baseline;margin:0px 35px 0px 50px;line-height:18px;list-style:decimal;border-left:1px dashed rgb(204, 204, 204);padding-left:10px;">}</li>
<li style="padding:0px;border:0px;font-size:100%;font-style:inherit;box-sizing:inherit;outline:0px;font-family:inherit;vertical-align:baseline;margin:0px 35px 0px 50px;line-height:18px;list-style:decimal;border-left:1px dashed rgb(204, 204, 204);padding-left:10px;"></li>
<li style="padding:0px;border:0px;font-size:100%;font-style:inherit;box-sizing:inherit;outline:0px;font-family:inherit;vertical-align:baseline;margin:0px 35px 0px 50px;line-height:18px;list-style:decimal;border-left:1px dashed rgb(204, 204, 204);padding-left:10px;">vrrp_script chk_nginx {</li>
<li style="padding:0px;border:0px;font-size:100%;font-style:inherit;box-sizing:inherit;outline:0px;font-family:inherit;vertical-align:baseline;margin:0px 35px 0px 50px;line-height:18px;list-style:decimal;border-left:1px dashed rgb(204, 204, 204);padding-left:10px;">    script &quot;/usr/local/keepalived/sbin/check_nginx.sh&quot;   #该脚本检测ngnix的运行状态，并在nginx进程不存在时尝试重新启动ngnix，如果启动失败则停止keepalived，准备让其它机器接管。</li>
<li style="padding:0px;border:0px;font-size:100%;font-style:inherit;box-sizing:inherit;outline:0px;font-family:inherit;vertical-align:baseline;margin:0px 35px 0px 50px;line-height:18px;list-style:decimal;border-left:1px dashed rgb(204, 204, 204);padding-left:10px;">    interval 2              #每2s检测一次</li>
<li style="padding:0px;border:0px;font-size:100%;font-style:inherit;box-sizing:inherit;outline:0px;font-family:inherit;vertical-align:baseline;margin:0px 35px 0px 50px;line-height:18px;list-style:decimal;border-left:1px dashed rgb(204, 204, 204);padding-left:10px;">    weight 2               #检测失败（脚本返回非0）则优先级2</li>
<li style="padding:0px;border:0px;font-size:100%;font-style:inherit;box-sizing:inherit;outline:0px;font-family:inherit;vertical-align:baseline;margin:0px 35px 0px 50px;line-height:18px;list-style:decimal;border-left:1px dashed rgb(204, 204, 204);padding-left:10px;">}</li>
<li style="padding:0px;border:0px;font-size:100%;font-style:inherit;box-sizing:inherit;outline:0px;font-family:inherit;vertical-align:baseline;margin:0px 35px 0px 50px;line-height:18px;list-style:decimal;border-left:1px dashed rgb(204, 204, 204);padding-left:10px;"></li>
<li style="padding:0px;border:0px;font-size:100%;font-style:inherit;box-sizing:inherit;outline:0px;font-family:inherit;vertical-align:baseline;margin:0px 35px 0px 50px;line-height:18px;list-style:decimal;border-left:1px dashed rgb(204, 204, 204);padding-left:10px;">vrrp_instance VI_1 {</li>
<li style="padding:0px;border:0px;font-size:100%;font-style:inherit;box-sizing:inherit;outline:0px;font-family:inherit;vertical-align:baseline;margin:0px 35px 0px 50px;line-height:18px;list-style:decimal;border-left:1px dashed rgb(204, 204, 204);padding-left:10px;">    state MASTER              #指定keepalived的角色，MASTER表示此主机是主服务器，BACKUP表示此主机是备用服务器</li>
<li style="padding:0px;border:0px;font-size:100%;font-style:inherit;box-sizing:inherit;outline:0px;font-family:inherit;vertical-align:baseline;margin:0px 35px 0px 50px;line-height:18px;list-style:decimal;border-left:1px dashed rgb(204, 204, 204);padding-left:10px;">    interface eth0              #指定HA监测网络的接口</li>
<li style="padding:0px;border:0px;font-size:100%;font-style:inherit;box-sizing:inherit;outline:0px;font-family:inherit;vertical-align:baseline;margin:0px 35px 0px 50px;line-height:18px;list-style:decimal;border-left:1px dashed rgb(204, 204, 204);padding-left:10px;">    virtual_router_id 55    #虚拟路由标识，这个标识是一个数字，同一个vrrp实例使用唯一的标识。即同一vrrp_instance下，MASTER和BACKUP必须是一致的</li>
<li style="padding:0px;border:0px;font-size:100%;font-style:inherit;box-sizing:inherit;outline:0px;font-family:inherit;vertical-align:baseline;margin:0px 35px 0px 50px;line-height:18px;list-style:decimal;border-left:1px dashed rgb(204, 204, 204);padding-left:10px;">    priority 100                  #定义优先级，数字越大，优先级越高，在同一个vrrp_instance下，MASTER的优先级必须大于BACKUP的优先级</li>
<li style="padding:0px;border:0px;font-size:100%;font-style:inherit;box-sizing:inherit;outline:0px;font-family:inherit;vertical-align:baseline;margin:0px 35px 0px 50px;line-height:18px;list-style:decimal;border-left:1px dashed rgb(204, 204, 204);padding-left:10px;">    advert_int 1            #设定MASTER与BACKUP负载均衡器之间同步检查的时间间隔，单位是秒</li>
<li style="padding:0px;border:0px;font-size:100%;font-style:inherit;box-sizing:inherit;outline:0px;font-family:inherit;vertical-align:baseline;margin:0px 35px 0px 50px;line-height:18px;list-style:decimal;border-left:1px dashed rgb(204, 204, 204);padding-left:10px;">    authentication {        #设置验证类型和密码</li>
<li style="padding:0px;border:0px;font-size:100%;font-style:inherit;box-sizing:inherit;outline:0px;font-family:inherit;vertical-align:baseline;margin:0px 35px 0px 50px;line-height:18px;list-style:decimal;border-left:1px dashed rgb(204, 204, 204);padding-left:10px;">        auth_type PASS      #设置验证类型，主要有PASS和AH两种</li>
<li style="padding:0px;border:0px;font-size:100%;font-style:inherit;box-sizing:inherit;outline:0px;font-family:inherit;vertical-align:baseline;margin:0px 35px 0px 50px;line-height:18px;list-style:decimal;border-left:1px dashed rgb(204, 204, 204);padding-left:10px;">        auth_pass linuxeye  #设置验证密码，在同一个vrrp_instance下，MASTER与BACKUP必须使用相同的密码才能正常通信</li>
<li style="padding:0px;border:0px;font-size:100%;font-style:inherit;box-sizing:inherit;outline:0px;font-family:inherit;vertical-align:baseline;margin:0px 35px 0px 50px;line-height:18px;list-style:decimal;border-left:1px dashed rgb(204, 204, 204);padding-left:10px;">    }</li>
<li style="padding:0px;border:0px;font-size:100%;font-style:inherit;box-sizing:inherit;outline:0px;font-family:inherit;vertical-align:baseline;margin:0px 35px 0px 50px;line-height:18px;list-style:decimal;border-left:1px dashed rgb(204, 204, 204);padding-left:10px;">    virtual_ipaddress {     #设置虚拟IP地址，可以设置多个虚拟IP地址，每行一个</li>
<li style="padding:0px;border:0px;font-size:100%;font-style:inherit;box-sizing:inherit;outline:0px;font-family:inherit;vertical-align:baseline;margin:0px 35px 0px 50px;line-height:18px;list-style:decimal;border-left:1px dashed rgb(204, 204, 204);padding-left:10px;">        10.0.0.62</li>
<li style="padding:0px;border:0px;font-size:100%;font-style:inherit;box-sizing:inherit;outline:0px;font-family:inherit;vertical-align:baseline;margin:0px 35px 0px 50px;line-height:18px;list-style:decimal;border-left:1px dashed rgb(204, 204, 204);padding-left:10px;">    }</li>
<li style="padding:0px;border:0px;font-size:100%;font-style:inherit;box-sizing:inherit;outline:0px;font-family:inherit;vertical-align:baseline;margin:0px 35px 0px 50px;line-height:18px;list-style:decimal;border-left:1px dashed rgb(204, 204, 204);padding-left:10px;">    track_script {</li>
<li style="padding:0px;border:0px;font-size:100%;font-style:inherit;box-sizing:inherit;outline:0px;font-family:inherit;vertical-align:baseline;margin:0px 35px 0px 50px;line-height:18px;list-style:decimal;border-left:1px dashed rgb(204, 204, 204);padding-left:10px;">        chk_nginx           #引用VRRP脚本，即在 vrrp_script 部分指定的名字。定期运行它们来改变优先级，并最终引发主备切换。</li>
<li style="padding:0px;border:0px;font-size:100%;font-style:inherit;box-sizing:inherit;outline:0px;font-family:inherit;vertical-align:baseline;margin:0px 35px 0px 50px;line-height:18px;list-style:decimal;border-left:1px dashed rgb(204, 204, 204);padding-left:10px;">    }</li>
<li style="padding:0px;border:0px;font-size:100%;font-style:inherit;box-sizing:inherit;outline:0px;font-family:inherit;vertical-align:baseline;margin:0px 35px 0px 50px;line-height:18px;list-style:decimal;border-left:1px dashed rgb(204, 204, 204);padding-left:10px;">}</li>
</ol>
</div>
<p style="padding:0px;border:0px;font-size:100%;font-style:inherit;box-sizing:inherit;outline:0px;font-family:inherit;vertical-align:baseline;margin:0px 0px 5px;word-wrap:break-word;word-break:break-all;text-indent:2em;">在Nginx-Backup修改配置文件，vi /etc/keepalived/keepalived.conf</p>
<div style="vertical-align:baseline;border:1px dashed rgb(204, 204, 204);font-size:100%;font-style:inherit;margin:10px auto;outline:0px;padding:5px;font-family:inherit;box-sizing:inherit;background:rgb(255, 255, 255);width:96%;word-break:break-all;white-space:normal;overflow:auto;">
<ol start="1" style="padding:2px;border:0px;font-size:100%;font-style:inherit;list-style:none;outline:0px;font-family:inherit;vertical-align:baseline;box-sizing:inherit;margin:0px 0px 1px -15px;word-wrap:break-word;word-break:break-all;color:rgb(102, 102, 102);">
<li style="padding:0px;border:0px;font-size:100%;font-style:inherit;box-sizing:inherit;outline:0px;font-family:inherit;vertical-align:baseline;margin:0px 35px 0px 50px;line-height:18px;list-style:decimal;border-left:1px dashed rgb(204, 204, 204);padding-left:10px;">! Configuration File for keepalived</li>
<li style="padding:0px;border:0px;font-size:100%;font-style:inherit;box-sizing:inherit;outline:0px;font-family:inherit;vertical-align:baseline;margin:0px 35px 0px 50px;line-height:18px;list-style:decimal;border-left:1px dashed rgb(204, 204, 204);padding-left:10px;"></li>
<li style="padding:0px;border:0px;font-size:100%;font-style:inherit;box-sizing:inherit;outline:0px;font-family:inherit;vertical-align:baseline;margin:0px 35px 0px 50px;line-height:18px;list-style:decimal;border-left:1px dashed rgb(204, 204, 204);padding-left:10px;">global_defs {</li>
<li style="padding:0px;border:0px;font-size:100%;font-style:inherit;box-sizing:inherit;outline:0px;font-family:inherit;vertical-align:baseline;margin:0px 35px 0px 50px;line-height:18px;list-style:decimal;border-left:1px dashed rgb(204, 204, 204);padding-left:10px;">   notification_email {</li>
<li style="padding:0px;border:0px;font-size:100%;font-style:inherit;box-sizing:inherit;outline:0px;font-family:inherit;vertical-align:baseline;margin:0px 35px 0px 50px;line-height:18px;list-style:decimal;border-left:1px dashed rgb(204, 204, 204);padding-left:10px;">       admin@linuxeye.com     #设置报警邮件地址，可以设置多个，每行一个。 需开启本机的sendmail服务</li>
<li style="padding:0px;border:0px;font-size:100%;font-style:inherit;box-sizing:inherit;outline:0px;font-family:inherit;vertical-align:baseline;margin:0px 35px 0px 50px;line-height:18px;list-style:decimal;border-left:1px dashed rgb(204, 204, 204);padding-left:10px;">   }</li>
<li style="padding:0px;border:0px;font-size:100%;font-style:inherit;box-sizing:inherit;outline:0px;font-family:inherit;vertical-align:baseline;margin:0px 35px 0px 50px;line-height:18px;list-style:decimal;border-left:1px dashed rgb(204, 204, 204);padding-left:10px;">   notification_email_from no-reply@linuxeye.com  #设置邮件的发送地址</li>
<li style="padding:0px;border:0px;font-size:100%;font-style:inherit;box-sizing:inherit;outline:0px;font-family:inherit;vertical-align:baseline;margin:0px 35px 0px 50px;line-height:18px;list-style:decimal;border-left:1px dashed rgb(204, 204, 204);padding-left:10px;">   smtp_server 127.0.0.1      #设置smtp server地址</li>
<li style="padding:0px;border:0px;font-size:100%;font-style:inherit;box-sizing:inherit;outline:0px;font-family:inherit;vertical-align:baseline;margin:0px 35px 0px 50px;line-height:18px;list-style:decimal;border-left:1px dashed rgb(204, 204, 204);padding-left:10px;">   smtp_connect_timeout 30    #设置连接smtp server的超时时间</li>
<li style="padding:0px;border:0px;font-size:100%;font-style:inherit;box-sizing:inherit;outline:0px;font-family:inherit;vertical-align:baseline;margin:0px 35px 0px 50px;line-height:18px;list-style:decimal;border-left:1px dashed rgb(204, 204, 204);padding-left:10px;">   router_id LVS_DEVEL        #表示运行keepalived服务器的一个标识。发邮件时显示在邮件主题的信息</li>
<li style="padding:0px;border:0px;font-size:100%;font-style:inherit;box-sizing:inherit;outline:0px;font-family:inherit;vertical-align:baseline;margin:0px 35px 0px 50px;line-height:18px;list-style:decimal;border-left:1px dashed rgb(204, 204, 204);padding-left:10px;">}</li>
<li style="padding:0px;border:0px;font-size:100%;font-style:inherit;box-sizing:inherit;outline:0px;font-family:inherit;vertical-align:baseline;margin:0px 35px 0px 50px;line-height:18px;list-style:decimal;border-left:1px dashed rgb(204, 204, 204);padding-left:10px;"></li>
<li style="padding:0px;border:0px;font-size:100%;font-style:inherit;box-sizing:inherit;outline:0px;font-family:inherit;vertical-align:baseline;margin:0px 35px 0px 50px;line-height:18px;list-style:decimal;border-left:1px dashed rgb(204, 204, 204);padding-left:10px;">vrrp_script chk_nginx {</li>
<li style="padding:0px;border:0px;font-size:100%;font-style:inherit;box-sizing:inherit;outline:0px;font-family:inherit;vertical-align:baseline;margin:0px 35px 0px 50px;line-height:18px;list-style:decimal;border-left:1px dashed rgb(204, 204, 204);padding-left:10px;">    script &quot;/usr/local/keepalived/sbin/check_nginx.sh&quot;   #该脚本检测ngnix的运行状态，并在nginx进程不存在时尝试重新启动ngnix，如果启动失败则停止keepalived，准备让其它机器接管。</li>
<li style="padding:0px;border:0px;font-size:100%;font-style:inherit;box-sizing:inherit;outline:0px;font-family:inherit;vertical-align:baseline;margin:0px 35px 0px 50px;line-height:18px;list-style:decimal;border-left:1px dashed rgb(204, 204, 204);padding-left:10px;">    interval 2              #每2s检测一次</li>
<li style="padding:0px;border:0px;font-size:100%;font-style:inherit;box-sizing:inherit;outline:0px;font-family:inherit;vertical-align:baseline;margin:0px 35px 0px 50px;line-height:18px;list-style:decimal;border-left:1px dashed rgb(204, 204, 204);padding-left:10px;">    weight 2                #检测失败（脚本返回非0）则优先级2</li>
<li style="padding:0px;border:0px;font-size:100%;font-style:inherit;box-sizing:inherit;outline:0px;font-family:inherit;vertical-align:baseline;margin:0px 35px 0px 50px;line-height:18px;list-style:decimal;border-left:1px dashed rgb(204, 204, 204);padding-left:10px;">}</li>
<li style="padding:0px;border:0px;font-size:100%;font-style:inherit;box-sizing:inherit;outline:0px;font-family:inherit;vertical-align:baseline;margin:0px 35px 0px 50px;line-height:18px;list-style:decimal;border-left:1px dashed rgb(204, 204, 204);padding-left:10px;"></li>
<li style="padding:0px;border:0px;font-size:100%;font-style:inherit;box-sizing:inherit;outline:0px;font-family:inherit;vertical-align:baseline;margin:0px 35px 0px 50px;line-height:18px;list-style:decimal;border-left:1px dashed rgb(204, 204, 204);padding-left:10px;">vrrp_instance VI_1 {</li>
<li style="padding:0px;border:0px;font-size:100%;font-style:inherit;box-sizing:inherit;outline:0px;font-family:inherit;vertical-align:baseline;margin:0px 35px 0px 50px;line-height:18px;list-style:decimal;border-left:1px dashed rgb(204, 204, 204);padding-left:10px;">    state BACKUP            #指定keepalived的角色，MASTER表示此主机是主服务器，BACKUP表示此主机是备用服务器</li>
<li style="padding:0px;border:0px;font-size:100%;font-style:inherit;box-sizing:inherit;outline:0px;font-family:inherit;vertical-align:baseline;margin:0px 35px 0px 50px;line-height:18px;list-style:decimal;border-left:1px dashed rgb(204, 204, 204);padding-left:10px;">    interface eth0          #指定HA监测网络的接口</li>
<li style="padding:0px;border:0px;font-size:100%;font-style:inherit;box-sizing:inherit;outline:0px;font-family:inherit;vertical-align:baseline;margin:0px 35px 0px 50px;line-height:18px;list-style:decimal;border-left:1px dashed rgb(204, 204, 204);padding-left:10px;">    virtual_router_id 55    #虚拟路由标识，这个标识是一个数字，同一个vrrp实例使用唯一的标识。即同一vrrp_instance下，MASTER和BACKUP必须是一致的</li>
<li style="padding:0px;border:0px;font-size:100%;font-style:inherit;box-sizing:inherit;outline:0px;font-family:inherit;vertical-align:baseline;margin:0px 35px 0px 50px;line-height:18px;list-style:decimal;border-left:1px dashed rgb(204, 204, 204);padding-left:10px;">    priority 50             #定义优先级，数字越大，优先级越高，在同一个vrrp_instance下，MASTER的优先级必须大于BACKUP的优先级</li>
<li style="padding:0px;border:0px;font-size:100%;font-style:inherit;box-sizing:inherit;outline:0px;font-family:inherit;vertical-align:baseline;margin:0px 35px 0px 50px;line-height:18px;list-style:decimal;border-left:1px dashed rgb(204, 204, 204);padding-left:10px;">    advert_int 1            #设定MASTER与BACKUP负载均衡器之间同步检查的时间间隔，单位是秒</li>
<li style="padding:0px;border:0px;font-size:100%;font-style:inherit;box-sizing:inherit;outline:0px;font-family:inherit;vertical-align:baseline;margin:0px 35px 0px 50px;line-height:18px;list-style:decimal;border-left:1px dashed rgb(204, 204, 204);padding-left:10px;">    nopreempt               #设置nopreempt防止抢占资源，只生效BACKUP节点</li>
<li style="padding:0px;border:0px;font-size:100%;font-style:inherit;box-sizing:inherit;outline:0px;font-family:inherit;vertical-align:baseline;margin:0px 35px 0px 50px;line-height:18px;list-style:decimal;border-left:1px dashed rgb(204, 204, 204);padding-left:10px;">    authentication {        #设置验证类型和密码</li>
<li style="padding:0px;border:0px;font-size:100%;font-style:inherit;box-sizing:inherit;outline:0px;font-family:inherit;vertical-align:baseline;margin:0px 35px 0px 50px;line-height:18px;list-style:decimal;border-left:1px dashed rgb(204, 204, 204);padding-left:10px;">        auth_type PASS      #设置验证类型，主要有PASS和AH两种</li>
<li style="padding:0px;border:0px;font-size:100%;font-style:inherit;box-sizing:inherit;outline:0px;font-family:inherit;vertical-align:baseline;margin:0px 35px 0px 50px;line-height:18px;list-style:decimal;border-left:1px dashed rgb(204, 204, 204);padding-left:10px;">        auth_pass linuxeye  #设置验证密码，在同一个vrrp_instance下，MASTER与BACKUP必须使用相同的密码才能正常通信</li>
<li style="padding:0px;border:0px;font-size:100%;font-style:inherit;box-sizing:inherit;outline:0px;font-family:inherit;vertical-align:baseline;margin:0px 35px 0px 50px;line-height:18px;list-style:decimal;border-left:1px dashed rgb(204, 204, 204);padding-left:10px;">    }</li>
<li style="padding:0px;border:0px;font-size:100%;font-style:inherit;box-sizing:inherit;outline:0px;font-family:inherit;vertical-align:baseline;margin:0px 35px 0px 50px;line-height:18px;list-style:decimal;border-left:1px dashed rgb(204, 204, 204);padding-left:10px;">    virtual_ipaddress {     #设置虚拟IP地址，可以设置多个虚拟IP地址，每行一个</li>
<li style="padding:0px;border:0px;font-size:100%;font-style:inherit;box-sizing:inherit;outline:0px;font-family:inherit;vertical-align:baseline;margin:0px 35px 0px 50px;line-height:18px;list-style:decimal;border-left:1px dashed rgb(204, 204, 204);padding-left:10px;">        10.0.0.62</li>
<li style="padding:0px;border:0px;font-size:100%;font-style:inherit;box-sizing:inherit;outline:0px;font-family:inherit;vertical-align:baseline;margin:0px 35px 0px 50px;line-height:18px;list-style:decimal;border-left:1px dashed rgb(204, 204, 204);padding-left:10px;">    }</li>
<li style="padding:0px;border:0px;font-size:100%;font-style:inherit;box-sizing:inherit;outline:0px;font-family:inherit;vertical-align:baseline;margin:0px 35px 0px 50px;line-height:18px;list-style:decimal;border-left:1px dashed rgb(204, 204, 204);padding-left:10px;">    track_script {</li>
<li style="padding:0px;border:0px;font-size:100%;font-style:inherit;box-sizing:inherit;outline:0px;font-family:inherit;vertical-align:baseline;margin:0px 35px 0px 50px;line-height:18px;list-style:decimal;border-left:1px dashed rgb(204, 204, 204);padding-left:10px;">        chk_nginx           #引用VRRP脚本，即在 vrrp_script 部分指定的名字。定期运行它们来改变优先级，并最终引发主备切换。</li>
<li style="padding:0px;border:0px;font-size:100%;font-style:inherit;box-sizing:inherit;outline:0px;font-family:inherit;vertical-align:baseline;margin:0px 35px 0px 50px;line-height:18px;list-style:decimal;border-left:1px dashed rgb(204, 204, 204);padding-left:10px;">    }</li>
<li style="padding:0px;border:0px;font-size:100%;font-style:inherit;box-sizing:inherit;outline:0px;font-family:inherit;vertical-align:baseline;margin:0px 35px 0px 50px;line-height:18px;list-style:decimal;border-left:1px dashed rgb(204, 204, 204);padding-left:10px;">}</li>
</ol>
</div>
<p style="padding:0px;border:0px;font-size:100%;font-style:inherit;box-sizing:inherit;outline:0px;font-family:inherit;vertical-align:baseline;margin:0px 0px 5px;word-wrap:break-word;word-break:break-all;text-indent:2em;">检测脚本，vi /usr/local/keepalived/sbin/check_nginx.sh</p>
<div style="vertical-align:baseline;border:1px dashed rgb(204, 204, 204);font-size:100%;font-style:inherit;margin:10px auto;outline:0px;padding:5px;font-family:inherit;box-sizing:inherit;background:rgb(255, 255, 255);width:96%;word-break:break-all;white-space:normal;overflow:auto;">
<ol start="1" style="padding:2px;border:0px;font-size:100%;font-style:inherit;list-style:none;outline:0px;font-family:inherit;vertical-align:baseline;box-sizing:inherit;margin:0px 0px 1px -15px;word-wrap:break-word;word-break:break-all;color:rgb(102, 102, 102);">
<li style="padding:0px;border:0px;font-size:100%;font-style:inherit;box-sizing:inherit;outline:0px;font-family:inherit;vertical-align:baseline;margin:0px 35px 0px 50px;line-height:18px;list-style:decimal;border-left:1px dashed rgb(204, 204, 204);padding-left:10px;">#!/bin/bash</li>
<li style="padding:0px;border:0px;font-size:100%;font-style:inherit;box-sizing:inherit;outline:0px;font-family:inherit;vertical-align:baseline;margin:0px 35px 0px 50px;line-height:18px;list-style:decimal;border-left:1px dashed rgb(204, 204, 204);padding-left:10px;">if [ &quot;$(ps -ef | grep &quot;nginx: master process&quot;| grep -v grep )&quot; == &quot;&quot; ];then</li>
<li style="padding:0px;border:0px;font-size:100%;font-style:inherit;box-sizing:inherit;outline:0px;font-family:inherit;vertical-align:baseline;margin:0px 35px 0px 50px;line-height:18px;list-style:decimal;border-left:1px dashed rgb(204, 204, 204);padding-left:10px;">    #echo 1</li>
<li style="padding:0px;border:0px;font-size:100%;font-style:inherit;box-sizing:inherit;outline:0px;font-family:inherit;vertical-align:baseline;margin:0px 35px 0px 50px;line-height:18px;list-style:decimal;border-left:1px dashed rgb(204, 204, 204);padding-left:10px;">    /etc/init.d/nginx start</li>
<li style="padding:0px;border:0px;font-size:100%;font-style:inherit;box-sizing:inherit;outline:0px;font-family:inherit;vertical-align:baseline;margin:0px 35px 0px 50px;line-height:18px;list-style:decimal;border-left:1px dashed rgb(204, 204, 204);padding-left:10px;">    sleep 5</li>
<li style="padding:0px;border:0px;font-size:100%;font-style:inherit;box-sizing:inherit;outline:0px;font-family:inherit;vertical-align:baseline;margin:0px 35px 0px 50px;line-height:18px;list-style:decimal;border-left:1px dashed rgb(204, 204, 204);padding-left:10px;"></li>
<li style="padding:0px;border:0px;font-size:100%;font-style:inherit;box-sizing:inherit;outline:0px;font-family:inherit;vertical-align:baseline;margin:0px 35px 0px 50px;line-height:18px;list-style:decimal;border-left:1px dashed rgb(204, 204, 204);padding-left:10px;">    if [ &quot;$(ps -ef | grep &quot;nginx: master process&quot;| grep -v grep )&quot; == &quot;&quot; ];then</li>
<li style="padding:0px;border:0px;font-size:100%;font-style:inherit;box-sizing:inherit;outline:0px;font-family:inherit;vertical-align:baseline;margin:0px 35px 0px 50px;line-height:18px;list-style:decimal;border-left:1px dashed rgb(204, 204, 204);padding-left:10px;">        /etc/init.d/keepalived stop</li>
<li style="padding:0px;border:0px;font-size:100%;font-style:inherit;box-sizing:inherit;outline:0px;font-family:inherit;vertical-align:baseline;margin:0px 35px 0px 50px;line-height:18px;list-style:decimal;border-left:1px dashed rgb(204, 204, 204);padding-left:10px;">        #echo 2</li>
<li style="padding:0px;border:0px;font-size:100%;font-style:inherit;box-sizing:inherit;outline:0px;font-family:inherit;vertical-align:baseline;margin:0px 35px 0px 50px;line-height:18px;list-style:decimal;border-left:1px dashed rgb(204, 204, 204);padding-left:10px;">    fi</li>
<li style="padding:0px;border:0px;font-size:100%;font-style:inherit;box-sizing:inherit;outline:0px;font-family:inherit;vertical-align:baseline;margin:0px 35px 0px 50px;line-height:18px;list-style:decimal;border-left:1px dashed rgb(204, 204, 204);padding-left:10px;">fi</li>
</ol>
</div>
<p style="padding:0px;border:0px;font-size:100%;font-style:inherit;box-sizing:inherit;outline:0px;font-family:inherit;vertical-align:baseline;margin:0px 0px 5px;word-wrap:break-word;word-break:break-all;text-indent:2em;">脚本加上可执行权限</p>
<div style="vertical-align:baseline;border:1px dashed rgb(204, 204, 204);font-size:100%;font-style:inherit;margin:10px auto;outline:0px;padding:5px;font-family:inherit;box-sizing:inherit;background:rgb(255, 255, 255);width:96%;word-break:break-all;white-space:normal;overflow:auto;">
<ol start="1" style="padding:2px;border:0px;font-size:100%;font-style:inherit;list-style:none;outline:0px;font-family:inherit;vertical-align:baseline;box-sizing:inherit;margin:0px 0px 1px -15px;word-wrap:break-word;word-break:break-all;color:rgb(102, 102, 102);">
<li style="padding:0px;border:0px;font-size:100%;font-style:inherit;box-sizing:inherit;outline:0px;font-family:inherit;vertical-align:baseline;margin:0px 35px 0px 50px;line-height:18px;list-style:decimal;border-left:1px dashed rgb(204, 204, 204);padding-left:10px;">chmod +x /usr/local/keepalived/sbin/check_nginx.sh</li>
</ol>
</div>
<span style="padding:0px;border:0px;font-size:100%;font-style:inherit;box-sizing:inherit;outline:0px;font-family:inherit;vertical-align:baseline;margin:8px -21px;float:left;height:30px;border-left:5px solid rgb(47, 136, 154);"></span><h4 style="outline:0px;border:0px;box-sizing:inherit;font-style:inherit;margin:0px;font-family:inherit;vertical-align:baseline;padding:70px 30px 5px;font-size:1.6rem;line-height:280%;margin-top:-70px;">验证</h4>
<div style="vertical-align:baseline;border:1px dashed rgb(204, 204, 204);font-size:100%;font-style:inherit;margin:10px auto;outline:0px;padding:5px;font-family:inherit;box-sizing:inherit;background:rgb(255, 255, 255);width:96%;word-break:break-all;white-space:normal;overflow:auto;">
<ol start="1" style="padding:2px;border:0px;font-size:100%;font-style:inherit;list-style:none;outline:0px;font-family:inherit;vertical-align:baseline;box-sizing:inherit;margin:0px 0px 1px -15px;word-wrap:break-word;word-break:break-all;color:rgb(102, 102, 102);">
<li style="padding:0px;border:0px;font-size:100%;font-style:inherit;box-sizing:inherit;outline:0px;font-family:inherit;vertical-align:baseline;margin:0px 35px 0px 50px;line-height:18px;list-style:decimal;border-left:1px dashed rgb(204, 204, 204);padding-left:10px;">service keepalived start  #启动Nginx-Master</li>
</ol>
</div>
<div style="vertical-align:baseline;border:1px dashed rgb(204, 204, 204);font-size:100%;font-style:inherit;margin:10px auto;outline:0px;padding:5px;font-family:inherit;box-sizing:inherit;background:rgb(255, 255, 255);width:96%;word-break:break-all;white-space:normal;overflow:auto;">
<ol start="1" style="padding:2px;border:0px;font-size:100%;font-style:inherit;list-style:none;outline:0px;font-family:inherit;vertical-align:baseline;box-sizing:inherit;margin:0px 0px 1px -15px;word-wrap:break-word;word-break:break-all;color:rgb(102, 102, 102);">
<li style="padding:0px;border:0px;font-size:100%;font-style:inherit;box-sizing:inherit;outline:0px;font-family:inherit;vertical-align:baseline;margin:0px 35px 0px 50px;line-height:18px;list-style:decimal;border-left:1px dashed rgb(204, 204, 204);padding-left:10px;">service keepalived start  #启动Nginx-Backup</li>
</ol>
</div>
<div style="vertical-align:baseline;border:1px dashed rgb(204, 204, 204);font-size:100%;font-style:inherit;margin:10px auto;outline:0px;padding:5px;font-family:inherit;box-sizing:inherit;background:rgb(255, 255, 255);width:96%;word-break:break-all;white-space:normal;overflow:auto;">
<ol start="1" style="padding:2px;border:0px;font-size:100%;font-style:inherit;list-style:none;outline:0px;font-family:inherit;vertical-align:baseline;box-sizing:inherit;margin:0px 0px 1px -15px;word-wrap:break-word;word-break:break-all;color:rgb(102, 102, 102);">
<li style="padding:0px;border:0px;font-size:100%;font-style:inherit;box-sizing:inherit;outline:0px;font-family:inherit;vertical-align:baseline;margin:0px 35px 0px 50px;line-height:18px;list-style:decimal;border-left:1px dashed rgb(204, 204, 204);padding-left:10px;">ip addr  #2台服务器分别执行，绑定虚拟IP在Nginx-Master</li>
</ol>
</div>
<div style="vertical-align:baseline;border:1px dashed rgb(204, 204, 204);font-size:100%;font-style:inherit;margin:10px auto;outline:0px;padding:5px;font-family:inherit;box-sizing:inherit;background:rgb(255, 255, 255);width:96%;word-break:break-all;white-space:normal;overflow:auto;">
<ol start="1" style="padding:2px;border:0px;font-size:100%;font-style:inherit;list-style:none;outline:0px;font-family:inherit;vertical-align:baseline;box-sizing:inherit;margin:0px 0px 1px -15px;word-wrap:break-word;word-break:break-all;color:rgb(102, 102, 102);">
<li style="padding:0px;border:0px;font-size:100%;font-style:inherit;box-sizing:inherit;outline:0px;font-family:inherit;vertical-align:baseline;margin:0px 35px 0px 50px;line-height:18px;list-style:decimal;border-left:1px dashed rgb(204, 204, 204);padding-left:10px;">service keepalived stop  #停止Nginx-Backup</li>
</ol>
</div>
<div style="vertical-align:baseline;border:1px dashed rgb(204, 204, 204);font-size:100%;font-style:inherit;margin:10px auto;outline:0px;padding:5px;font-family:inherit;box-sizing:inherit;background:rgb(255, 255, 255);width:96%;word-break:break-all;white-space:normal;overflow:auto;">
<ol start="1" style="padding:2px;border:0px;font-size:100%;font-style:inherit;list-style:none;outline:0px;font-family:inherit;vertical-align:baseline;box-sizing:inherit;margin:0px 0px 1px -15px;word-wrap:break-word;word-break:break-all;color:rgb(102, 102, 102);">
<li style="padding:0px;border:0px;font-size:100%;font-style:inherit;box-sizing:inherit;outline:0px;font-family:inherit;vertical-align:baseline;margin:0px 35px 0px 50px;line-height:18px;list-style:decimal;border-left:1px dashed rgb(204, 204, 204);padding-left:10px;">ip addr  #2台服务器分别执行，绑定虚拟IP在Nginx-Backup</li>
</ol>
</div>
<div style="vertical-align:baseline;border:1px dashed rgb(204, 204, 204);font-size:100%;font-style:inherit;margin:10px auto;outline:0px;padding:5px;font-family:inherit;box-sizing:inherit;background:rgb(255, 255, 255);width:96%;word-break:break-all;white-space:normal;overflow:auto;">
<ol start="1" style="padding:2px;border:0px;font-size:100%;font-style:inherit;list-style:none;outline:0px;font-family:inherit;vertical-align:baseline;box-sizing:inherit;margin:0px 0px 1px -15px;word-wrap:break-word;word-break:break-all;color:rgb(102, 102, 102);">
<li style="padding:0px;border:0px;font-size:100%;font-style:inherit;box-sizing:inherit;outline:0px;font-family:inherit;vertical-align:baseline;margin:0px 35px 0px 50px;line-height:18px;list-style:decimal;border-left:1px dashed rgb(204, 204, 204);padding-left:10px;">service keepalived start  #再启动Nginx-Backup</li>
</ol>
</div>
<div style="vertical-align:baseline;border:1px dashed rgb(204, 204, 204);font-size:100%;font-style:inherit;margin:10px auto;outline:0px;padding:5px;font-family:inherit;box-sizing:inherit;background:rgb(255, 255, 255);width:96%;word-break:break-all;white-space:normal;overflow:auto;">
<ol start="1" style="padding:2px;border:0px;font-size:100%;font-style:inherit;list-style:none;outline:0px;font-family:inherit;vertical-align:baseline;box-sizing:inherit;margin:0px 0px 1px -15px;word-wrap:break-word;word-break:break-all;color:rgb(102, 102, 102);">
<li style="padding:0px;border:0px;font-size:100%;font-style:inherit;box-sizing:inherit;outline:0px;font-family:inherit;vertical-align:baseline;margin:0px 35px 0px 50px;line-height:18px;list-style:decimal;border-left:1px dashed rgb(204, 204, 204);padding-left:10px;">ip addr  #2台服务器分别执行，绑定虚拟IP在Nginx-Master</li>
</ol>
</div>
<p style="padding:0px;border:0px;font-size:100%;font-style:inherit;box-sizing:inherit;outline:0px;font-family:inherit;vertical-align:baseline;margin:0px 0px 5px;word-wrap:break-word;word-break:break-all;text-indent:2em;">上述切换默认测试会导致的master和backup之间来回切换</p>
<p style="padding:0px;border:0px;font-size:100%;font-style:inherit;box-sizing:inherit;outline:0px;font-family:inherit;vertical-align:baseline;margin:0px 0px 5px;word-wrap:break-word;word-break:break-all;text-indent:2em;">通常如果master服务死掉后backup会变成master，但是当master服务又好了的时候master此时会抢占VIP，这样就会发生两次切换对业务繁忙的网站来说是不好的。我们可以在配置文件加入nopreempt非抢占，但是这个参数只能用于state为BACKUP，故我们在用HA的时候最好MASTER和backup的state都设置成BACKUP让其通过priority来竞争。</p>
<span style="padding:0px;border:0px;font-size:100%;font-style:inherit;box-sizing:inherit;outline:0px;font-family:inherit;vertical-align:baseline;margin:8px -21px;float:left;height:30px;border-left:5px solid rgb(47, 136, 154);"></span><h4 style="outline:0px;border:0px;box-sizing:inherit;font-style:inherit;margin:0px;font-family:inherit;vertical-align:baseline;padding:70px 30px 5px;font-size:1.6rem;line-height:280%;margin-top:-70px;">拓展</h4>
<p style="padding:0px;border:0px;font-size:100%;font-style:inherit;box-sizing:inherit;outline:0px;font-family:inherit;vertical-align:baseline;margin:0px 0px 5px;word-wrap:break-word;word-break:break-all;text-indent:2em;">假设我要重装这2台服务器，但是过程不容许丢一个包，通常情况下先替换backup，把master停止，让vip漂移只backup，替换master，但是在vip漂移过程可能会有丢2个包，如果避免丢包？</p>
<p style="padding:0px;border:0px;font-size:100%;font-style:inherit;box-sizing:inherit;outline:0px;font-family:inherit;vertical-align:baseline;margin:0px 0px 5px;word-wrap:break-word;word-break:break-all;text-indent:2em;">方法：我们可以在master替换之前，利用iptables将数据包转发到backup，再停止master keepalived</p>
<div style="vertical-align:baseline;border:1px dashed rgb(204, 204, 204);font-size:100%;font-style:inherit;margin:10px auto;outline:0px;padding:5px;font-family:inherit;box-sizing:inherit;background:rgb(255, 255, 255);width:96%;word-break:break-all;white-space:normal;overflow:auto;">
<ol start="1" style="padding:2px;border:0px;font-size:100%;font-style:inherit;list-style:none;outline:0px;font-family:inherit;vertical-align:baseline;box-sizing:inherit;margin:0px 0px 1px -15px;word-wrap:break-word;word-break:break-all;color:rgb(102, 102, 102);">
<li style="padding:0px;border:0px;font-size:100%;font-style:inherit;box-sizing:inherit;outline:0px;font-family:inherit;vertical-align:baseline;margin:0px 35px 0px 50px;line-height:18px;list-style:decimal;border-left:1px dashed rgb(204, 204, 204);padding-left:10px;">iptables -F</li>
<li style="padding:0px;border:0px;font-size:100%;font-style:inherit;box-sizing:inherit;outline:0px;font-family:inherit;vertical-align:baseline;margin:0px 35px 0px 50px;line-height:18px;list-style:decimal;border-left:1px dashed rgb(204, 204, 204);padding-left:10px;">iptables -t nat -I PREROUTING -i eth0 -j DNAT --to-destination 10.0.0.61</li>
<li style="padding:0px;border:0px;font-size:100%;font-style:inherit;box-sizing:inherit;outline:0px;font-family:inherit;vertical-align:baseline;margin:0px 35px 0px 50px;line-height:18px;list-style:decimal;border-left:1px dashed rgb(204, 204, 204);padding-left:10px;">iptables -t nat -I POSTROUTING -o eth0 -j MASQUERADE</li>
</ol>
</div>
<p style="padding:0px;border:0px;font-size:100%;font-style:inherit;box-sizing:inherit;outline:0px;font-family:inherit;vertical-align:baseline;margin:0px 0px 5px;word-wrap:break-word;word-break:break-all;text-indent:2em;text-align:right;"><strong style="box-sizing:inherit;border:0px;font-family:inherit;font-size:100%;font-style:inherit;margin:0px;outline:0px;padding:0px;vertical-align:baseline;">Thu Jun 16 19:32:57 CST 2016</strong></p>
			</div>

						
									
						
				
									<div style="box-sizing:inherit;border:0px;font-family:inherit;font-size:100%;font-style:inherit;margin:0px;outline:0px;padding:0px;vertical-align:baseline;clear:both;"></div>
<div style="box-sizing:inherit;border:0px;font-family:inherit;font-size:100%;font-style:inherit;outline:0px;padding:0px;vertical-align:baseline;margin:15px auto 80px;position:relative;">
	<div style="outline:0px;border:0px;font-size:100%;font-style:inherit;box-sizing:inherit;font-family:inherit;padding:0px;vertical-align:baseline;margin:0px auto;position:relative;width:243px;">
		<span style="box-sizing:inherit;border:0px;font-family:inherit;font-size:100%;font-style:inherit;margin:0px;outline:0px;padding:0px;vertical-align:baseline;float:left;">
	         <a href="#" style="color:rgb(255, 255, 255);border:0px;font-size:100%;font-style:inherit;margin:0px;outline:0px;padding:0px;vertical-align:baseline;box-sizing:inherit;font-family:inherit;text-decoration:none;-webkit-tap-highlight-color:rgba(255, 0, 0, 0);line-height:35px;text-align:center;border-radius:2px;background:rgb(255, 68, 0);width:120px;display:block;" title="我赞"><i style="box-sizing:inherit;border:0px;vertical-align:baseline;padding:0px;outline:0px;font-variant:normal;-webkit-font-smoothing:antialiased;font-size:inherit;font-family:FontAwesome;text-rendering:auto;display:inline-block;line-height:1;font-weight:normal;font-stretch:normal;font-style:normal;color:rgb(255, 255, 255);margin:0px 5px 0px 0px;"><span style="font-family:FontAwesome;font-size:inherit;font-style:normal;color:rgb(255, 255, 255);font-variant:normal;font-weight:normal;line-height:1;"></span></i>赞 <i style="box-sizing:inherit;border:0px;font-family:inherit;font-size:100%;outline:0px;padding:0px;vertical-align:baseline;font-style:normal;margin:0px 5px 0px 0px;color:rgb(255, 255, 255);">
	            11</i>
	        </a>
		</span>
		<span style="box-sizing:inherit;border:0px;font-family:inherit;font-size:100%;font-style:inherit;margin:0px;outline:0px;padding:0px;vertical-align:baseline;float:left;">
							<span style="outline:0px;border:0px;font-size:100%;font-style:inherit;margin:0px;font-family:inherit;padding:0px;vertical-align:baseline;box-sizing:inherit;cursor:pointer;float:left;">
				<span style="outline:0px;border:0px;font-size:100%;font-style:inherit;margin:0px;font-family:inherit;padding:0px;vertical-align:baseline;box-sizing:inherit;height:37px;float:left;"><a style="-webkit-tap-highlight-color:rgba(255, 0, 0, 0);border:4px solid rgb(255, 255, 255);font-size:16px;font-style:inherit;margin:0px;outline:0px;padding:0px;vertical-align:baseline;box-sizing:inherit;color:rgb(255, 255, 255);text-decoration:none;font-family:inherit;line-height:43px;text-align:center;border-radius:40px;position:absolute;background:rgb(122, 185, 81);left:95px;top:-7px;width:50px;height:50px;font-weight:600;display:block;" title="赞助本站">赏</a></span></span>
					</span>
		<span style="box-sizing:inherit;border:0px;font-family:inherit;font-size:100%;font-style:inherit;margin:0px;outline:0px;padding:0px;vertical-align:baseline;float:left;">
				<span style="box-sizing:inherit;border:0px;font-family:inherit;font-size:100%;font-style:inherit;margin:0px;outline:0px;padding:0px;vertical-align:baseline;float:left;"><a href="#" style="color:rgb(255, 255, 255);border:0px;font-size:100%;font-style:inherit;margin:0px;outline:0px;padding:0px;vertical-align:baseline;box-sizing:inherit;font-family:inherit;text-decoration:none;-webkit-tap-highlight-color:rgba(255, 0, 0, 0);line-height:35px;text-align:center;border-radius:2px;background:rgb(236, 184, 66);width:120px;display:block;" title="分享"><i style="box-sizing:inherit;border:0px;vertical-align:baseline;padding:0px;outline:0px;font-variant:normal;-webkit-font-smoothing:antialiased;font-size:inherit;font-family:FontAwesome;text-rendering:auto;display:inline-block;line-height:1;font-weight:normal;font-stretch:normal;font-style:normal;color:rgb(255, 255, 255);margin:0px 5px 0px 0px;"><span style="font-family:FontAwesome;font-size:inherit;font-style:normal;color:rgb(255, 255, 255);font-variant:normal;font-weight:normal;line-height:1;"></span></i>分享</a></span>
						</span>
		<div style="box-sizing:inherit;border:0px;font-family:inherit;font-size:100%;font-style:inherit;margin:0px;outline:0px;padding:0px;vertical-align:baseline;clear:both;"></div>
	</div>
</div>				
			<div style="box-sizing:inherit;border:0px;font-family:inherit;font-size:100%;font-style:inherit;margin:0px;outline:0px;padding:0px;vertical-align:baseline;display:block;">
				<ul style="padding:0px;border:0px;font-size:100%;font-style:inherit;margin:0px;outline:0px;font-family:inherit;vertical-align:baseline;box-sizing:inherit;list-style:none;position:absolute;top:15px;right:15px;"><li style="box-sizing:inherit;border:0px;font-family:inherit;font-size:100%;font-style:inherit;margin:0px;outline:0px;padding:0px;vertical-align:baseline;float:left;"><a href="https://blog.linuxeye.com/447.html#comments" rel="external nofollow" style="vertical-align:baseline;border:1px solid rgb(221, 221, 221);font-size:100%;font-style:inherit;margin:0px 5px 0px 0px;outline:0px;padding:0px 8px;font-family:inherit;box-sizing:inherit;color:rgb(153, 153, 153);text-decoration:none;-webkit-tap-highlight-color:rgba(255, 0, 0, 0);line-height:26px;display:block;border-radius:2px;"><i style="box-sizing:inherit;border:0px;vertical-align:baseline;padding:0px;margin:0px;outline:0px;font-style:normal;font-size:inherit;font-family:FontAwesome;display:inline-block;font-variant:normal;font-weight:normal;font-stretch:normal;line-height:1;text-rendering:auto;-webkit-font-smoothing:antialiased;"><span style="font-family:FontAwesome;font-size:inherit;font-style:normal;font-variant:normal;font-weight:normal;line-height:1;"></span></i> 1 </a></li></ul><ul style="list-style:none;border:1px solid rgb(221, 221, 221);font-size:100%;font-style:inherit;margin:0px;outline:0px;padding:0px 0px 1px;vertical-align:baseline;box-sizing:inherit;font-family:inherit;position:absolute;top:15px;left:20px;line-height:24px;width:40px;text-align:center;cursor:pointer;border-radius:2px;">A+</ul><div style="box-sizing:inherit;border:0px;font-size:100%;font-style:inherit;margin:0px;outline:0px;font-family:inherit;vertical-align:baseline;padding:10px 0px;position:absolute;background:rgb(248, 248, 248);bottom:-1px;left:0px;width:100%;border-bottom:1px solid rgb(221, 221, 221);border-radius:0px 0px 2px 2px;"><div style="box-sizing:inherit;border:0px;font-family:inherit;font-size:100%;font-style:inherit;margin:0px;outline:0px;vertical-align:baseline;padding:0px 20px;">发布日期：2016年06月16日  所属分类：<a href="https://blog.linuxeye.com/category/linux/" rel="category tag" style="padding:0px;border:0px;font-size:100%;font-style:inherit;margin:0px;outline:0px;font-family:inherit;vertical-align:baseline;box-sizing:inherit;color:rgb(68, 68, 68);text-decoration:none;-webkit-tap-highlight-color:rgba(255, 0, 0, 0);">Linux</a></div></div>			</div>

				<div style="box-sizing:inherit;border:0px;font-family:inherit;font-size:100%;font-style:inherit;margin:0px;outline:0px;padding:0px;vertical-align:baseline;clear:both;"></div>
	</div>

	</div></div></span></div></div></div></div></div></div><br/></div></span>
</div></body></html> 