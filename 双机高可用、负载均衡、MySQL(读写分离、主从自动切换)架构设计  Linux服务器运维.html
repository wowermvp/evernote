<html>
<head>
  <title>双机高可用、负载均衡、MySQL(读写分离、主从自动切换)架构设计 | Linux服务器运维日志</title>
  <basefont face="宋体" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="YXBJ Windows/600718 (zh-CN, DDL); Windows/10.0.0 (Win64);"/>
  <style>
    body, td {
      font-family: 宋体;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="1862"/>
<h1>双机高可用、负载均衡、MySQL(读写分离、主从自动切换)架构设计 | Linux服务器运维日志</h1>

<div><span><br/><div style="position: relative; max-width: 728px;"><div style="font-size: 16px"><div style="list-style:none;font-family:微软雅黑;background:transparent;"><div style="list-style:none;font-family:微软雅黑, 宋体, Tahoma, Verdana, Geneva, sans-serif;background:url(https://www.centos.bz/wp-content/themes/forigi2/images/bodybg.png) rgb(244, 244, 244);font-style:normal;font-variant:normal;font-weight:normal;font-stretch:normal;font-size:12px;line-height:normal;color:rgb(34, 34, 34);"><div style="list-style:none;font-family:微软雅黑;background:transparent;"><div style="list-style:none;font-family:微软雅黑;background:transparent;"><div style="list-style:none;font-family:微软雅黑;background:transparent;"><div style="list-style:none;font-family:微软雅黑;background:transparent;"><div style="list-style:none;font-family:微软雅黑;background:rgb(255, 255, 255);line-height:22px;-webkit-box-shadow:rgb(221, 221, 221) 0px -1px 10px inset;box-shadow:rgb(221, 221, 221) 0px -1px 10px inset;"><div style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;height:auto;width:100%;border-bottom-width:1px;border-bottom-style:dashed;border-bottom-color:rgb(170, 170, 170);padding-bottom:2px;margin-bottom:6px;"><div style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;text-align:right;font-style:italic;float:right;width:28px;line-height:14px;font-size:12px;font-weight:700;"><a href="https://www.centos.bz/2014/12/ha-load-balance-mysql-master-slave-architecture/#comments" rel="nofollow" style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;color:rgb(164, 0, 0);text-decoration:none;float:right;" title="《双机高可用、负载均衡、MySQL(读写分离、主从自动切换)架构设计》上的评论">3+</a></div><div style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;text-align:center;margin-right:10px;float:left;text-shadow:none;width:46px;-webkit-box-shadow:rgb(102, 102, 110) 1px 1px 5px;box-shadow:rgb(102, 102, 110) 1px 1px 5px;"><div style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:rgb(243, 253, 250);font-size:24px;line-height:30px;color:rgb(112, 0, 0);font-weight:700;border-top-width:1px;border-right-width:1px;border-left-width:1px;border-style:solid solid none;border-top-color:rgb(226, 255, 241);border-right-color:rgb(226, 255, 241);border-left-color:rgb(226, 255, 241);">30</div><div style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:rgb(102, 102, 110);font-size:12px;line-height:16px;color:rgb(255, 255, 255);border-right-width:1px;border-bottom-width:1px;border-left-width:1px;border-style:none solid solid;border-right-color:rgb(85, 85, 94);border-bottom-color:rgb(85, 85, 94);border-left-color:rgb(85, 85, 94);"><span style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;">2014</span>.<span style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;">12</span></div></div><h1 style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;display:block;font-size:16px;line-height:20px;font-weight:700;color:rgb(164, 0, 0);padding-top:2px;letter-spacing:-1px;">双机高可用、负载均衡、MySQL(读写分离、主从自动切换)架构设计</h1><div style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;color:rgb(51, 51, 62);margin-top:5px;">    作者:<a href="https://www.centos.bz/author/admin/" rel="author" style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;color:rgb(34, 34, 34);text-decoration:none;" title="由朱 茂海发布">朱 茂海</a> /分类:<a href="https://www.centos.bz/category/high-availability/" rel="category tag" style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;color:rgb(34, 34, 34);text-decoration:none;" title="查看高可用/集群中的全部文章">高可用/集群</a> /Tag:<a href="https://www.centos.bz/tag/atlas/" rel="tag" style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;color:rgb(34, 34, 34);text-decoration:none;">atlas</a>, <a href="https://www.centos.bz/tag/keepalived/" rel="tag" style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;color:rgb(34, 34, 34);text-decoration:none;">keepalived</a>, <a href="https://www.centos.bz/tag/mysqlfailover/" rel="tag" style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;color:rgb(34, 34, 34);text-decoration:none;">mysqlfailover</a> </div><div style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;clear:both;height:0px;overflow:hidden;"></div></div><div style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;font-size:13px;"><div style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;padding-left:15px;"></div><div style="border:none;list-style:none;margin:0px;padding:3px 6px;font-family:微软雅黑;background:transparent;border-bottom-width:1px;border-bottom-style:dashed;border-bottom-color:rgb(170, 170, 170);margin-bottom:5px;"><div style="border:1px solid rgb(221, 221, 221);list-style:none;margin:0 0 10px 10px;padding:12px;font-family:微软雅黑;background:rgb(248, 248, 248);line-height:160%;max-width:30%;font-size:100%;position:relative;z-index:1000;float:right;"><div style="border:none;list-style:none;margin:0px 0px 3px;padding:0px;font-family:微软雅黑;background:transparent;font-size:120%;font-weight:bold;">文章目录</div><span style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;font-size:9pt;">[<a href="#" style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;color:rgb(164, 0, 0);text-decoration:none;">隐藏</a>]</span><ul style="border:none;list-style:none inside none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;font-size:100%;padding-left:20px;"><li style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;"><a href="https://www.centos.bz/2014/12/ha-load-balance-mysql-master-slave-architecture/#架构简介" style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;color:rgb(164, 0, 0);text-decoration:none;" title="架构简介"><span style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;">架构简介</span></a></li><li style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;"><a href="https://www.centos.bz/2014/12/ha-load-balance-mysql-master-slave-architecture/#架构要求" style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;color:rgb(164, 0, 0);text-decoration:none;" title="架构要求"><span style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;">架构要求</span></a></li><li style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;"><a href="https://www.centos.bz/2014/12/ha-load-balance-mysql-master-slave-architecture/#环境说明" style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;color:rgb(164, 0, 0);text-decoration:none;" title="环境说明"><span style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;">环境说明</span></a></li><li style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;"><a href="https://www.centos.bz/2014/12/ha-load-balance-mysql-master-slave-architecture/#hosts设置" style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;color:rgb(164, 0, 0);text-decoration:none;" title="hosts设置"><span style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;">hosts设置</span></a></li><li style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;"><a href="https://www.centos.bz/2014/12/ha-load-balance-mysql-master-slave-architecture/#Nginx PHP MySQL Memcached安装" style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;color:rgb(164, 0, 0);text-decoration:none;" title="Nginx PHP MySQL Memcached安装"><span style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;">Nginx PHP MySQL Memcached安装</span></a></li><li style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;"><a href="https://www.centos.bz/2014/12/ha-load-balance-mysql-master-slave-architecture/#解决session共享问题" style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;color:rgb(164, 0, 0);text-decoration:none;" title="解决session共享问题"><span style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;">解决session共享问题</span></a></li><li style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;"><a href="https://www.centos.bz/2014/12/ha-load-balance-mysql-master-slave-architecture/#Nginx配置" style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;color:rgb(164, 0, 0);text-decoration:none;" title="Nginx配置"><span style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;">Nginx配置</span></a><ul style="border:none;list-style:none inside none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;font-size:100%;padding-left:20px;"><li style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;"><a href="https://www.centos.bz/2014/12/ha-load-balance-mysql-master-slave-architecture/#Server1配置" style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;color:rgb(164, 0, 0);text-decoration:none;" title="Server1配置"><span style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;">Server1配置</span></a></li><li style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;"><a href="https://www.centos.bz/2014/12/ha-load-balance-mysql-master-slave-architecture/#Server2配置" style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;color:rgb(164, 0, 0);text-decoration:none;" title="Server2配置"><span style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;">Server2配置</span></a></li></ul></li><li style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;"><a href="https://www.centos.bz/2014/12/ha-load-balance-mysql-master-slave-architecture/#MySQL配置" style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;color:rgb(164, 0, 0);text-decoration:none;" title="MySQL配置"><span style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;">MySQL配置</span></a><ul style="border:none;list-style:none inside none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;font-size:100%;padding-left:20px;"><li style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;"><a href="https://www.centos.bz/2014/12/ha-load-balance-mysql-master-slave-architecture/#mysql util安装" style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;color:rgb(164, 0, 0);text-decoration:none;" title="mysql util安装"><span style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;">mysql util安装</span></a></li><li style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;"><a href="https://www.centos.bz/2014/12/ha-load-balance-mysql-master-slave-architecture/#mysql my.cnf配置" style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;color:rgb(164, 0, 0);text-decoration:none;" title="mysql my.cnf配置"><span style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;">mysql my.cnf配置</span></a></li><li style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;"><a href="https://www.centos.bz/2014/12/ha-load-balance-mysql-master-slave-architecture/#开放root帐号远程权限" style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;color:rgb(164, 0, 0);text-decoration:none;" title="开放root帐号远程权限"><span style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;">开放root帐号远程权限</span></a></li><li style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;"><a href="https://www.centos.bz/2014/12/ha-load-balance-mysql-master-slave-architecture/#设置mysql主从" style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;color:rgb(164, 0, 0);text-decoration:none;" title="设置mysql主从"><span style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;">设置mysql主从</span></a></li><li style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;"><a href="https://www.centos.bz/2014/12/ha-load-balance-mysql-master-slave-architecture/#显示主从关系" style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;color:rgb(164, 0, 0);text-decoration:none;" title="显示主从关系"><span style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;">显示主从关系</span></a></li><li style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;"><a href="https://www.centos.bz/2014/12/ha-load-balance-mysql-master-slave-architecture/#检查主从状态" style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;color:rgb(164, 0, 0);text-decoration:none;" title="检查主从状态"><span style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;">检查主从状态</span></a></li></ul></li><li style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;"><a href="https://www.centos.bz/2014/12/ha-load-balance-mysql-master-slave-architecture/#Keepalived配置" style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;color:rgb(164, 0, 0);text-decoration:none;" title="Keepalived配置"><span style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;">Keepalived配置</span></a><ul style="border:none;list-style:none inside none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;font-size:100%;padding-left:20px;"><li style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;"><a href="https://www.centos.bz/2014/12/ha-load-balance-mysql-master-slave-architecture/#keepalived安装(两台都装)" style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;color:rgb(164, 0, 0);text-decoration:none;" title="keepalived安装(两台都装)"><span style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;">keepalived安装(两台都装)</span></a></li><li style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;"><a href="https://www.centos.bz/2014/12/ha-load-balance-mysql-master-slave-architecture/#keepalived配置(server1)" style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;color:rgb(164, 0, 0);text-decoration:none;" title="keepalived配置(server1)"><span style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;">keepalived配置(server1)</span></a></li><li style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;"><a href="https://www.centos.bz/2014/12/ha-load-balance-mysql-master-slave-architecture/#keepalived配置(server2)" style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;color:rgb(164, 0, 0);text-decoration:none;" title="keepalived配置(server2)"><span style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;">keepalived配置(server2)</span></a></li></ul></li><li style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;"><a href="https://www.centos.bz/2014/12/ha-load-balance-mysql-master-slave-architecture/#Atlas设置" style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;color:rgb(164, 0, 0);text-decoration:none;" title="Atlas设置"><span style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;">Atlas设置</span></a><ul style="border:none;list-style:none inside none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;font-size:100%;padding-left:20px;"><li style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;"><a href="https://www.centos.bz/2014/12/ha-load-balance-mysql-master-slave-architecture/#atlas安装" style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;color:rgb(164, 0, 0);text-decoration:none;" title="atlas安装"><span style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;">atlas安装</span></a></li><li style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;"><a href="https://www.centos.bz/2014/12/ha-load-balance-mysql-master-slave-architecture/#atlas配置" style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;color:rgb(164, 0, 0);text-decoration:none;" title="atlas配置"><span style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;">atlas配置</span></a></li><li style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;"><a href="https://www.centos.bz/2014/12/ha-load-balance-mysql-master-slave-architecture/#启动atlas" style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;color:rgb(164, 0, 0);text-decoration:none;" title="启动atlas"><span style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;">启动atlas</span></a></li><li style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;"><a href="https://www.centos.bz/2014/12/ha-load-balance-mysql-master-slave-architecture/#部署atlas自动维护脚本" style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;color:rgb(164, 0, 0);text-decoration:none;" title="部署atlas自动维护脚本"><span style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;">部署atlas自动维护脚本</span></a></li></ul></li><li style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;"><a href="https://www.centos.bz/2014/12/ha-load-balance-mysql-master-slave-architecture/#server1主宕机测试" style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;color:rgb(164, 0, 0);text-decoration:none;" title="server1主宕机测试"><span style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;">server1主宕机测试</span></a><ul style="border:none;list-style:none inside none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;font-size:100%;padding-left:20px;"><li style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;"><a href="https://www.centos.bz/2014/12/ha-load-balance-mysql-master-slave-architecture/#测试keepalived是否工作正常" style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;color:rgb(164, 0, 0);text-decoration:none;" title="测试keepalived是否工作正常"><span style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;">测试keepalived是否工作正常</span></a></li><li style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;"><a href="https://www.centos.bz/2014/12/ha-load-balance-mysql-master-slave-architecture/#测试是否自动切换了主从" style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;color:rgb(164, 0, 0);text-decoration:none;" title="测试是否自动切换了主从"><span style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;">测试是否自动切换了主从</span></a></li><li style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;"><a href="https://www.centos.bz/2014/12/ha-load-balance-mysql-master-slave-architecture/#测试server1是否抢占VIP" style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;color:rgb(164, 0, 0);text-decoration:none;" title="测试server1是否抢占VIP"><span style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;">测试server1是否抢占VIP</span></a></li><li style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;"><a href="https://www.centos.bz/2014/12/ha-load-balance-mysql-master-slave-architecture/#测试server2的atlas是否已经删除slave backend" style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;color:rgb(164, 0, 0);text-decoration:none;" title="测试server2的atlas是否已经删除slave backend"><span style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;">测试server2的atlas是否已经删除slave backend</span></a></li><li style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;"><a href="https://www.centos.bz/2014/12/ha-load-balance-mysql-master-slave-architecture/#测试server1 mysql是否设置为从" style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;color:rgb(164, 0, 0);text-decoration:none;" title="测试server1 mysql是否设置为从"><span style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;">测试server1 mysql是否设置为从</span></a></li><li style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;"><a href="https://www.centos.bz/2014/12/ha-load-balance-mysql-master-slave-architecture/#测试是否自动恢复读写分离" style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;color:rgb(164, 0, 0);text-decoration:none;" title="测试是否自动恢复读写分离"><span style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;">测试是否自动恢复读写分离</span></a></li></ul></li></ul></div><h2 style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;">架构简介</h2><p style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;"> </p><p style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;">前几天网友来信说帮忙实现这样一个架构：只有两台机器，需要实现其中一台死机之后另一台能接管这台机器的服务，并且在两台机器正常服务时，两台机器都能用上。于是设计了如下的架构。<br/><a href="http://www.centos.bz/wp-content/uploads/2014/12/%E5%8F%8C%E6%9C%BAha%E6%9E%B6%E6%9E%84%E5%9B%BE.png" rel="1 of 1" rev="0" style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;color:rgb(164, 0, 0);text-decoration:none;"><div style="border:1px solid rgb(231, 231, 231);list-style:none;margin:10px auto;padding:5px;font-family:微软雅黑;background:transparent;max-width:100%;display:block;clear:both;"><img src="双机高可用、负载均衡、MySQL(读写分离、主从自动切换)架构设计  Linux服务器运维_files/双机ha架构图.png" type="image/png" data-filename="双机ha架构图.png" alt="双机ha架构图" height="730" width="594"/></div></a><br/>此架构主要是由<a href="https://www.centos.bz/tag/keepalived/" style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;color:rgb(164, 0, 0);text-decoration:none;" title="keepalived">keepalived</a>实现双机高可用，维护了一个外网VIP,一个内网VIP。正常情况时，外网VIP和内网VIP都绑定在server1服务器，web请求发送到server1的<a href="https://www.centos.bz/category/web-server/nginx/" style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;color:rgb(164, 0, 0);text-decoration:none;" title="nginx">nginx</a>，<a href="https://www.centos.bz/tag/nginx-2/" style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;color:rgb(164, 0, 0);text-decoration:none;" title="nginx">nginx</a>对于静态资源请求就直接在本机检索并返回，对于php的动态请求，则负载均衡到server1和server2。对于SQL请求，会将此类请求发送到<a href="https://www.centos.bz/tag/atlas/" style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;color:rgb(164, 0, 0);text-decoration:none;" title="Atlas">Atlas</a> <a href="https://www.centos.bz/category/mysql/" style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;color:rgb(164, 0, 0);text-decoration:none;" title="MySQL">MySQL</a>中间件，Atlas接收到请求之后，把涉及写操作的请求发送到内网VIP，读请求操作发送到mysql从，这样就实现了读写分离。</p><p style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;"> </p><p style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;">当主服务器server1宕机时，keepalived检测到后，立即把外网VIP和内网VIP绑定到server2，并把server2的mysql切换成主库。此时由于外网VIP已经转移到了server2，web请求将发送给server2的nginx。nginx检测到server1宕机，不再把请求转发到server1的<a href="https://www.centos.bz/tag/php-fpm/" style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;color:rgb(164, 0, 0);text-decoration:none;" title="php-fpm">php-fpm</a>。之后的sql请求照常发送给本地的atlas，atlas把写操作发送给内网VIP，读操作发送给mysql从，由于内网VIP已经绑定到server2了，server2的mysql同时接受写操作和读操作。</p><p style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;"> </p><p style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;">当主服务器server1恢复后，server1的mysql自动设置为从，与server2的mysql主同步。keepalived不抢占server2的VIP，继续正常服务。</p><p style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;"> </p><h2 style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;">架构要求</h2><p style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;"> </p><p style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;">要实现此架构，需要三个条件：</p><ul style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;padding-left:20px;"><li style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;">1、服务器可以设置内网IP，并且设置的内网IP互通;</li><li style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;">2、服务器可以随意绑定IDC分配给我们使用的外网IP，即外网IP没有绑定MAC地址;</li><li style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;">3、MySQL服务器支持GTID，即MySQL-5.6.5以上版本。</li></ul><p style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;"> </p><h2 style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;">环境说明</h2><p style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;"> </p><p style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;"><strong style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;">server1</strong></p><ul style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;padding-left:20px;"><li style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;">eth0: 10.96.153.110(对外IP)</li><li style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;">eth1: 192.168.1.100(对内IP)</li></ul><p style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;"><strong style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;">server2</strong></p><ul style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;padding-left:20px;"><li style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;">eth0: 10.96.153.114(对外IP)</li><li style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;">eth1: 192.168.1.101(对内IP)</li></ul><p style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;">系统都是<a href="http://www.centos.bz/" style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;color:rgb(164, 0, 0);text-decoration:none;" title="CentOS">CentOS</a>-6。</p><p style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;"> </p><p style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;"><strong style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;">对外VIP:</strong> 10.96.153.239<br/><strong style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;">对内VIP: </strong> 192.168.1.150</p><p style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;"> </p><h2 style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;">hosts设置</h2><p style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;"> </p><p style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;">/etc/hosts:<br/>192.168.1.100 server1<br/>192.168.1.101 server2</p><p style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;"> </p><h2 style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;">Nginx PHP MySQL Memcached安装</h2><p style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;"> </p><p style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;">这几个软件的安装推荐使用<a href="https://www.lxconfig.com/thread-69-1-1.html" style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;color:rgb(164, 0, 0);text-decoration:none;">EZHTTP</a>来完成。</p><p style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;"> </p><h2 style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;">解决session共享问题</h2><p style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;"> </p><p style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;">php默认的session存储是在/tmp目录下，现在我们是用两台服务器作php请求的负载，这样会造成session分布在两台服务器的/tmp目录下，导致依赖于session的功能不正常。我们可以使用<a href="https://www.centos.bz/tag/memcached/" style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;color:rgb(164, 0, 0);text-decoration:none;" title="memcached">memcached</a>来解决此问题。<br/>上一步我们已经安装好了memcached，现在只需要配置php.ini来使用memcached，配置如下，打开php.ini配置文件，修改为如下两行的值：</p><div style="border:1px solid rgb(195, 206, 217);list-style:none;margin:0px 0px 5px;padding:0px;font-family:Fixedsys, 'BitStream Vera Sans Mono', 'Courier New', Courier, monospace;background:transparent;width:auto;height:auto;overflow:auto;text-align:left;background-color:rgb(249, 251, 252);"><ol style="border:none;list-style:decimal outside;margin:0px;padding:0px 12px 0px 56px;font-family:微软雅黑;background:transparent;background-image:url(https://www.centos.bz/wp-content/plugins/coolcode/images/hide.gif);background-color:transparent;background-position:5px 5px;background-repeat:no-repeat;" title="Double click to hide line number."><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-top-width:0px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);">session.save_handler = memcache</li><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-width:1px;border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);">session.save_path = &quot;tcp://192.168.1.100:11211,tcp://192.168.1.101:11211&quot;</li></ol></div><p style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;">之后重启php-fpm生效。</p><p style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;"> </p><h2 style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;">Nginx配置</h2><p style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;"> </p><h3 style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;">Server1配置</h3><div style="border:1px solid rgb(195, 206, 217);list-style:none;margin:0px 0px 5px;padding:0px;font-family:Fixedsys, 'BitStream Vera Sans Mono', 'Courier New', Courier, monospace;background:transparent;width:auto;height:auto;overflow:auto;text-align:left;background-color:rgb(249, 251, 252);"><ol style="border:none;list-style:decimal outside;margin:0px;padding:0px 12px 0px 56px;font-family:微软雅黑;background:transparent;background-image:url(https://www.centos.bz/wp-content/plugins/coolcode/images/hide.gif);background-color:transparent;background-position:5px 5px;background-repeat:no-repeat;" title="Double click to hide line number."><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-top-width:0px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);">http {</li><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-width:1px;border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);">[...]</li><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-width:1px;border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);">    upstream php-server {</li><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-width:1px;border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);">           server 192.168.1.101:9000;</li><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-width:1px;border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);">           server 127.0.0.1:9000;</li><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-width:1px;border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);">           keepalive 100;</li><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-width:1px;border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);">    }</li><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-width:1px;border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);">[...]</li><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-width:1px;border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);"> server {</li><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-width:1px;border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);">    [...]</li><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-width:1px;border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);">        location ~ \.php$ {</li><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-width:1px;border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);">                        fastcgi_pass   php-server;</li><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-width:1px;border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);">                        fastcgi_index  index.php;</li><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-width:1px;border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);">                        fastcgi_param  SCRIPT_FILENAME  $document_root$fastcgi_script_name;</li><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-width:1px;border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);">                        include        fastcgi_params;</li><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-width:1px;border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);">        }</li><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-width:1px;border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);">    [...]</li><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-width:1px;border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);"> }</li><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-width:1px;border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);">[...]</li><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-width:1px;border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);">}</li></ol></div><p style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;"> </p><h3 style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;">Server2配置</h3><div style="border:1px solid rgb(195, 206, 217);list-style:none;margin:0px 0px 5px;padding:0px;font-family:Fixedsys, 'BitStream Vera Sans Mono', 'Courier New', Courier, monospace;background:transparent;width:auto;height:auto;overflow:auto;text-align:left;background-color:rgb(249, 251, 252);"><ol style="border:none;list-style:decimal outside;margin:0px;padding:0px 12px 0px 56px;font-family:微软雅黑;background:transparent;background-image:url(https://www.centos.bz/wp-content/plugins/coolcode/images/hide.gif);background-color:transparent;background-position:5px 5px;background-repeat:no-repeat;" title="Double click to hide line number."><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-top-width:0px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);">http {</li><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-width:1px;border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);">[...]</li><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-width:1px;border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);">    upstream php-server {</li><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-width:1px;border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);">           server 192.168.1.100:9000;</li><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-width:1px;border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);">           server 127.0.0.1:9000;</li><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-width:1px;border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);">           keepalive 100;</li><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-width:1px;border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);">    }</li><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-width:1px;border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);">[...]</li><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-width:1px;border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);"> server {</li><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-width:1px;border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);">    [...]</li><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-width:1px;border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);">        location ~ \.php$ {</li><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-width:1px;border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);">                        fastcgi_pass   php-server;</li><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-width:1px;border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);">                        fastcgi_index  index.php;</li><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-width:1px;border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);">                        fastcgi_param  SCRIPT_FILENAME  $document_root$fastcgi_script_name;</li><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-width:1px;border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);">                        include        fastcgi_params;</li><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-width:1px;border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);">        }</li><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-width:1px;border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);">    [...]</li><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-width:1px;border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);"> }</li><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-width:1px;border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);">[...]</li><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-width:1px;border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);">}</li></ol></div><p style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;">这两个配置主要的作用是设置php请求的负载均衡。</p><p style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;"> </p><h2 style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;">MySQL配置</h2><p style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;"> </p><h3 style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;">mysql util安装</h3><p style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;">我们需要安装mysql util里的主从配置工具来实现主从切换。</p><div style="border:1px solid rgb(195, 206, 217);list-style:none;margin:0px 0px 5px;padding:0px;font-family:Fixedsys, 'BitStream Vera Sans Mono', 'Courier New', Courier, monospace;background:transparent;width:auto;height:auto;overflow:auto;text-align:left;background-color:rgb(249, 251, 252);"><ol style="border:none;list-style:decimal outside;margin:0px;padding:0px 12px 0px 56px;font-family:微软雅黑;background:transparent;background-image:url(https://www.centos.bz/wp-content/plugins/coolcode/images/hide.gif);background-color:transparent;background-position:5px 5px;background-repeat:no-repeat;" title="Double click to hide line number."><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-top-width:0px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);">cd /tmp</li><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-width:1px;border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);">wget http://dev.mysql.com/get/Downloads/MySQLGUITools/mysql-utilities-1.5.3.tar.gz</li><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-width:1px;border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);">tar xzf mysql-utilities-1.5.3.tar.gz</li><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-width:1px;border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);">cd mysql-utilities-1.5.3</li><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-width:1px;border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);">python setup.py build</li><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-width:1px;border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);">python setup.py install</li></ol></div><p style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;"> </p><h3 style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;">mysql my.cnf配置</h3><p style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;"><strong style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;">server1:</strong></p><div style="border:1px solid rgb(195, 206, 217);list-style:none;margin:0px 0px 5px;padding:0px;font-family:Fixedsys, 'BitStream Vera Sans Mono', 'Courier New', Courier, monospace;background:transparent;width:auto;height:auto;overflow:auto;text-align:left;background-color:rgb(249, 251, 252);"><ol style="border:none;list-style:decimal outside;margin:0px;padding:0px 12px 0px 56px;font-family:微软雅黑;background:transparent;background-image:url(https://www.centos.bz/wp-content/plugins/coolcode/images/hide.gif);background-color:transparent;background-position:5px 5px;background-repeat:no-repeat;" title="Double click to hide line number."><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-top-width:0px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);">[mysql]</li><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-width:1px;border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);">[...]</li><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-width:1px;border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);">protocol=tcp</li><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-width:1px;border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);">[...]</li><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-width:1px;border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);">[...]</li><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-width:1px;border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);">[mysqld]</li><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-width:1px;border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);">[...]</li><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-width:1px;border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);"># BINARY LOGGING #</li><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-width:1px;border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);">log-bin = /usr/local/mysql/data/mysql-bin</li><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-width:1px;border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);">expire-logs-days = 14</li><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-width:1px;border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);">binlog-format= row</li><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-width:1px;border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);">log-slave-updates=true</li><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-width:1px;border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);">gtid-mode=on</li><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-width:1px;border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);">enforce-gtid-consistency =true</li><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-width:1px;border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);">master-info-repository=TABLE</li><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-width:1px;border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);">relay-log-info-repository=TABLE</li><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-width:1px;border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);">server-id=1</li><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-width:1px;border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);">report-host=server1</li><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-width:1px;border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);">report-port=3306</li><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-width:1px;border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);">[...]</li></ol></div><p style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;"><strong style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;">server2:</strong></p><div style="border:1px solid rgb(195, 206, 217);list-style:none;margin:0px 0px 5px;padding:0px;font-family:Fixedsys, 'BitStream Vera Sans Mono', 'Courier New', Courier, monospace;background:transparent;width:auto;height:auto;overflow:auto;text-align:left;background-color:rgb(249, 251, 252);"><ol style="border:none;list-style:decimal outside;margin:0px;padding:0px 12px 0px 56px;font-family:微软雅黑;background:transparent;background-image:url(https://www.centos.bz/wp-content/plugins/coolcode/images/hide.gif);background-color:transparent;background-position:5px 5px;background-repeat:no-repeat;" title="Double click to hide line number."><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-top-width:0px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);">[mysql]</li><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-width:1px;border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);">[...]</li><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-width:1px;border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);">protocol=tcp</li><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-width:1px;border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);">[...]</li><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-width:1px;border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);">[mysqld]</li><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-width:1px;border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);">[...]</li><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-width:1px;border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);"># BINARY LOGGING #</li><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-width:1px;border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);">log-bin = /usr/local/mysql/data/mysql-bin</li><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-width:1px;border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);">expire-logs-days = 14</li><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-width:1px;border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);">binlog-format= row</li><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-width:1px;border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);">log-slave-updates=true</li><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-width:1px;border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);">gtid-mode=on</li><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-width:1px;border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);">enforce-gtid-consistency =true</li><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-width:1px;border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);">master-info-repository=TABLE</li><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-width:1px;border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);">relay-log-info-repository=TABLE</li><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-width:1px;border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);">server-id=2</li><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-width:1px;border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);">report-host=server2</li><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-width:1px;border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);">report-port=3306</li><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-width:1px;border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);">[...]</li></ol></div><p style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;">这两个配置主要是设置了binlog和启用gtid-mode，并且需要设置不同的server-id和report-host。</p><p style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;"> </p><h3 style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;">开放root帐号远程权限</h3><p style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;">我们需要在两台mysql服务器设置root帐号远程访问权限。</p><div style="border:1px solid rgb(195, 206, 217);list-style:none;margin:0px 0px 5px;padding:0px;font-family:Fixedsys, 'BitStream Vera Sans Mono', 'Courier New', Courier, monospace;background:transparent;width:auto;height:auto;overflow:auto;text-align:left;background-color:rgb(249, 251, 252);"><ol style="border:none;list-style:decimal outside;margin:0px;padding:0px 12px 0px 56px;font-family:微软雅黑;background:transparent;background-image:url(https://www.centos.bz/wp-content/plugins/coolcode/images/hide.gif);background-color:transparent;background-position:5px 5px;background-repeat:no-repeat;" title="Double click to hide line number."><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-top-width:0px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);">mysql&gt; grant all on *.* to 'root'@'192.168.1.%' identified by 'Xp29at5F37' with grant option;</li><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-width:1px;border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);">mysql&gt; grant all on *.* to 'root'@'server1' identified by 'Xp29at5F37' with grant option;</li><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-width:1px;border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);">mysql&gt; grant all on *.* to 'root'@'server2' identified by 'Xp29at5F37' with grant option;</li><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-width:1px;border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);">mysql&gt; flush privileges;</li></ol></div><p style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;"> </p><h3 style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;">设置mysql主从</h3><p style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;">在任意一台执行如下命令：</p><div style="border:1px solid rgb(195, 206, 217);list-style:none;margin:0px 0px 5px;padding:0px;font-family:Fixedsys, 'BitStream Vera Sans Mono', 'Courier New', Courier, monospace;background:transparent;width:auto;height:auto;overflow:auto;text-align:left;background-color:rgb(249, 251, 252);"><ol style="border:none;list-style:decimal outside;margin:0px;padding:0px 12px 0px 56px;font-family:微软雅黑;background:transparent;background-image:url(https://www.centos.bz/wp-content/plugins/coolcode/images/hide.gif);background-color:transparent;background-position:5px 5px;background-repeat:no-repeat;" title="Double click to hide line number."><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-top-width:0px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);">mysqlreplicate --master=root:Xp29at5F37@server1:3306 --slave=root:Xp29at5F37@server2:3306 --rpl-user=rpl:o67DhtaW</li></ol></div><p style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;"><em style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;"># master on server1: ... connected.<br/># slave on server2: ... connected.<br/># Checking for binary logging on master...<br/># Setting up replication...<br/># ...done.</em></p><p style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;"> </p><h3 style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;">显示主从关系</h3><div style="border:1px solid rgb(195, 206, 217);list-style:none;margin:0px 0px 5px;padding:0px;font-family:Fixedsys, 'BitStream Vera Sans Mono', 'Courier New', Courier, monospace;background:transparent;width:auto;height:auto;overflow:auto;text-align:left;background-color:rgb(249, 251, 252);"><ol style="border:none;list-style:decimal outside;margin:0px;padding:0px 12px 0px 56px;font-family:微软雅黑;background:transparent;background-image:url(https://www.centos.bz/wp-content/plugins/coolcode/images/hide.gif);background-color:transparent;background-position:5px 5px;background-repeat:no-repeat;" title="Double click to hide line number."><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-top-width:0px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);">mysqlrplshow --master=root:Xp29at5F37@server1 --discover-slaves-login=root:Xp29at5F37</li></ol></div><p style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;"><em style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;"># master on server1: ... connected.<br/># Finding slaves for master: server1:3306</em></p><em style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;"></em><p style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;"><em style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;"># Replication Topology Graph<br/>server1:3306 (MASTER)<br/>   |<br/>   +--- server2:3306 - (SLAVE)</em></p><p style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;"> </p><h3 style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;">检查主从状态</h3><div style="border:1px solid rgb(195, 206, 217);list-style:none;margin:0px 0px 5px;padding:0px;font-family:Fixedsys, 'BitStream Vera Sans Mono', 'Courier New', Courier, monospace;background:transparent;width:auto;height:auto;overflow:auto;text-align:left;background-color:rgb(249, 251, 252);"><ol style="border:none;list-style:decimal outside;margin:0px;padding:0px 12px 0px 56px;font-family:微软雅黑;background:transparent;background-image:url(https://www.centos.bz/wp-content/plugins/coolcode/images/hide.gif);background-color:transparent;background-position:5px 5px;background-repeat:no-repeat;" title="Double click to hide line number."><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-top-width:0px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);">mysqlrplcheck --master=root:Xp29at5F37@server1 --slave=root:Xp29at5F37@server2</li></ol></div><p style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;"><em style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;"># master on server1: ... connected.<br/># slave on server2: ... connected.<br/>Test Description                                                     Status<br/>---------------------------------------------------------------------------<br/>Checking for binary logging on master                                [pass]<br/>Are there binlog exceptions?                                         [pass]<br/>Replication user exists?                                             [pass]<br/>Checking server_id values                                            [pass]<br/>Checking server_uuid values                                          [pass]<br/>Is slave connected to master?                                        [pass]<br/>Check master information file                                        [pass]<br/>Checking InnoDB compatibility                                        [pass]<br/>Checking storage engines compatibility                               [pass]<br/>Checking lower_case_table_names settings                             [pass]<br/>Checking slave delay (seconds behind master)                         [pass]<br/># ...done.</em></p><p style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;"> </p><h2 style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;">Keepalived配置</h2><p style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;"> </p><h3 style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;">keepalived安装(两台都装)</h3><div style="border:1px solid rgb(195, 206, 217);list-style:none;margin:0px 0px 5px;padding:0px;font-family:Fixedsys, 'BitStream Vera Sans Mono', 'Courier New', Courier, monospace;background:transparent;width:auto;height:auto;overflow:auto;text-align:left;background-color:rgb(249, 251, 252);"><ol style="border:none;list-style:decimal outside;margin:0px;padding:0px 12px 0px 56px;font-family:微软雅黑;background:transparent;background-image:url(https://www.centos.bz/wp-content/plugins/coolcode/images/hide.gif);background-color:transparent;background-position:5px 5px;background-repeat:no-repeat;" title="Double click to hide line number."><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-top-width:0px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);">yum -y install keepalived</li><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-width:1px;border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);">chkconfig keepalived on</li></ol></div><p style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;"> </p><h3 style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;">keepalived配置(server1)</h3><div style="border:1px solid rgb(195, 206, 217);list-style:none;margin:0px 0px 5px;padding:0px;font-family:Fixedsys, 'BitStream Vera Sans Mono', 'Courier New', Courier, monospace;background:transparent;width:auto;height:auto;overflow:auto;text-align:left;background-color:rgb(249, 251, 252);"><ol style="border:none;list-style:decimal outside;margin:0px;padding:0px 12px 0px 56px;font-family:微软雅黑;background:transparent;background-image:url(https://www.centos.bz/wp-content/plugins/coolcode/images/hide.gif);background-color:transparent;background-position:5px 5px;background-repeat:no-repeat;" title="Double click to hide line number."><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-top-width:0px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);">vi /etc/keepalived/keepalived.conf</li></ol></div><div style="border:1px solid rgb(195, 206, 217);list-style:none;margin:0px 0px 5px;padding:0px;font-family:Fixedsys, 'BitStream Vera Sans Mono', 'Courier New', Courier, monospace;background:transparent;width:auto;height:auto;overflow:auto;text-align:left;background-color:rgb(249, 251, 252);"><ol style="border:none;list-style:decimal outside;margin:0px;padding:0px 12px 0px 56px;font-family:微软雅黑;background:transparent;background-image:url(https://www.centos.bz/wp-content/plugins/coolcode/images/hide.gif);background-color:transparent;background-position:5px 5px;background-repeat:no-repeat;" title="Double click to hide line number."><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-top-width:0px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);">vrrp_sync_group VG_1 {</li><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-width:1px;border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);">group { </li><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-width:1px;border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);">inside_network</li><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-width:1px;border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);">outside_network</li><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-width:1px;border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);">}</li><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-width:1px;border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);">}</li><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-width:1px;border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);"> </li><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-width:1px;border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);">vrrp_instance inside_network {</li><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-width:1px;border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);">state BACKUP</li><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-width:1px;border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);">interface eth1</li><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-width:1px;border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);">virtual_router_id 51</li><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-width:1px;border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);">priority 101</li><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-width:1px;border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);">advert_int 1</li><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-width:1px;border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);">authentication {</li><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-width:1px;border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);">auth_type PASS</li><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-width:1px;border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);">auth_pass 3489</li><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-width:1px;border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);">}</li><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-width:1px;border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);">virtual_ipaddress {</li><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-width:1px;border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);">192.168.1.150/24</li><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-width:1px;border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);">}</li><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-width:1px;border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);">nopreempt</li><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-width:1px;border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);">notify /data/sh/mysqlfailover-server1.sh</li><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-width:1px;border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);">}</li><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-width:1px;border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);"> </li><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-width:1px;border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);">vrrp_instance outside_network {</li><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-width:1px;border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);">state BACKUP</li><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-width:1px;border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);">interface eth0</li><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-width:1px;border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);">virtual_router_id 50</li><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-width:1px;border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);">priority 101</li><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-width:1px;border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);">advert_int 1</li><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-width:1px;border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);">authentication {</li><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-width:1px;border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);">auth_type PASS</li><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-width:1px;border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);">auth_pass 3489</li><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-width:1px;border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);">}</li><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-width:1px;border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);">virtual_ipaddress {</li><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-width:1px;border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);">10.96.153.239/24</li><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-width:1px;border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);">}</li><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-width:1px;border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);">nopreempt</li><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-width:1px;border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);">}</li></ol></div><p style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;"> </p><h3 style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;">keepalived配置(server2)</h3><div style="border:1px solid rgb(195, 206, 217);list-style:none;margin:0px 0px 5px;padding:0px;font-family:Fixedsys, 'BitStream Vera Sans Mono', 'Courier New', Courier, monospace;background:transparent;width:auto;height:auto;overflow:auto;text-align:left;background-color:rgb(249, 251, 252);"><ol style="border:none;list-style:decimal outside;margin:0px;padding:0px 12px 0px 56px;font-family:微软雅黑;background:transparent;background-image:url(https://www.centos.bz/wp-content/plugins/coolcode/images/hide.gif);background-color:transparent;background-position:5px 5px;background-repeat:no-repeat;" title="Double click to hide line number."><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-top-width:0px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);">vrrp_sync_group VG_1 {</li><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-width:1px;border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);">group {</li><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-width:1px;border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);">inside_network</li><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-width:1px;border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);">outside_network</li><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-width:1px;border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);">}</li><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-width:1px;border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);">}</li><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-width:1px;border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);"> </li><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-width:1px;border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);">vrrp_instance inside_network {</li><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-width:1px;border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);">state BACKUP</li><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-width:1px;border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);">interface eth1</li><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-width:1px;border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);">virtual_router_id 51</li><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-width:1px;border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);">priority 100</li><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-width:1px;border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);">advert_int 1</li><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-width:1px;border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);">authentication {</li><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-width:1px;border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);">auth_type PASS</li><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-width:1px;border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);">auth_pass 3489</li><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-width:1px;border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);">}</li><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-width:1px;border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);">virtual_ipaddress {</li><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-width:1px;border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);">192.168.1.150</li><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-width:1px;border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);">}</li><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-width:1px;border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);">notify /data/sh/mysqlfailover-server2.sh</li><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-width:1px;border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);">}</li><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-width:1px;border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);"> </li><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-width:1px;border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);">vrrp_instance outside_network {</li><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-width:1px;border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);">state BACKUP</li><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-width:1px;border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);">interface eth0</li><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-width:1px;border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);">virtual_router_id 50</li><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-width:1px;border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);">priority 100</li><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-width:1px;border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);">advert_int 1</li><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-width:1px;border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);">authentication {</li><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-width:1px;border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);">auth_type PASS</li><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-width:1px;border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);">auth_pass 3489</li><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-width:1px;border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);">}</li><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-width:1px;border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);">virtual_ipaddress {</li><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-width:1px;border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);">10.96.153.239/24</li><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-width:1px;border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);">}</li><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-width:1px;border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);">}</li></ol></div><p style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;">此keepalived配置需要注意的是：</p><ul style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;padding-left:20px;"><li style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;">1、两台server的state都设置为backup，server1增加nopreempt配置，并且server1 priority比server2高，这样用来实现当server1从宕机恢复时，不抢占VIP;</li><li style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;">2、server1设置notify /data/sh/<a href="https://www.centos.bz/tag/mysqlfailover/" style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;color:rgb(164, 0, 0);text-decoration:none;" title="mysqlfailover">mysqlfailover</a>-server1.sh,server2设置notify /data/sh/mysqlfailover-server2.sh,作用是自动切换主从</li></ul><p style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;">/data/sh/mysqlfailover-server1.sh脚本内容：</p><div style="border:1px solid rgb(195, 206, 217);list-style:none;margin:0px 0px 5px;padding:0px;font-family:Fixedsys, 'BitStream Vera Sans Mono', 'Courier New', Courier, monospace;background:transparent;width:auto;height:auto;overflow:auto;text-align:left;background-color:rgb(249, 251, 252);"><ol style="border:none;list-style:decimal outside;margin:0px;padding:0px 12px 0px 56px;font-family:微软雅黑;background:transparent;background-image:url(https://www.centos.bz/wp-content/plugins/coolcode/images/hide.gif);background-color:transparent;background-position:5px 5px;background-repeat:no-repeat;" title="Double click to hide line number."><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-top-width:0px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);">#!/bin/bash</li><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-width:1px;border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);"> </li><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-width:1px;border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);">sleep 10</li><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-width:1px;border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);">state=$3</li><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-width:1px;border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);">result=`mysql -h127.0.0.1 -P3308 -uroot -pXp29at5F37 -e 'show slave status;'`</li><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-width:1px;border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);">[[ &quot;$result&quot; == &quot;&quot; ]] &amp;&amp; mysqlState=&quot;master&quot; || mysqlState=&quot;slave&quot;</li><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-width:1px;border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);"> </li><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-width:1px;border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);">if [[ &quot;$state&quot; == &quot;MASTER&quot; ]];then</li><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-width:1px;border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);">if [[ &quot;$mysqlState&quot; == &quot;slave&quot; ]];then</li><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-width:1px;border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);">mysqlrpladmin --slave=root:Xp29at5F37@server1:3308 failover</li><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-width:1px;border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);">fi</li><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-width:1px;border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);"> </li><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-width:1px;border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);">elif [[ &quot;$state&quot; == &quot;BACKUP&quot; ]];then</li><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-width:1px;border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);">if [[ &quot;$mysqlState&quot; == &quot;master&quot; ]];then</li><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-width:1px;border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);">mysqlreplicate --master=root:Xp29at5F37@server2:3308 --slave=root:Xp29at5F37@server1:3308 --rpl-user=rpl:o67DhtaW</li><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-width:1px;border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);">fi</li><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-width:1px;border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);">fi</li><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-width:1px;border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);"> </li><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-width:1px;border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);">sed -i 's/proxy-read-only-backend-addresses.*/proxy-read-only-backend-addresses = 192.168.1.150:3308/' /usr/local/mysql-proxy/conf/my.cnf</li><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-width:1px;border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);">mysql -h127.0.0.1 -P2345 -uuser -ppwd -e &quot;REMOVE BACKEND 2;&quot;</li></ol></div><p style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;">/data/sh/mysqlfailover-server2.sh脚本内容：</p><div style="border:1px solid rgb(195, 206, 217);list-style:none;margin:0px 0px 5px;padding:0px;font-family:Fixedsys, 'BitStream Vera Sans Mono', 'Courier New', Courier, monospace;background:transparent;width:auto;height:auto;overflow:auto;text-align:left;background-color:rgb(249, 251, 252);"><ol style="border:none;list-style:decimal outside;margin:0px;padding:0px 12px 0px 56px;font-family:微软雅黑;background:transparent;background-image:url(https://www.centos.bz/wp-content/plugins/coolcode/images/hide.gif);background-color:transparent;background-position:5px 5px;background-repeat:no-repeat;" title="Double click to hide line number."><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-top-width:0px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);">#!/bin/bash</li><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-width:1px;border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);"> </li><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-width:1px;border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);">sleep 10</li><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-width:1px;border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);">state=$3</li><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-width:1px;border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);">result=`mysql -h127.0.0.1 -P3308 -uroot -pXp29at5F37 -e 'show slave status;'`</li><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-width:1px;border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);">[[ &quot;$result&quot; == &quot;&quot; ]] &amp;&amp; mysqlState=&quot;master&quot; || mysqlState=&quot;slave&quot;</li><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-width:1px;border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);"> </li><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-width:1px;border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);">if [[ &quot;$state&quot; == &quot;MASTER&quot; ]];then</li><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-width:1px;border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);">if [[ &quot;$mysqlState&quot; == &quot;slave&quot; ]];then</li><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-width:1px;border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);">mysqlrpladmin --slave=root:Xp29at5F37@server2:3308 failover</li><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-width:1px;border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);">fi</li><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-width:1px;border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);"> </li><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-width:1px;border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);">elif [[ &quot;$state&quot; == &quot;BACKUP&quot; ]];then</li><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-width:1px;border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);">if [[ &quot;$mysqlState&quot; == &quot;master&quot; ]];then</li><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-width:1px;border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);">mysqlreplicate --master=root:Xp29at5F37@server1:3308 --slave=root:Xp29at5F37@server2:3308 --rpl-user=rpl:o67DhtaW</li><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-width:1px;border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);">fi</li><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-width:1px;border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);">fi</li><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-width:1px;border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);"> </li><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-width:1px;border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);">sed -i 's/proxy-read-only-backend-addresses.*/proxy-read-only-backend-addresses = 192.168.1.150:3308/' /usr/local/mysql-proxy/conf/my.cnf</li><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-width:1px;border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);">mysql -h127.0.0.1 -P2345 -uuser -ppwd -e &quot;REMOVE BACKEND 2;&quot;</li></ol></div><p style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;"> </p><h2 style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;">Atlas设置</h2><p style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;"> </p><h3 style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;">atlas安装</h3><p style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;">到这里下载最新版本，https://github.com/Qihoo360/Atlas/releases</p><div style="border:1px solid rgb(195, 206, 217);list-style:none;margin:0px 0px 5px;padding:0px;font-family:Fixedsys, 'BitStream Vera Sans Mono', 'Courier New', Courier, monospace;background:transparent;width:auto;height:auto;overflow:auto;text-align:left;background-color:rgb(249, 251, 252);"><ol style="border:none;list-style:decimal outside;margin:0px;padding:0px 12px 0px 56px;font-family:微软雅黑;background:transparent;background-image:url(https://www.centos.bz/wp-content/plugins/coolcode/images/hide.gif);background-color:transparent;background-position:5px 5px;background-repeat:no-repeat;" title="Double click to hide line number."><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-top-width:0px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);">cd /tmp</li><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-width:1px;border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);">wget https://github.com/Qihoo360/Atlas/releases/download/2.2.1/Atlas-2.2.1.el6.x86_64.rpm</li><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-width:1px;border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);">rpm -i Atlas-2.2.1.el6.x86_64.rpm</li></ol></div><p style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;"> </p><h3 style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;">atlas配置</h3><div style="border:1px solid rgb(195, 206, 217);list-style:none;margin:0px 0px 5px;padding:0px;font-family:Fixedsys, 'BitStream Vera Sans Mono', 'Courier New', Courier, monospace;background:transparent;width:auto;height:auto;overflow:auto;text-align:left;background-color:rgb(249, 251, 252);"><ol style="border:none;list-style:decimal outside;margin:0px;padding:0px 12px 0px 56px;font-family:微软雅黑;background:transparent;background-image:url(https://www.centos.bz/wp-content/plugins/coolcode/images/hide.gif);background-color:transparent;background-position:5px 5px;background-repeat:no-repeat;" title="Double click to hide line number."><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-top-width:0px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);">cd /usr/local/mysql-proxy/conf</li><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-width:1px;border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);">cp test.cnf my.cnf</li><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-width:1px;border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);">vi my.cnf</li></ol></div><p style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;">调整如下参数，</p><div style="border:1px solid rgb(195, 206, 217);list-style:none;margin:0px 0px 5px;padding:0px;font-family:Fixedsys, 'BitStream Vera Sans Mono', 'Courier New', Courier, monospace;background:transparent;width:auto;height:auto;overflow:auto;text-align:left;background-color:rgb(249, 251, 252);"><ol style="border:none;list-style:decimal outside;margin:0px;padding:0px 12px 0px 56px;font-family:微软雅黑;background:transparent;background-image:url(https://www.centos.bz/wp-content/plugins/coolcode/images/hide.gif);background-color:transparent;background-position:5px 5px;background-repeat:no-repeat;" title="Double click to hide line number."><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-top-width:0px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);">proxy-backend-addresses = 192.168.1.150:3306</li><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-width:1px;border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);">proxy-read-only-backend-addresses = 192.168.1.101:3306</li><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-width:1px;border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);">pwds = root:qtyU1btXOo074Itvx0UR9Q==</li><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-width:1px;border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);">event-threads = 8</li></ol></div><p style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;">注意：<br/>proxy-backend-addresse设置为内网VIP<br/>proxy-read-only-backend-addresses设置为server2的IP<br/>root:qtyU1btXOo074Itvx0UR9Q==设置数据库的用户和密码，密码是通过/usr/local/mysql-proxy/bin/encrypt Xp29at5F37生成。<br/>更详细参数解释请查看，<a href="https://github.com/Qihoo360/Atlas/wiki/Atlas%E9%83%A8%E5%88%86%E9%85%8D%E7%BD%AE%E5%8F%82%E6%95%B0%E5%8F%8A%E5%8E%9F%E7%90%86%E8%AF%A6%E8%A7%A3" style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;color:rgb(164, 0, 0);text-decoration:none;">Atlas配置详解</a>。</p><p style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;"> </p><h3 style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;">启动atlas</h3><div style="border:1px solid rgb(195, 206, 217);list-style:none;margin:0px 0px 5px;padding:0px;font-family:Fixedsys, 'BitStream Vera Sans Mono', 'Courier New', Courier, monospace;background:transparent;width:auto;height:auto;overflow:auto;text-align:left;background-color:rgb(249, 251, 252);"><ol style="border:none;list-style:decimal outside;margin:0px;padding:0px 12px 0px 56px;font-family:微软雅黑;background:transparent;background-image:url(https://www.centos.bz/wp-content/plugins/coolcode/images/hide.gif);background-color:transparent;background-position:5px 5px;background-repeat:no-repeat;" title="Double click to hide line number."><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-top-width:0px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);">/usr/local/mysql-proxy/bin/mysql-proxy --defaults-file=/usr/local/mysql-proxy/conf/my.cnf</li></ol></div><p style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;">之后程序里配置mysql就配置127.0.0.1:1234就好。</p><p style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;"> </p><h3 style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;">部署atlas自动维护脚本</h3><p style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;">在两台机器都部署此脚本，并添加定时任务（如每2分钟运行一次）我们把脚本放在/data/sh/auto_maintain_atlas.sh,脚本内容为：</p><div style="border:1px solid rgb(195, 206, 217);list-style:none;margin:0px 0px 5px;padding:0px;font-family:Fixedsys, 'BitStream Vera Sans Mono', 'Courier New', Courier, monospace;background:transparent;width:auto;height:auto;overflow:auto;text-align:left;background-color:rgb(249, 251, 252);"><ol style="border:none;list-style:decimal outside;margin:0px;padding:0px 12px 0px 56px;font-family:微软雅黑;background:transparent;background-image:url(https://www.centos.bz/wp-content/plugins/coolcode/images/hide.gif);background-color:transparent;background-position:5px 5px;background-repeat:no-repeat;" title="Double click to hide line number."><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-top-width:0px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);">#!/bin/bash</li><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-width:1px;border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);"> </li><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-width:1px;border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);">count=`mysql -N -h127.0.0.1 -P2345 -uuser -ppwd -e &quot;select * from backends;&quot; | wc -l`</li><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-width:1px;border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);"> </li><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-width:1px;border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);">if [[ &quot;$count&quot; == &quot;1&quot; ]];then</li><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-width:1px;border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);">result=`mysql -hserver1 -P3308 -uroot -pXp29at5F37 -e 'show slave status\G'`</li><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-width:1px;border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);">if echo &quot;$result&quot; | grep Slave_IO_State;then</li><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-width:1px;border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);">slaveIP=192.168.1.100</li><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-width:1px;border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);">else</li><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-width:1px;border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);">result=`mysql -hserver2 -P3308 -uroot -pXp29at5F37 -e 'show slave status\G'`</li><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-width:1px;border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);">slaveIP=192.168.1.101</li><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-width:1px;border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);">fi</li><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-width:1px;border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);"> </li><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-width:1px;border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);">        slaveIORunning=`echo &quot;$result&quot; | awk -F':' '/Slave_IO_Running:/{print $2}'`</li><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-width:1px;border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);">        slaveSQLRunning=`echo &quot;$result&quot; | awk -F':' '/Slave_SQL_Running:/{print $2}'`</li><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-width:1px;border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);">        SlaveSQLRunning_State=`echo &quot;$result&quot; | awk -F':' '/Slave_SQL_Running_State:/{print $2}'`</li><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-width:1px;border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);"></li><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-width:1px;border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);">if [[ &quot;$slaveIORunning&quot; =~ &quot;Yes&quot; &amp;&amp; &quot;$slaveSQLRunning&quot; =~ &quot;Yes&quot; &amp;&amp; &quot;$SlaveSQLRunning_State&quot; =~ &quot;Slave has read all relay log&quot; ]];then</li><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-width:1px;border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);">mysql -h127.0.0.1 -P2345 -uuser -ppwd -e &quot;add slave ${slaveIP}:3308;&quot;</li><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-width:1px;border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);">fi</li><li style="border:none;list-style:decimal outside;margin:0px;padding:0px 0px 0px 12px;font-family:微软雅黑;background:transparent;border-left-width:1px;border-left-style:solid;border-left-color:rgb(195, 206, 217);border-top-width:1px;border-top-style:solid;display:list-item;font-size:12px;line-height:20px;border-top-color:rgb(227, 238, 249);background-color:rgb(249, 251, 252);">fi</li></ol></div><p style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;">为什么需要这个脚本呢？假设目前mysql主服务器在s1,s1宕机后，s2接管VIP，接着删除atlas中设置的slave backend，其mysql提升为主。过一段时间后，s1从宕机中恢复，这时候s1的mysql自动切换为从，接着删除atlas中设置的slave backend，开始连接s2的mysql主同步数据。到这个时候我们发现，已经不存在读写分离了，所有的sql都发送给了s2的mysql。auto_maintain_atlas.sh脚本就派上用场了，此脚本会定时的检查主从是否已经同步完成，如果完成就自动增加slave backend，这样读写分离又恢复了，完全不需要人工干预。</p><p style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;"> </p><h2 style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;">server1主宕机测试</h2><p style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;"> </p><h3 style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;">测试keepalived是否工作正常</h3><p style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;">我们来模拟server1宕机。<br/>在server1上执行shutdown关机命令。<br/>此时我们登录server2，执行ip addr命令，输出如下：<br/><em style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;">1: lo: <span> mtu 16436 qdisc noqueue state UNKNOWN<br/>    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00<br/>    inet 127.0.0.1/8 scope host lo<br/>    inet6 ::1/128 scope host<br/>       valid_lft forever preferred_lft forever<br/>2: eth0: <span> mtu 1500 qdisc pfifo_fast state UP qlen 1000<br/>    link/ether 00:0c:29:81:9d:42 brd ff:ff:ff:ff:ff:ff<br/>    inet 10.96.153.114/24 brd 10.96.153.255 scope global eth0<br/>    inet 10.96.153.239/24 scope global secondary eth0<br/>    inet6 fe80::20c:29ff:fe81:9d42/64 scope link<br/>       valid_lft forever preferred_lft forever<br/>3: eth1: <span> mtu 1500 qdisc pfifo_fast state UP qlen 1000<br/>    link/ether 00:0c:29:81:9d:4c brd ff:ff:ff:ff:ff:ff<br/>    inet 192.168.1.101/24 brd 192.168.1.255 scope global eth1<br/>    inet 192.168.1.150/32 scope global eth1<br/>    inet6 fe80::20c:29ff:fe81:9d4c/64 scope link<br/>       valid_lft forever preferred_lft forever</span></span></span></em><br/>我们看到对外VIP 10.96.153.239和对内IP 192.168.1.150已经转移到server2了，证明keepalived运行正常。</p><p style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;"> </p><h3 style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;">测试是否自动切换了主从</h3><p style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;">登录server2的mysql服务器，执行show slave status;命令，如下：<br/><em style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;">mysql&gt; show slave statusG<br/>Empty set (0.00 sec)</em><br/>我们发现从状态已经为空，证明已经切换为主了。</p><p style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;"> </p><h3 style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;">测试server1是否抢占VIP</h3><p style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;">为什么要测试这个呢？如果server1恢复之后抢占了VIP，而我们的Atlas里后端设置的是VIP，这样server1启动之后，sql的写操作就会向server1的mysql发送，而server1的mysql数据是旧于server2的，所以这样会造成数据不一致，这个是非常重要的测试。<br/>我们先来启动server1，之后执行ip addr，输出如下：<br/><em style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;">1: lo: <span> mtu 16436 qdisc noqueue state UNKNOWN<br/>    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00<br/>    inet 127.0.0.1/8 scope host lo<br/>    inet6 ::1/128 scope host<br/>       valid_lft forever preferred_lft forever<br/>2: eth0: <span> mtu 1500 qdisc pfifo_fast state UP qlen 1000<br/>    link/ether 00:0c:29:f1:4f:4e brd ff:ff:ff:ff:ff:ff<br/>    inet 10.96.153.110/24 brd 10.96.153.255 scope global eth0<br/>    inet6 fe80::20c:29ff:fef1:4f4e/64 scope link<br/>       valid_lft forever preferred_lft forever<br/>3: eth1: <span> mtu 1500 qdisc pfifo_fast state UP qlen 1000<br/>    link/ether 00:0c:29:f1:4f:58 brd ff:ff:ff:ff:ff:ff<br/>    inet 192.168.1.100/24 brd 192.168.1.255 scope global eth1<br/>    inet6 fe80::20c:29ff:fef1:4f58/64 scope link<br/>       valid_lft forever preferred_lft forever</span></span></span></em><br/>我们看到，server1并没有抢占VIP，测试正常。不过另人郁闷的是，在虚拟机的环境并没有测试成功，不知道为什么。</p><p style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;"> </p><h3 style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;">测试server2的atlas是否已经删除slave backend</h3><p style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;">我们测试这个是为了保证atlas已经没有slave backend，也就是没有从库的设置了，否则当server1恢复时，有可能会把读请求发送给server1的mysql，造成读取了旧数据的问题。<br/><em style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;"><br/>[root@server1 ~]# mysql -h127.0.0.1 -P2345 -uuser -ppwd<br/>mysql&gt; select * from backends;<br/>+-------------+--------------------+-------+------+<br/>| backend_ndx | address            | state | type |<br/>+-------------+--------------------+-------+------+<br/>|           1 | 192.168.1.150:3308 | up    | rw   |<br/>+-------------+--------------------+-------+------+<br/>1 rows in set (0.00 sec)<br/></em>如果看到只有一个后端，证明运作正常。</p><p style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;"> </p><h3 style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;">测试server1 mysql是否设置为从</h3><p style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;">serve1恢复后，登录server1的mysql服务器，执行show slave status;命令，如下：<br/><em style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;"><br/>mysql&gt; show slave statusG<br/>*************************** 1. row ***************************<br/>               Slave_IO_State: Opening tables<br/>                  Master_Host: server1<br/>                  Master_User: rpl<br/>                  Master_Port: 3308<br/>                Connect_Retry: 60<br/>              Master_Log_File: mysql-bin.000015<br/>          Read_Master_Log_Pos: 48405991<br/>               Relay_Log_File: mysql-relay-bin.000002<br/>                Relay_Log_Pos: 361<br/>        Relay_Master_Log_File: mysql-bin.000015<br/>             Slave_IO_Running: Yes<br/>            Slave_SQL_Running: yes<br/></em></p><p style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;"> </p><h3 style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;">测试是否自动恢复读写分离</h3><p style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;">server1恢复后一段时间，我们可以看是读写分离是否已经恢复。<br/><em style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;"><br/>[root@server1 ~]# mysql -h127.0.0.1 -P2345 -uuser -ppwd<br/>Warning: Using a password on the command line interface can be insecure.<br/>Welcome to the MySQL monitor.  Commands end with ; or g.<br/>Your MySQL connection id is 1<br/>Server version: 5.0.99-agent-admin</em></p><em style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;"><p style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;">Copyright (c) 2000, 2014, <a href="https://www.centos.bz/tag/oracle/" style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;color:rgb(164, 0, 0);text-decoration:none;" title="Oracle">Oracle</a> and/or its affiliates. All rights reserved.</p><p style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;">Oracle is a registered trademark of Oracle Corporation and/or its<br/>affiliates. Other names may be trademarks of their respective<br/>owners.</p><p style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;">Type 'help;' or 'h' for help. Type 'c' to clear the current input statement.</p></em><p style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;"><em style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;">mysql&gt; select * from backends;<br/>+-------------+--------------------+-------+------+<br/>| backend_ndx | address            | state | type |<br/>+-------------+--------------------+-------+------+<br/>|           1 | 192.168.1.150:3308 | up    | rw   |<br/>|           2 | 192.168.1.100:3308 | up    | ro   |<br/>+-------------+--------------------+-------+------+<br/>2 rows in set (0.00 sec)<br/></em><br/>我们看到server1已经被添加为slave backend了。这表示已经成功恢复读写分离。</p><div style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;clear:both;height:0px;overflow:hidden;"></div></div><p style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;font-size:83.3%;">转载请标明文章来源:《<a href="https://www.centos.bz/2014/12/ha-load-balance-mysql-master-slave-architecture/" style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;color:rgb(164, 0, 0);text-decoration:none;">https://www.centos.bz/2014/12/ha-load-balance-mysql-master-slave-architecture/</a>》</p><ins style="display:inline-block;width:728px;height:90px;"><ins style="display:inline-table;border:none;height:90px;margin:0;padding:0;position:relative;visibility:visible;width:728px;background-color:transparent;"><ins style="display:block;border:none;height:90px;margin:0;padding:0;position:relative;visibility:visible;width:728px;background-color:transparent;"><div style="left:0;position:absolute;top:0;"></div></ins></ins></ins><p style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;"> </p><p style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;font-size:16px;">遇到问题无法解决？点<a href="http://www.centos.bz/technical-services/" style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;color:rgb(164, 0, 0);text-decoration:none;">这里</a>寻求支持</p><div style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;"></div><div style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;float:right;"></div><div style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;clear:both;height:0px;overflow:hidden;"></div></div></div></div></div></div></div></div></div></div></div><br/></span>
</div></body></html> 