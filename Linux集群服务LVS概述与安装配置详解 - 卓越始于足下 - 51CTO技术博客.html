<html>
<head>
  <title>Linux集群服务LVS概述与安装配置详解 - 卓越始于足下 - 51CTO技术博客</title>
  <basefont face="宋体" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="YXBJ Windows/600718 (zh-CN, DDL); Windows/10.0.0 (Win64);"/>
  <style>
    body, td {
      font-family: 宋体;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="1179"/>
<h1>Linux集群服务LVS概述与安装配置详解 - 卓越始于足下 - 51CTO技术博客</h1>

<div>
<span><div style="position: relative; max-width: 750px;"><div style="font-size: 16px"><div style="font-size: 12px; background: rgb(228, 228, 228);"><div style="overflow:hidden;"><div style="padding:0px;margin:0px;background:rgb(255, 255, 255);margin-top:5px;"><div style="padding:0px;margin:0px;clear:both;"><div style="padding:0px;margin:0 0 10px;border-top-width:2px;border-top-style:solid;border-top-color:rgb(239, 239, 239);clear:both;position:relative;"><div style="padding:0px;margin:5px 12px 0px;height:60px;border-bottom-width:1px;border-bottom-style:dashed;border-bottom-color:rgb(204, 204, 204);"><div style="padding:20px 0px 0px;margin:0px;overflow:hidden;text-align:center;"><div style="padding: 0px; margin: 0px; font-size: 20px;"><span style="word-wrap: break-word; -webkit-nbsp-mode: space; -webkit-line-break: after-white-space;"><span style="font-size: 20px; color: rgb(85, 85, 85); font-family: 宋体; font-stretch: normal; font-style: normal; font-variant: normal; font-weight: bold; line-height: 20px;">Linux集群服务LVS概述与安装配置详解</span></span></div></div><div><span style="font-size: 9pt; color: rgb(85, 85, 85);"><br/></span></div></div><div style="padding: 0px; margin: 20px 15px 8px; font-size: 14px; border-bottom: 1px dashed rgb(217, 217, 217); word-wrap: break-word; word-break: normal;"><div style="padding: 0px; margin: 0px; clear: both; height: auto; overflow: hidden;"><span style="font-size: 14px; color: rgb(85, 85, 85); font-family: 宋体, &quot;Arial Narrow&quot;, arial, serif; line-height: 2;"> </span></div><div style="padding: 0px; margin: 0px; clear: both; height: auto; overflow: hidden;"><span style="font-size: 14px; color: rgb(85, 85, 85); font-family: 宋体, &quot;Arial Narrow&quot;, arial, serif; line-height: 2;">LVS项目从成立到现在为止，受到不少关注，LVS集群系统已被应用于很多重负载的站点。安装LVS和配置LVS的工作比较繁杂，读者在配置的过程中需要非常细心和耐心。本文对LVS的应用场景进行了简单介绍，并着重介绍LVS的安装和配置操作。 （</span><a href="http://os.51cto.com/art/201011/233146.htm" style="padding: 0px; margin: 0px; font-size: 14px; font-family: 宋体, &quot;Arial Narrow&quot;, arial, serif; line-height: 2; color: rgb(56, 109, 0); text-decoration: none;">http://os.51cto.com/art/201011/233146.htm</a><span style="font-size: 14px; color: rgb(85, 85, 85); font-family: 宋体, &quot;Arial Narrow&quot;, arial, serif; line-height: 2;">）</span></div><div style="padding: 0px; margin: 0px; clear: both; height: auto; overflow: hidden;"><span style="font-size: 14px; color: rgb(85, 85, 85); font-family: 宋体, &quot;Arial Narrow&quot;, arial, serif; line-height: 2;"> </span></div><div style="padding: 0px; margin: 0px; clear: both; height: auto; overflow: hidden;"><span style="font-size: 14px; color: rgb(85, 85, 85); font-family: 宋体, &quot;Arial Narrow&quot;, arial, serif; line-height: 2;">LVS项目从成立到现在为止，受到不少关注，LVS集群系统已被应用于很多重负载的站点。到目前为止，该系统已在美、英、德、澳等国的几十个站点上正式使用。目前，一些大型LVS应用实例如下：</span></div><ol style="padding:0px;margin:0px;"><li style="padding:0px;margin:0px;margin-left:20px;"><div><span style="font-size: 14px; color: rgb(85, 85, 85); font-family: 宋体, &quot;Arial Narrow&quot;, arial, serif; line-height: 2;">英国国家JANET Cache Service（wwwcache.ja.net）是为英国150所以上的大学提供Web Cache服务。他们用28个结点的LVS集群代替了原有现50多台相互独立的Cache服务器，用他们的话说现在速度就跟夏天一样，因为夏天是放假期间没有很多人使用网络。</span></div></li><li style="padding:0px;margin:0px;margin-left:20px;"><div><span style="font-size: 14px; color: rgb(85, 85, 85); font-family: 宋体, &quot;Arial Narrow&quot;, arial, serif; line-height: 2;">Linux的门户站点（</span><a href="http://www.linux.com/" style="padding: 0px; margin: 0px; font-size: 14px; font-family: 宋体, &quot;Arial Narrow&quot;, arial, serif; line-height: 2; color: rgb(56, 109, 0); text-decoration: none;">www.linux.com</a><span style="font-size: 14px; color: rgb(85, 85, 85); font-family: 宋体, &quot;Arial Narrow&quot;, arial, serif; line-height: 2;">）用LVS将很多台VA Linux SMP服务器组成高性能的WEB服务，已使用将近一年。</span></div></li><li style="padding:0px;margin:0px;margin-left:20px;"><div><span style="font-size: 14px; color: rgb(85, 85, 85); font-family: 宋体, &quot;Arial Narrow&quot;, arial, serif; line-height: 2;">SourceForge（sourceforge.net）是在全球范围内为开发源码项目提供WEB、FTP、Mailing List和CVS等服务，他们也使用LVS将负载调度到十几台机器上。</span></div></li><li style="padding:0px;margin:0px;margin-left:20px;"><div><span style="font-size: 14px; color: rgb(85, 85, 85); font-family: 宋体, &quot;Arial Narrow&quot;, arial, serif; line-height: 2;">世界上最大的PC制造商之一采用了两个LVS集群系统，一个在美洲，一个在欧洲，用于网上直销系统。</span></div></li><li style="padding:0px;margin:0px;margin-left:20px;"><div><span style="font-size: 14px; color: rgb(85, 85, 85); font-family: 宋体, &quot;Arial Narrow&quot;, arial, serif; line-height: 2;">以RealPlayer提供音频视频服务而闻名的Real公司（</span><a href="http://www.real.com/" style="padding: 0px; margin: 0px; font-size: 14px; font-family: 宋体, &quot;Arial Narrow&quot;, arial, serif; line-height: 2; color: rgb(56, 109, 0); text-decoration: none;">www.real.com</a><span style="font-size: 14px; color: rgb(85, 85, 85); font-family: 宋体, &quot;Arial Narrow&quot;, arial, serif; line-height: 2;">）使用由20台服务器组成的LVS集群，为其全球用户提供音频视频服务。在2000年3月时，整个集群系统已收到平均每秒20,000个连接的请求流。</span></div></li><li style="padding:0px;margin:0px;margin-left:20px;"><div><span style="font-size: 14px; color: rgb(85, 85, 85); font-family: 宋体, &quot;Arial Narrow&quot;, arial, serif; line-height: 2;">NetWalk（</span><a href="http://www.netwalk.com/" style="padding: 0px; margin: 0px; font-size: 14px; font-family: 宋体, &quot;Arial Narrow&quot;, arial, serif; line-height: 2; color: rgb(56, 109, 0); text-decoration: none;">www.netwalk.com</a><span style="font-size: 14px; color: rgb(85, 85, 85); font-family: 宋体, &quot;Arial Narrow&quot;, arial, serif; line-height: 2;">）用多台服务器构造LVS系统，提供1024个虚拟服务，其中本项目的一个美国镜像站点（</span><a href="http://www.us.linuxvirtualserver.org/" style="padding: 0px; margin: 0px; font-size: 14px; font-family: 宋体, &quot;Arial Narrow&quot;, arial, serif; line-height: 2; color: rgb(56, 109, 0); text-decoration: none;">www.us.linuxvirtualserver.org</a><span style="font-size: 14px; color: rgb(85, 85, 85); font-family: 宋体, &quot;Arial Narrow&quot;, arial, serif; line-height: 2;">）。</span></div></li><li style="padding:0px;margin:0px;margin-left:20px;"><div><span style="font-size: 14px; color: rgb(85, 85, 85); font-family: 宋体, &quot;Arial Narrow&quot;, arial, serif; line-height: 2;">RedHat（</span><a href="http://www.redhat.com/" style="padding: 0px; margin: 0px; font-size: 14px; font-family: 宋体, &quot;Arial Narrow&quot;, arial, serif; line-height: 2; color: rgb(56, 109, 0); text-decoration: none;">www.redhat.com</a><span style="font-size: 14px; color: rgb(85, 85, 85); font-family: 宋体, &quot;Arial Narrow&quot;, arial, serif; line-height: 2;">）从其6.1发行版起已经包含LVS代码，他们开发了一个LVS集群管理工具叫Piranha，用于控制LVS集群，并提供了一个图形化的配置界面。</span></div></li><li style="padding:0px;margin:0px;margin-left:20px;"><div><span style="font-size: 14px; color: rgb(85, 85, 85); font-family: 宋体, &quot;Arial Narrow&quot;, arial, serif; line-height: 2;">VA Linux（</span><a href="http://www.valinux.com/" style="padding: 0px; margin: 0px; font-size: 14px; font-family: 宋体, &quot;Arial Narrow&quot;, arial, serif; line-height: 2; color: rgb(56, 109, 0); text-decoration: none;">www.valinux.com</a><span style="font-size: 14px; color: rgb(85, 85, 85); font-family: 宋体, &quot;Arial Narrow&quot;, arial, serif; line-height: 2;">）向客户提供基于LVS的服务器集群系统，并且提供相关的服务和支持。</span></div></li></ol><h3 style="padding:0px;margin:0px;"><span style="font-size: 14px; color: rgb(85, 85, 85); font-family: 宋体, &quot;Arial Narrow&quot;, arial, serif; line-height: 2; font-weight: bold; padding: 0px; margin: 0px;">安装LVS</span></h3><div style="padding: 0px; margin: 0px; clear: both; height: auto; overflow: hidden;"><span style="font-size: 14px; color: rgb(85, 85, 85); font-family: 宋体, &quot;Arial Narrow&quot;, arial, serif; line-height: 2;">安装LVS和配置LVS的工作比较繁杂，读者在配置的过程中需要非常细心和耐心。在本节我们将对其进行详细地介绍。主要包括如下几个核心步骤：</span></div><div style="padding: 0px; margin: 0px; clear: both; height: auto; overflow: hidden;"><span style="font-size: 14px; color: rgb(85, 85, 85); font-family: 宋体, &quot;Arial Narrow&quot;, arial, serif; line-height: 2; font-weight: bold; padding: 0px; margin: 0px;">1．获取支持LVS的内核源代码</span></div><div style="padding: 0px; margin: 0px; clear: both; height: auto; overflow: hidden;"><span style="font-size: 14px; color: rgb(85, 85, 85); font-family: 宋体, &quot;Arial Narrow&quot;, arial, serif; line-height: 2;">如果读者需要使用LVS，需要下载2.4.23以后版本的内核源代码。下载地址为</span><a href="http://www.kerner.org/" style="padding: 0px; margin: 0px; font-size: 14px; font-family: 宋体, &quot;Arial Narrow&quot;, arial, serif; line-height: 2; color: rgb(56, 109, 0); text-decoration: none;">http://www.kerner.org</a><span style="font-size: 14px; color: rgb(85, 85, 85); font-family: 宋体, &quot;Arial Narrow&quot;, arial, serif; line-height: 2;">。目前主流的Linux内核已经支持LVS，只需要直接使用，不需要进行内核的下载和更新工作。</span></div><div style="padding: 0px; margin: 0px; clear: both; height: auto; overflow: hidden;"><span style="font-size: 14px; color: rgb(85, 85, 85); font-family: 宋体, &quot;Arial Narrow&quot;, arial, serif; line-height: 2; font-weight: bold; padding: 0px; margin: 0px;">2．用户配置工具ipvsadm</span></div><div style="padding: 0px; margin: 0px; clear: both; height: auto; overflow: hidden;"><span style="font-size: 14px; color: rgb(85, 85, 85); font-family: 宋体, &quot;Arial Narrow&quot;, arial, serif; line-height: 2;">该软件的下载地址为：</span><a href="http://www.linuxvirtualserver.org/software/ipvs.html" style="padding: 0px; margin: 0px; font-size: 14px; font-family: 宋体, &quot;Arial Narrow&quot;, arial, serif; line-height: 2; color: rgb(56, 109, 0); text-decoration: none;">http://www.linuxvirtualserver.org/software/ipvs.html</a><span style="font-size: 14px; color: rgb(85, 85, 85); font-family: 宋体, &quot;Arial Narrow&quot;, arial, serif; line-height: 2;">。</span></div><div style="padding: 0px; margin: 0px; clear: both; height: auto; overflow: hidden;"><span style="font-size: 14px; color: rgb(85, 85, 85); font-family: 宋体, &quot;Arial Narrow&quot;, arial, serif; line-height: 2; font-weight: bold; padding: 0px; margin: 0px;">3．调整内核配置选项</span></div><div style="padding: 0px; margin: 0px; clear: both; height: auto; overflow: hidden;"><span style="font-size: 14px; color: rgb(85, 85, 85); font-family: 宋体, &quot;Arial Narrow&quot;, arial, serif; line-height: 2;">读者在内核配置时应该对下列必选项（用*号表示）进行检查，如果某些选项的设置不正确，将有可能影响LVS的正常工作和使用。在查看这些选项之前，用户需要使用make menuconfig命令，进入Networking options选项进行查看：</span></div><div style="padding: 0px; margin: 0px 0px 1em; font-size: 12px; overflow: auto; width: 99%; background: rgb(247, 247, 247);"><div><br/></div><div><span style="font-size: 12px; color: rgb(85, 85, 85); font-family: &quot;Courier New&quot;, monospace; line-height: 2;">Networking options ---&gt;&lt;*&gt; Packet socket&lt;*&gt; Netlink device emulation[*] TCP/IP networking[*] IP: advanced router[*] Network packet filtering (replaces ipchains)IP: Netfilter Configuration ---&gt;&lt;*&gt; Connection tracking (required for masq/NAT)&lt;*&gt; IP tables support (required for filtering/masq/NAT)&lt;*&gt; Full NAT&lt;*&gt; MASQUERADE target supportIP: Virtual Server Configuration ---&gt;&lt;*&gt; virtual server support (EXPERIMENTAL)&lt;M&gt; IPVS connection table size (the Nth power of 2)--- IPVS scheduler&lt;M&gt; round-robin scheduling&lt;M&gt; weighted round-robin scheduling&lt;M&gt; least-connection scheduling&lt;M&gt; weighted least-connection scheduling&lt;M&gt; locality-based least-connection scheduling&lt;M&gt; locality-based least-connection with replication scheduling&lt;M&gt; destination hashing scheduling&lt;M&gt; shortest expected delay scheduling&lt;M&gt; never queue scheduling</span></div></div><div style="padding: 0px; margin: 0px; clear: both; height: auto; overflow: hidden;"><span style="font-size: 14px; color: rgb(85, 85, 85); font-family: 宋体, &quot;Arial Narrow&quot;, arial, serif; line-height: 2;"> </span></div><h3 style="padding:0px;margin:0px;"><span style="font-size: 14px; color: rgb(85, 85, 85); font-family: 宋体, &quot;Arial Narrow&quot;, arial, serif; line-height: 2; font-weight: bold; padding: 0px; margin: 0px;">配置和使用LVS</span></h3><div style="padding: 0px; margin: 0px; clear: both; height: auto; overflow: hidden;"><span style="font-size: 14px; color: rgb(85, 85, 85); font-family: 宋体, &quot;Arial Narrow&quot;, arial, serif; line-height: 2;">在安装好LVS之后，就可以配置和使用LVS了，在本节我们将以一个具体的例子来对其进行讲解。图2为一个采用LVS系统的实际网络拓扑图。它基于NAT机制，具体的配置如下：</span></div><div style="padding: 0px; margin: 0px; clear: both; height: auto; overflow: hidden;"><span style="font-size: 14px; color: rgb(85, 85, 85); font-family: 宋体, &quot;Arial Narrow&quot;, arial, serif; line-height: 2;">一台对外服务的超级服务器：它部署了LVS，也称为balancer或者director，主要功能为负载均衡和任务调度，其外部IP地址为：210.77.132.8，内部IP地址为：172.168.10.8。外部用户可以通过路由器（IP地址为：210.77.132.1）访问它；</span></div><div style="padding: 0px; margin: 0px; clear: both; height: auto; overflow: hidden;"><span style="font-size: 14px; color: rgb(85, 85, 85); font-family: 宋体, &quot;Arial Narrow&quot;, arial, serif; line-height: 2;">两台内部的服务器：它们为实际的工作机器，通过前述的服务器对其进行调度。一台为RS1，其内部IP地址为：172.168.10.9；另一台为RS2，其内部IP地址为：172.168.10.10。</span></div><p style="padding:0px;margin:0px;padding-bottom:0px;clear:both;height:auto;overflow:hidden;text-align:center;"></p><div><span style="padding: 0px; margin: 0px; vertical-align: top; border: none; display: inline-block;"><a href="http://images.51cto.com/files/uploadimg/20101111/0913200.png" style="padding: 0px; margin: 0px; font-size: 14px; font-family: 宋体, &quot;Arial Narrow&quot;, arial, serif; line-height: 2; color: rgb(56, 109, 0); text-decoration: none;" target="_blank"><img src="Linux集群服务LVS概述与安装配置详解 - 卓越始于足下 - 51CTO技术博客_files/0913200.png" type="image/png" data-filename="0913200.png" alt="采用LVS系统的实际网络拓扑图" border="0" height="327" style="cursor: default;" width="274"/></a></span> <span style="font-size: 14px; color: rgb(85, 85, 85); font-family: 宋体, &quot;Arial Narrow&quot;, arial, serif; line-height: 2;"> </span></div><div><span style="font-size: 14px; color: rgb(85, 85, 85); font-family: 宋体, &quot;Arial Narrow&quot;, arial, serif; line-height: 2;">图  采用LVS系统的实际网络拓扑图</span></div><div style="padding: 0px; margin: 0px; clear: both; height: auto; overflow: hidden;"><span style="font-size: 14px; color: rgb(85, 85, 85); font-family: 宋体, &quot;Arial Narrow&quot;, arial, serif; line-height: 2;">根据上述的网路配置和拓扑，对LVS的配置如下：</span></div><div style="padding: 0px; margin: 0px; clear: both; height: auto; overflow: hidden;"><span style="font-size: 14px; color: rgb(85, 85, 85); font-family: 宋体, &quot;Arial Narrow&quot;, arial, serif; line-height: 2; font-weight: bold; padding: 0px; margin: 0px;">1．配置LVS的超级服务器（称为load balancer或者director）</span></div><div style="padding: 0px; margin: 0px; clear: both; height: auto; overflow: hidden;"><span style="font-size: 14px; color: rgb(85, 85, 85); font-family: 宋体, &quot;Arial Narrow&quot;, arial, serif; line-height: 2;">运行如下命令：</span></div><div style="padding: 0px; margin: 0px 0px 1em; font-size: 12px; overflow: auto; width: 99%; background: rgb(247, 247, 247);"><div><br/></div><div><span style="font-size: 12px; color: rgb(85, 85, 85); font-family: &quot;Courier New&quot;, monospace; line-height: 2;">//配置重定向</span></div><div><span style="font-size: 12px; color: rgb(85, 85, 85); font-family: &quot;Courier New&quot;, monospace; line-height: 2;">#echo &quot;1&quot; &gt;/proc/sys/net/ipv4/ip_forward</span></div><div><span style="font-size: 12px; color: rgb(85, 85, 85); font-family: &quot;Courier New&quot;, monospace; line-height: 2;">#echo &quot;0&quot; &gt;/proc/sys/net/ipv4/conf/all/send_redirects#echo &quot;0&quot; &gt;/proc/sys/net/ipv4/conf/default/send_redirects#echo &quot;0&quot; &gt;/proc/sys/net/ipv4/conf/eth0/send_redirects#echo &quot;0&quot; &gt;/proc/sys/net/ipv4/conf/eth1/send_redirects//清除ipvsadm表#/sbin/ipvsadm -C//使用ipvsadm安装LVS服务#add http to VIP with rr scheduling#/sbin/ipvsadm -A -t 210.77.132.8:80 -s rr//增加第一台内部服务器RS1#forward http to realserver 172.168.10.9 using LVS-NAT (-m), with weight=1/sbin/ipvsadm -a -t 210.77.132.8:80 -r 172.168.10.9:80 -m -w 1增加第二台内部服务器RS2#forward http to realserver 172.168.10.10 using LVS-NAT (-m), with weight=1/sbin/ipvsadm -a -t 210.77.132.8:80 -r 172.168.10.10:80 -m -w 1</span></div></div><div style="padding: 0px; margin: 0px; clear: both; height: auto; overflow: hidden;"><span style="font-size: 14px; color: rgb(85, 85, 85); font-family: 宋体, &quot;Arial Narrow&quot;, arial, serif; line-height: 2; font-weight: bold; padding: 0px; margin: 0px;">2．配置LVS中的内部服务器</span></div><div style="padding: 0px; margin: 0px; clear: both; height: auto; overflow: hidden;"><span style="font-size: 14px; color: rgb(85, 85, 85); font-family: 宋体, &quot;Arial Narrow&quot;, arial, serif; line-height: 2;">在172.168.10.9（RS1）和172.168.10.9（RS2）上分别将其网关设置为172.168.10.8，并分别启动apache服务。在客户端使用浏览器多次访问：</span><a href="http://210.77.132.8/" style="padding: 0px; margin: 0px; font-size: 14px; font-family: 宋体, &quot;Arial Narrow&quot;, arial, serif; line-height: 2; color: rgb(56, 109, 0); text-decoration: none;">http://210.77.132.8</a><span style="font-size: 14px; color: rgb(85, 85, 85); font-family: 宋体, &quot;Arial Narrow&quot;, arial, serif; line-height: 2;">，然后再210.77.132.8上运行ipvsadm命令，应该有类似下面的输出：</span></div><div style="padding: 0px; margin: 0px 0px 1em; font-size: 12px; overflow: auto; width: 99%; background: rgb(247, 247, 247);"><div><br/></div><div><span style="font-size: 12px; color: rgb(85, 85, 85); font-family: &quot;Courier New&quot;, monospace; line-height: 2;">IP Virtual Server version 1.0.12 (size=4096)Prot LocalAddress:Port Scheduler Flags -&gt; RemoteAddress:Port Forward Weight ActiveConn InActConnTCP 210.77.132.8:http rr -&gt; 172.168.10.9:http Masq 1 0 33 -&gt; 172.168.10.10:http Masq 1 0 33</span></div></div><div style="padding: 0px; margin: 0px; clear: both; height: auto; overflow: hidden;"><span style="font-size: 14px; color: rgb(85, 85, 85); font-family: 宋体, &quot;Arial Narrow&quot;, arial, serif; line-height: 2;">从上面的结果可以看出，我们配置的LVS服务器已经成功运行。</span></div><div><span style="font-size: 14px; color: rgb(85, 85, 85); font-family: 宋体, &quot;Arial Narrow&quot;, arial, serif; line-height: 2;">本文出自 “</span><a href="http://patterson.blog.51cto.com/" style="padding: 0px; margin: 0px; font-size: 14px; font-family: 宋体, &quot;Arial Narrow&quot;, arial, serif; line-height: 2; color: rgb(56, 109, 0); text-decoration: none;">卓越始于足下</a><span style="font-size: 14px; color: rgb(85, 85, 85); font-family: 宋体, &quot;Arial Narrow&quot;, arial, serif; line-height: 2;">” 博客，请务必保留此出处</span><a href="http://patterson.blog.51cto.com/1060257/420557" style="padding: 0px; margin: 0px; font-size: 14px; font-family: 宋体, &quot;Arial Narrow&quot;, arial, serif; line-height: 2; color: rgb(56, 109, 0); text-decoration: none;">http://patterson.blog.51cto.com/1060257/420557</a></div><div><br/></div></div></div></div></div></div></div></div></div><div><br/></div></span>
</div></body></html> 