<html>
<head>
  <title>SQL Server 2008 数据库镜像方案</title>
  <basefont face="宋体" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="YXBJ Windows/600718 (zh-CN, DDL); Windows/10.0.0 (Win64);"/>
  <style>
    body, td {
      font-family: 宋体;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="1203"/>
<h1>SQL Server 2008 数据库镜像方案</h1>

<div>
<span><div><h1 align="justify"><font color="#010101" face="Calibri" size="5"><span style="font-size:22pt"><b>SQL Server 2008</b></span></font><font color="#010101" face="宋体" size="5"><span style="font-size:22pt"><b> </b></span></font> <font color="#010101" face="宋体" size="5"><span style="font-size:22pt"><b>数据库镜像方案</b></span></font></h1><h1 align="justify"><font color="#010101" face="宋体" size="5"><span style="font-size:22pt"><b>一、概述</b></span></font></h1><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">“数据库镜像”是一种针对数据库高可用性的基于软件的解决方案。其维护着一个数据库的两个相同的副本，这两个副本分别放置在不同的SQL Server数据库实例中。</span></font><div align="left" style="margin-left:0mm; margin-right:0mm; text-indent:7mm; margin-top:0.00mm; margin-bottom:0.00mm;min-height: 13pt;"><font color="#FF0000" face="宋体" size="2"><span style="font-size:10pt">建议使用不同位置的两台服务器来承载</span></font><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">。在同一时刻，其中一台上的数据库用于客户端访问，充当“主体服务器”角色；而另一台则根 据镜像会话的配置和状态，充当热备份服务器，即“镜像服务器角色”，这两种角色不是绝对的。</span></font></div><div align="left" style="margin-left:0mm; margin-right:0mm; text-indent:7mm; margin-top:0.00mm; margin-bottom:0.00mm;min-height: 12pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt"> </span></font></div><h2 align="justify"><font color="#010101" face="宋体" size="4"><span style="font-size:16pt"><b>（一）、</b></span></font><font color="#010101" face="宋体"><span style="font-size:12pt"><b>优点</b></span></font></h2><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">l 增强了数据保护功能</span></font><div align="left" style="margin-left:0mm; margin-right:0mm; text-indent:0mm; margin-top:4.75mm; margin-bottom:4.75mm;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">l 提高了数据库的可用性</span></font></div><div align="left" style="margin-left:0mm; margin-right:0mm; text-indent:0mm; margin-top:4.75mm; margin-bottom:4.75mm;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">l 提高了生产数据库在升级期间的可用性</span></font></div><h2 align="justify"><font color="#010101" face="宋体" size="4"><span style="font-size:16pt"><b>（二）、工作方式</b></span></font></h2><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">在“数据库镜像会话”中，主体服务器和镜像服务器是相互通信和协作，并双方互补。主体服务器角色上的数据库副本为生产数据库。数据库镜像会尽快将主 体数据库中执行的每一项操作（如：插入、更新和删除等）在镜像数据库中进行重新执行。这一过程是通过将活动事务日志记录的流发送到镜像服务器来完成，这可 以尽快将日志记录按顺序应用到镜像数据库中。而且数据库镜像是在物理日志记录级别执行这一“重做”操作的。</span></font><h2 align="justify"><font color="#010101" face="宋体" size="4"><span style="font-size:16pt"><b>（三）、运行模式</b></span></font></h2><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">l 高性能模式（异步运行）：事务不需要等待镜像服务器将日志写入磁盘便可提交，这样可最大程度地提高性能。这意味着事务不需要等待镜像服务器将日志写入磁盘便可提交，而此操作允许主体服务器在事务滞后时间最小的条件下运行，但可能会丢失某些数据。</span></font><div align="left" style="margin-left:0mm; margin-right:0mm; text-indent:0mm; margin-top:4.75mm; margin-bottom:4.75mm;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">l 高安全模式（同步运行）：当会话开始时，镜像服务器使镜像数据库尽快与主体数据库同步。一旦同步了数据库，事务将在双方提交，这会延长事务滞后时间。</span></font></div><h2 align="justify"><font color="#010101" face="宋体" size="4"><span style="font-size:16pt"><b>（四）、角色切换</b></span></font></h2><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">自动切换：在使用见证服务器的情况下，数据库必须已经同步，并且见证服务器必须和镜像服务器连接正常。</span></font><div align="left" style="margin-left:0mm; margin-right:0mm; text-indent:0mm; margin-top:4.75mm; margin-bottom:4.75mm;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">手动切换：在高安全性模式下，主体服务器和镜像服务器必须保持互联，并且数据库必须已经同步。</span></font></div><div align="left" style="margin-left:0mm; margin-right:0mm; text-indent:0mm; margin-top:4.75mm; margin-bottom:4.75mm;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">强制服务：在高性能模式和不带自动故障转移功能的高安全性模式下，如果主体服务器出现故障而镜像服务器可用，则可以强制服务运行。这种方式可能导致某些数据库丢失。</span></font></div><h1 align="justify"><font color="#010101" face="宋体" size="5"><span style="font-size:22pt"><b>二、安装环境说明</b></span></font></h1><h2 align="justify"><font color="#010101" face="宋体" size="4"><span style="font-size:16pt"><b>（一）、软件</b></span></font></h2><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">SQL SERVER数据库镜像功能需安装 SQL SERVER 2005 或以上版本SQL SERVER 2008等，32位或者64位均可；相应的服务器一般采用 win2003 server 或以上版本XP SP2，win7、vista、 win2008 server 等 ，操作系统需能够兼容数据库的位数。</span></font><div align="left" style="min-height: 13pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">本例采用</span></font></div><div align="left" style="min-height: 13pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">操作系统：Windows server 2008 R2 x64</span></font></div><div align="left" style="min-height: 13pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">数据库：SQL SERVER 2008 R2 entperise x86_64</span></font></div><h2 align="justify"><font color="#010101" face="宋体" size="4"><span style="font-size:16pt"><b>（二）、硬件</b></span></font></h2><font color="#010101" face="����" size="2"><span style="font-size:10pt"><br/></span></font><div align="left" style="min-height: 13pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">处理器最低：AMD Opteron、AMD Athlon 64、支持 Intel EM64T 的 Intel Xeon 和支持 EM64T 的 Intel Pentium IV</span></font></div><div align="left" style="min-height: 13pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">内存最低：1G</span></font></div><div align="left" style="min-height: 13pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">推荐：4 GB 或更多</span></font></div><h2 align="justify"><font color="#010101" face="宋体" size="4"><span style="font-size:16pt"><b>（三）、磁盘空间</b></span></font></h2><font color="#010101" face="����" size="2"><span style="font-size:10pt"><br/></span></font><div align="left" style="min-height: 13pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">实际硬盘空间需求取决于系统配置和您决定安装的功能。下表提供了 SQL Server 2008 R2 各组件对磁盘空间的要求：</span></font></div><div style="margin-left: 0mm;"><table cellpadding="1" cellspacing="0" style="border-collapse: collapse; border-left-width: 1px; border-color: #010101;" width="504"><colgroup><col width="405"></col><col width="99"></col></colgroup><tbody><tr><td align="left" height="19" style="border-left:solid #010101 1px; border-right:solid #010101 2px; border-top:solid #010101 1px; border-bottom:solid #010101 2px;" valign="middle" width="402"><div align="left" style="min-height: 13pt;"><font face="宋体" size="2"><span style="font-size:10pt">功能                                                    </span></font></div></td><td align="left" height="19" style="border-left:solid #010101 0px; border-right:solid #010101 1px; border-top:solid #010101 1px; border-bottom:solid #010101 2px;" valign="bottom" width="97"><div align="left" style="min-height: 13pt;"><font face="宋体" size="2"><span style="font-size:10pt">磁盘空间要求</span></font></div></td></tr><tr><td align="left" height="20" style="border-left:solid #010101 1px; border-right:solid #010101 2px; border-top:solid #010101 0px; border-bottom:solid #010101 2px;" valign="middle" width="402"><div align="left" style="min-height: 13pt;"><font face="宋体" size="2"><span style="font-size:10pt"> 数据库引擎 和数据文件、复制以及全文搜索                 </span></font></div></td><td align="left" height="20" style="border-left:solid #010101 0px; border-right:solid #010101 1px; border-top:solid #010101 0px; border-bottom:solid #010101 2px;" valign="bottom" width="97"><div align="left" style="min-height: 13pt;"><font face="宋体" size="2"><span style="font-size:10pt">711 MB</span></font></div></td></tr><tr><td align="left" height="20" style="border-left:solid #010101 1px; border-right:solid #010101 2px; border-top:solid #010101 0px; border-bottom:solid #010101 2px;" valign="middle" width="402"><div align="left" style="min-height: 13pt;"><font face="宋体" size="2"><span style="font-size:10pt"> Analysis Services 和数据文件                             </span></font></div></td><td align="left" height="20" style="border-left:solid #010101 0px; border-right:solid #010101 1px; border-top:solid #010101 0px; border-bottom:solid #010101 2px;" valign="bottom" width="97"><div align="left" style="min-height: 13pt;"><font face="宋体" size="2"><span style="font-size:10pt">345 MB</span></font></div></td></tr><tr><td align="left" height="20" style="border-left:solid #010101 1px; border-right:solid #010101 2px; border-top:solid #010101 0px; border-bottom:solid #010101 2px;" valign="middle" width="402"><div align="left" style="min-height: 13pt;"><font face="宋体" size="2"><span style="font-size:10pt"> Reporting Services 和报表管理器                         </span></font></div></td><td align="left" height="20" style="border-left:solid #010101 0px; border-right:solid #010101 1px; border-top:solid #010101 0px; border-bottom:solid #010101 2px;" valign="bottom" width="97"><div align="left" style="min-height: 13pt;"><font face="宋体" size="2"><span style="font-size:10pt">304 MB</span></font></div></td></tr><tr><td align="left" height="20" style="border-left:solid #010101 1px; border-right:solid #010101 2px; border-top:solid #010101 0px; border-bottom:solid #010101 2px;" valign="middle" width="402"><div align="left" style="min-height: 13pt;"><font face="宋体" size="2"><span style="font-size:10pt"> Integration Services                                     </span></font></div></td><td align="left" height="20" style="border-left:solid #010101 0px; border-right:solid #010101 1px; border-top:solid #010101 0px; border-bottom:solid #010101 2px;" valign="bottom" width="97"><div align="left" style="min-height: 13pt;"><font face="宋体" size="2"><span style="font-size:10pt">591 MB</span></font></div></td></tr><tr><td align="left" height="20" style="border-left:solid #010101 1px; border-right:solid #010101 2px; border-top:solid #010101 0px; border-bottom:solid #010101 2px;" valign="middle" width="402"><div align="left" style="min-height: 13pt;"><font face="宋体" size="2"><span style="font-size:10pt"> 客户端组件（除联机丛书和 Integration Services 工具以外） </span></font></div></td><td align="left" height="20" style="border-left:solid #010101 0px; border-right:solid #010101 1px; border-top:solid #010101 0px; border-bottom:solid #010101 2px;" valign="bottom" width="97"><div align="left" style="min-height: 13pt;"><font face="宋体" size="2"><span style="font-size:10pt">1823 MB</span></font></div></td></tr><tr><td align="left" height="19" style="border-left:solid #010101 1px; border-right:solid #010101 2px; border-top:solid #010101 0px; border-bottom:solid #010101 1px;" valign="middle" width="402"><div align="left" style="min-height: 13pt;"><font face="宋体" size="2"><span style="font-size:10pt"> SQL Server 联机丛书                                      </span></font></div></td><td align="left" height="19" style="border-left:solid #010101 0px; border-right:solid #010101 1px; border-top:solid #010101 0px; border-bottom:solid #010101 1px;" valign="bottom" width="97"><div align="left" style="min-height: 13pt;"><font face="宋体" size="2"><span style="font-size:10pt">157 MB</span></font></div></td></tr></tbody></table></div><div align="left" style="min-height: 13pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">请检查系统驱动器中是否有至少 3.6 GB 的可用磁盘空间用来存储这些文件。即使在将 SQL Server 组件安装到非默认驱动器中时，此项要求也适用。</span></font></div><h2 align="justify"><font color="#010101" face="宋体" size="4"><span style="font-size:16pt"><b>（四）、补充说明</b></span></font></h2><font color="#010101" face="����" size="2"><span style="font-size:10pt"><br/></span></font><div align="left" style="min-height: 13pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">在域控制器上安装 SQL Server</span></font></div><div align="left" style="min-height: 13pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">出于安全方面的考虑，Microsoft 建议您不要将 SQL Server 2008 R2 安装在域控制器上。SQL Server 安装程序不会阻止在作为域控制器的计算机上进行安装，但存在以下限制：</span></font></div><div align="left" style="min-height: 13pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">在 Windows Server 2003 上，SQL Server 服务可在域帐户或本地系统帐户下运行。</span></font></div><div align="left" style="min-height: 13pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">在域控制器上，无法在本地服务帐户或网络服务帐户下运行 SQL Server 服务。</span></font></div><div align="left" style="min-height: 13pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">将 SQL Server 安装到计算机上之后，无法将此计算机从域成员更改为域控制器。必须先卸载 SQL Server，然后才能将主机计算机更改为域控制器。</span></font></div><div align="left" style="min-height: 13pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">将 SQL Server 安装到计算机上之后，无法将此计算机从域控制器更改为域成员。必须先卸载 SQL Server，然后才能将主机计算机更改为域成员。</span></font></div><div align="left" style="min-height: 13pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">在群集节点用作域控制器的情况下，不支持 SQL Server 故障转移群集实例。</span></font></div><div align="left" style="min-height: 13pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">SQL Server 安装程序不能在只读域控制器上创建安全组或设置 SQL Server 服务帐户。在这种情况下，安装将失败。</span></font></div><div align="left" style="min-height: 18pt;"><font color="#010101" face="宋体" size="4"><span style="font-size:14pt"><b>具体部署</b></span></font></div><h1 align="justify"><font color="#010101" face="宋体" size="5"><span style="font-size:22pt"><b>三、数据库准备</b></span></font></h1><h2 align="justify"><font color="#010101" face="宋体" size="4"><span style="font-size:16pt"><b>（一）、目标</b></span></font></h2><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">利用Sql Server 2008 enterprise X64，建立异步（高性能）镜像数据库，同时建立见证服务器实现自动故障转移。</span></font><h2 align="justify"><font color="#010101" face="宋体" size="4"><span style="font-size:16pt"><b>（二）、前提条件、限制和建议</b></span></font></h2><font color="#010101" face="����" size="2"><span style="font-size:10pt">1、伙伴双方（主体服务器和镜像服务器）及见证服务器必须使用相同版本的Sql Server</span></font><div align="left" style="min-height: 13pt;"><font color="#010101" face="����" size="2"><span style="font-size:10pt">2、如使用见证服务器，择须确保其系统上安装 Sql Server 2005或更高版本</span></font></div><div align="left" style="min-height: 13pt;"><font color="#010101" face="����" size="2"><span style="font-size:10pt">3、在镜像服务器上创建镜像数据库时，确保制定相同的数据库名称WITH NOREBOVORY来还原主题数据库备份。另外，还必须通过 WITH NORECOVERY 应用在该备份执行后创建的所有日志备份。如果数据库镜像已经停止，则必须将对主体数据库执行的所有后续日志备份应用到镜像数据库中，然后才可以重新启动镜像。</span></font></div><div align="left" style="min-height: 13pt;"><font color="#010101" face="����" size="2"><span style="font-size:10pt">4、跨数据库事务和分布式事务均不支持数据库镜像</span></font></div><div align="left" style="min-height: 13pt;"><font color="#010101" face="����" size="2"><span style="font-size:10pt">5、镜像的数据库路径尽量与主体服务相同，如果主体服务器CPU利用率在50%以上，择不建议配置自动故障转移</span></font></div><div align="left" style="min-height: 13pt;"><font color="#010101" face="����" size="2"><span style="font-size:10pt">6、建议配置高效稳定的网络环境</span></font></div><h2 align="justify"><font color="#010101" face="宋体" size="4"><span style="font-size:16pt"><b>（三）、设置概述</b></span></font></h2><font color="#010101" face="����" size="2"><span style="font-size:10pt">1、确保所有数据库用户在镜像服务器上都有登录名</span></font><div align="left" style="min-height: 13pt;"><font color="#010101" face="����" size="2"><span style="font-size:10pt">2、在向另一个服务器实例提供数据库之前，您必须在该服务器实例上建立数据库用于新服务器实例时所需的环境</span></font></div><div align="left" style="min-height: 13pt;"><font color="#010101" face="����" size="2"><span style="font-size:10pt">3、使用 NORECOVERY 还原最近的主体数据库完整备份，以创建镜像数据库。确保执行备份时主体数据库已使用完整恢复模式。镜像数据库和主体数据库名称必须相同，并且它们在数据库镜像会话中不能被重命名。</span></font></div><div align="left" style="min-height: 13pt;"><font color="#010101" face="����" size="2"><span style="font-size:10pt">4、设置安全性并启动数据库镜像会话。可以使用 Transact-SQL 或数据库镜像向导来设置镜像。</span></font></div><div align="left" style="min-height: 13pt;"><font color="#010101" face="����" size="2"><span style="font-size:10pt">5、（可选）将见证服务器添加到会话。</span></font></div><h2 align="justify"><font color="#010101" face="宋体" size="4"><span style="font-size:16pt"><b>（四）、在</b></span></font><font color="#010101" face="Cambria" size="4"><span style="font-size:16pt"><b>Windows Server 2008 R2</b></span></font><font color="#010101" face="宋体" size="4"><span style="font-size:16pt"><b>上安装</b></span></font><font color="#010101" face="Cambria" size="4"><span style="font-size:16pt"><b>Sql Server 2008 enterprise X64</b></span></font></h2></div><div><font color="#010101" face="����" size="2"><span style="font-size:10pt">1、SQL Server 2008 需要.NET 3.5支持，所以安装之前需要安装.NET3.5，在服务器管理的功能单元中，添加.NET Framework 3.5.1功能</span></font></div><div><img src="SQL Server 2008 数据库镜像方案_files/Image.png" type="image/png" data-filename="Image.png"/></div><div align="left" style="min-height: 13pt;"><font color="#010101" face="����" size="2"><span style="font-size:10pt">2、安装时选择全新SQL Server独立安装</span></font></div><div align="left" style="min-height: 13pt;"><font color="#010101" face="����" size="2"><span style="font-size:10pt">3、选定功能组件，注意安装目录与其他节点保持一致</span></font></div><div align="justify" style="min-height: 344pt;"><div><img src="SQL Server 2008 数据库镜像方案_files/Image [1].png" type="image/png" data-filename="Image.png" alt="graphic" border="0" height="459" width="577"/></div><div align="left" style="min-height: 13pt;"><font color="#010101" face="����" size="2"><span style="font-size:10pt">4、使用默认实例名称，或者与其他节点相同</span></font></div><div align="left" style="min-height: 313pt;"><img src="SQL Server 2008 数据库镜像方案_files/Image [2].png" type="image/png" data-filename="Image.png" alt="graphic" border="0" height="418" width="558"/></div><div align="left" style="min-height: 13pt;"><font color="#010101" face="����" size="2"><span style="font-size:10pt">5、设定服务启动账户，这里配置所有服务均使用域管理启动</span></font></div><div align="justify" style="min-height: 331pt;"><div><img src="SQL Server 2008 数据库镜像方案_files/Image [3].png" type="image/png" data-filename="Image.png" alt="graphic" border="0" height="442" width="588"/></div><div><div align="left" style="min-height: 13pt;"><font color="#010101" face="����" size="2"><span style="font-size:10pt">6、设置混合身份登录、制定SQL Server管理员</span></font></div><div align="left" style="min-height: 312pt;"><img src="SQL Server 2008 数据库镜像方案_files/Image [4].png" type="image/png" data-filename="Image.png" alt="graphic" border="0" height="416" width="558"/></div><div align="left" style="min-height: 13pt;"><font color="#010101" face="����" size="2"><span style="font-size:10pt">7、点击下一步，等待安装完成。在其他节点按照同样方式安装SQL Server</span></font></div><h2 align="justify"><font color="#010101" face="宋体" size="4"><span style="font-size:16pt"><b>（五）、配置数据库镜像前的数据库准备</b></span></font></h2><font color="#010101" face="����" size="2"><span style="font-size:10pt">1、 确认数据库使用了完整恢复模式：打开SQL Server Management，在VirtualManagerDB数据库（将要镜像的数据库）上点击右键选择属性，定位到选项页，将恢复模式改为“完整”</span></font><div align="justify" style="min-height: 327pt;"><div><img src="SQL Server 2008 数据库镜像方案_files/Image [5].png" type="image/png" data-filename="Image.png" alt="graphic" border="0" height="437" width="569"/></div><div align="left" style="min-height: 13pt;"><font color="#010101" face="����" size="2"><span style="font-size:10pt">2、 备份主体数据库：在VirtualManagerDB数据库上点击右键——任务——备份，备份类型选择完整</span></font></div><div align="left" style="min-height: 311pt;"><img src="SQL Server 2008 数据库镜像方案_files/Image [6].png" type="image/png" data-filename="Image.png" alt="graphic" border="0" height="415" width="555"/></div><div align="left" style="min-height: 13pt;"><font color="#010101" face="����" size="2"><span style="font-size:10pt">3、将备份文件拷贝到镜像节点，执行还原。右键点击数据库，选择还原数据库，选定备份文件，写入还原数据库名称，注意此数据库名称必须与主体服务器数据库名称一致。即VirtualManagerDB。</span></font></div><div align="left" style="min-height: 296pt;"><img src="SQL Server 2008 数据库镜像方案_files/Image [7].png" type="image/png" data-filename="Image.png" alt="graphic" border="0" height="395" width="553"/></div><div align="left" style="min-height: 13pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">点击选项页，勾选覆盖现有数据库。选择NORECOVERY模式</span></font></div><div align="left" style="min-height: 290pt;"><div><img src="SQL Server 2008 数据库镜像方案_files/Image [8].png" type="image/png" data-filename="Image.png" alt="graphic" border="0" height="387" width="553"/></div><div><div align="left" style="min-height: 13pt;"><font color="#010101" face="����" size="2"><span style="font-size:10pt">4、进行完整日志备份</span></font></div><div align="left" style="min-height: 13pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">执行backup LOG VirtualManagerDB to Disk = 'c:\backup\vlogback.bak'</span></font></div><div align="left" style="min-height: 298pt;"><img src="SQL Server 2008 数据库镜像方案_files/Image [9].png" type="image/png" data-filename="Image.png" alt="graphic" border="0" height="398" width="558"/></div><div align="left" style="min-height: 13pt;"><font color="#010101" face="����" size="2"><span style="font-size:10pt">5、同样，事务日志备份在镜像数据库上还原。镜像数据库上，点击右键——任务——还原——事务日志</span></font></div><div align="left" style="min-height: 342pt;"><img src="SQL Server 2008 数据库镜像方案_files/Image [10].png" type="image/png" data-filename="Image.png" alt="graphic" border="0" height="457" width="554"/></div><div align="left" style="min-height: 13pt;"><font color="#010101" face="����" size="2"><span style="font-size:10pt">6、在还原选项中选中NORECOVERY,执行还原操作。</span></font></div><h1 align="justify"><font color="#010101" face="宋体" size="5"><span style="font-size:22pt"><b>四、配置镜像</b></span></font></h1><h2 align="justify"><font color="#010101" face="宋体" size="4"><span style="font-size:16pt"><b>（一）、设置安全性并启动数据库镜像会话</b></span></font></h2><font color="#010101" face="����" size="2"><span style="font-size:10pt">1、展开数据库，选择VirtualManagerDB，点击右键选择任务——镜像</span></font><div align="left" style="min-height: 366pt;"><img src="SQL Server 2008 数据库镜像方案_files/Image [11].png" type="image/png" data-filename="Image.png" alt="graphic" border="0" height="489" width="556"/></div><div align="left" style="min-height: 13pt;"><font color="#010101" face="����" size="2"><span style="font-size:10pt">2、点击配置安全性，点选是，包括见证服务器</span></font></div><div align="justify" style="min-height: 279pt;"><div><img src="SQL Server 2008 数据库镜像方案_files/Image [12].png" type="image/png" data-filename="Image.png" alt="graphic" border="0" height="372" width="553"/></div><div align="left" style="min-height: 13pt;"><font color="#010101" face="����" size="2"><span style="font-size:10pt">3、去掉见证服务器，以后进行配置</span></font></div><div align="left" style="min-height: 335pt;"><img src="SQL Server 2008 数据库镜像方案_files/Image [13].png" type="image/png" data-filename="Image.png" alt="graphic" border="0" height="447" width="556"/></div><div align="left" style="min-height: 13pt;"><font color="#010101" face="����" size="2"><span style="font-size:10pt">4、设置主体服务器，填入端点名称为site1</span></font></div><div align="left" style="min-height: 333pt;"><img src="SQL Server 2008 数据库镜像方案_files/Image [14].png" type="image/png" data-filename="Image.png" alt="graphic" border="0" height="444" width="553"/></div><div align="left" style="min-height: 13pt;"><font color="#010101" face="����" size="2"><span style="font-size:10pt">5、添加镜像服务器，取端点名为site2</span></font></div><div align="left" style="min-height: 331pt;"><img src="SQL Server 2008 数据库镜像方案_files/Image [15].png" type="image/png" data-filename="Image.png" alt="graphic" border="0" height="442" width="551"/></div><div align="left" style="min-height: 13pt;"><font color="#010101" face="����" size="2"><span style="font-size:10pt">6、指定服务账户为域管理员账户（可以在域内事先配置）</span></font></div><div align="left" style="min-height: 13pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">此处如果没有安装在域上，即没有域账户，可不填；直接点下一步；</span></font></div><div align="left" style="min-height: 327pt;"><img src="SQL Server 2008 数据库镜像方案_files/Image [16].png" type="image/png" data-filename="Image.png" alt="graphic" border="0" height="437" width="551"/></div><div align="left" style="min-height: 13pt;"><font color="#010101" face="����" size="2"><span style="font-size:10pt">7、创建成功，点击关闭</span></font></div><div align="left" style="min-height: 336pt;"><div><img src="SQL Server 2008 数据库镜像方案_files/Image [17].png" type="image/png" data-filename="Image.png" alt="graphic" border="0" height="449" width="556"/></div><div><div align="left" style="min-height: 13pt;"><font color="#010101" face="����" size="2"><span style="font-size:10pt">8、弹出对话框，选择不开始开始镜像</span></font></div><div align="left" style="min-height: 279pt;"><img src="SQL Server 2008 数据库镜像方案_files/Image [18].png" type="image/png" data-filename="Image.png" alt="graphic" border="0" height="373" width="558"/></div><div align="left" style="min-height: 13pt;"><font color="#010101" face="����" size="2"><span style="font-size:10pt">9、点选高性能模式的运行模式，点击开始镜像，查看状态显示已经同步</span></font></div><div align="left" style="min-height: 286pt;"><img src="SQL Server 2008 数据库镜像方案_files/Image [19].png" type="image/png" data-filename="Image.png" alt="graphic" border="0" height="382" width="550"/></div><div align="left" style="min-height: 13pt;"><font color="#010101" face="����" size="2"><span style="font-size:10pt">10、同步完成后，显示如下</span></font></div><div align="left" style="min-height: 508pt;"><img src="SQL Server 2008 数据库镜像方案_files/Image [20].png" type="image/png" data-filename="Image.png" alt="graphic" border="0" height="678" width="324"/></div><div align="left" style="min-height: 13pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">至此，镜像配置完毕，接下来开始测试故障转移</span></font></div><h2 align="justify"><font color="#010101" face="宋体" size="4"><span style="font-size:16pt"><b>（二）、手动故障转移测试</b></span></font></h2><font color="#010101" face="����" size="2"><span style="font-size:10pt">1、主体数据库上点击右键——任务——镜像</span></font><div align="left" style="min-height: 13pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">更改运行模式为高安全性（在高可用模式下不能进行手动故障转移）</span></font></div><div align="left" style="min-height: 13pt;"><div><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">点击右侧故障转移，提示断开所有与主体数据库的链接</span></font></div><div><div align="left" style="min-height: 307pt;"><img src="SQL Server 2008 数据库镜像方案_files/Image [21].png" type="image/png" data-filename="Image.png" alt="graphic" border="0" height="410" width="553"/></div><ol style="margin-top: 0mm; margin-bottom: 0mm; margin-left: 0mm; padding-left: 0pt;"><li style="margin-left: 15pt; margin-right: 0pt; padding-left: 3pt; text-indent:0pt; font-family: Calibri; font-size: 10pt; color: #010101;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt; font-family:����; color:#010101; font-weight:Normal; font-style:Normal; font-decoration:Normal">点击是，开始向镜像数据库还原，下图为正在执行镜像过程</span></font></li></ol><div align="left" style="margin-left:7mm; margin-right:0mm; text-indent:0mm; margin-top:0.00mm; margin-bottom:0.00mm;min-height: 417pt;"><img src="SQL Server 2008 数据库镜像方案_files/Image [22].png" type="image/png" data-filename="Image.png" alt="graphic" border="0" height="556" width="444"/></div><div align="left" style="min-height: 13pt;"><font color="#010101" face="����" size="2"><span style="font-size:10pt">4、 此时显示镜像已近完成，主体数据库被转移到了原来的镜像数据库HYTEST02。整个过程1秒钟内完成</span></font></div><div align="left" style="min-height: 429pt;"><div><img src="SQL Server 2008 数据库镜像方案_files/Image [23].png" type="image/png" data-filename="Image.png" alt="graphic" border="0" height="573" width="448"/></div><div><h1 align="justify"><font color="#010101" face="宋体" size="5"><span style="font-size:22pt"><b>五、部署见证服务器，实现自动故障转移</b></span></font></h1><h2 align="justify"><font color="#010101" face="宋体" size="4"><span style="font-size:16pt"><b>（一）、关于见证服务器</b></span></font></h2><font color="#010101" face="����" size="2"><span style="font-size:10pt">1、若要支持自动故障转移，必须在高安全性模式下配置数据库镜像会话，并且还要具有第三个服务器实例（也称为“见证服务器”）。见证服务器是 SQL Server 的可选实例，它能使高安全性模式会话中的镜像服务器识别出是否要启动自动故障转移。与这两个伙伴不同的是，见证服务器并不能用于数据库。见证服务器的唯一角色是支持自动故障转移。</span></font><div align="left" style="min-height: 13pt;"><font color="#010101" face="����" size="2"><span style="font-size:10pt">2、为了给数据库设置见证服务器，数据库所有者为见证服务器的角色分配数据库引擎实例。见证服务器实例可以与主体服务器实例或镜像服务器实例运行于同一台计算机上，但这样会明显降低自动故障转移的可靠性。因此建议见证服务器应位于另外一台计算机上。</span></font></div><div align="left" style="min-height: 13pt;"><font color="#010101" face="����" size="2"><span style="font-size:10pt">3、在高性能模式下，见证服务器对可用性会有不利影响。如果见证服务器是针对数据库镜</span></font></div><div align="left" style="min-height: 13pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">像会话而配置，则主体服务器必须至少连接到一个其他服务器实例，即镜像服务器或见证服务器，或者是连接到这两个服务器。否则，将无法使用数据库，并且不能进行强制服务（可能丢失数据）。因此，对于高性能模式，我们极力建议您始终将见证服务器设置为 OFF。</span></font></div><h2 align="justify"><font color="#010101" face="宋体" size="4"><span style="font-size:16pt"><b>（二）、关于自动故障转移</b></span></font></h2><font color="#010101" face="����" size="2"><span style="font-size:10pt">1、只有在高安全性模式（“具有自动故障转移功能的高安全性模式”）下运行并且具有见证服务器的数据库镜像会话支持自动故障转移。在具有自动故障转移功能的高安全性模式下，同步数据库后，如果主体数据库变得不可用，则会发生自动故障转移。自动故障转移将导致镜像服务器接管主体服务器的角色，并使其数据库的副本联机以作为主体数据库。因为每个在主体数据库中提交的事务同时也在镜像数据库中提交，所以需要使数据库保持同步以防止在故障转移过程中丢失数据。</span></font><div align="left" style="min-height: 13pt;"><font color="#010101" face="����" size="2"><span style="font-size:10pt">2、自动故障转移所需条件</span></font></div><div align="left" style="min-height: 13pt;"><font color="#010101" face="����" size="2"><span style="font-size:10pt">A、数据库镜像会话必须在高安全性模式下运行，并且必须处理见证服务器。</span></font></div><div align="left" style="min-height: 13pt;"><font color="#010101" face="����" size="2"><span style="font-size:10pt">B、镜像数据库必须已经同步。这将保证发送到镜像服务器的所有日志都已写入磁盘。</span></font></div><div align="left" style="min-height: 13pt;"><font color="#010101" face="����" size="2"><span style="font-size:10pt">C、主体服务器已中断了与其余数据库镜像配置的通信，而镜像服务器和见证服务器将保留仲裁。但是，如果所有服务器实例都已中断通信，而见证服务器和镜像服务器稍后重新建立通信，则不会发生自动故障转移。</span></font></div><div align="left" style="min-height: 13pt;"><font color="#010101" face="����" size="2"><span style="font-size:10pt">D、镜像服务器已检测到丢失了主体服务器</span></font></div><div align="left" style="min-height: 13pt;"><font color="#010101" face="����" size="2"><span style="font-size:10pt">E、镜像服务器检测主体服务器故障的方式取决于故障是硬故障还是软故障。</span></font></div><h2 align="justify"><font color="#010101" face="宋体" size="4"><span style="font-size:16pt"><b>（三）、自动故障转移原理</b></span></font></h2><font color="#010101" face="����" size="2"><span style="font-size:10pt">1、如果主体服务器仍在运行中，则将主体数据库的状态更改为 DISCONNECTED 并断开所有客户端与主体数据库的连接。</span></font><div align="left" style="min-height: 13pt;"><font color="#010101" face="����" size="2"><span style="font-size:10pt">2、见证服务器和镜像服务器将主体服务器注册为不可用。</span></font></div><div align="left" style="min-height: 13pt;"><font color="#010101" face="����" size="2"><span style="font-size:10pt">3、如果重做队列中有任何等待的日志，则镜像服务器将完成前滚镜像数据库的操作</span></font></div><div align="left" style="min-height: 13pt;"><font color="#010101" face="����" size="2"><span style="font-size:10pt">4、前一个镜像数据库作为新的联机主体数据库，恢复通过尽快回滚未提交的事务将这些事务全部清除。锁将隔离这些事务。</span></font></div><div align="left" style="min-height: 13pt;"><font color="#010101" face="����" size="2"><span style="font-size:10pt">5、当前一个主体服务器重新联接到会话时，它将认定其故障转移伙伴现在拥有主体角色。前一个主体服务器接管镜像角色，并将其数据库作为镜像数据库。新的镜像服务器会尽快将新的镜像数据库与主体数据库同步。新的镜像服务器重新同步数据库后，就可以再次执行故障转移，但按反向执行。。</span></font></div><div align="left" style="min-height: 13pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">下图说明了自动故障转移的一个实例。</span></font></div><div align="left" style="min-height: 456pt;"><img src="SQL Server 2008 数据库镜像方案_files/Image [24].png" type="image/png" data-filename="Image.png" alt="graphic" border="0" height="608" width="376"/></div><h2 align="justify"><font color="#010101" face="宋体" size="4"><span style="font-size:16pt"><b>（四）、在见证服务器上看装</b></span></font><font color="#010101" face="Cambria" size="4"><span style="font-size:16pt"><b>SQL Server 2008</b></span></font></h2><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">详见前一</span></font><h2 align="justify"><font color="#010101" face="宋体" size="4"><span style="font-size:16pt"><b>（五）、配置见证服务器</b></span></font></h2><font color="#010101" face="����" size="2"><span style="font-size:10pt">1、主体数据库服务器上，右键点击数据库，选择任务——镜像</span></font><div align="left" style="min-height: 13pt;"><font color="#010101" face="����" size="2"><span style="font-size:10pt">2、在弹出的数据库属性页面中，选定镜像页，点击右侧的配置安全</span></font></div><div align="left" style="min-height: 249pt;"><img src="SQL Server 2008 数据库镜像方案_files/Image [25].png" type="image/png" data-filename="Image.png" alt="graphic" border="0" height="333" width="549"/></div><ol style="margin-top: 0mm; margin-bottom: 0mm; margin-left: 0mm; padding-left: 0pt;"><li style="margin-left: 15pt; margin-right: 0pt; padding-left: 3pt; text-indent:0pt; font-family: Calibri; font-size: 10pt; color: #010101;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt; font-family:����; color:#010101; font-weight:Normal; font-style:Normal; font-decoration:Normal">点击下一步，选择包括见证服务器</span></font></li></ol><div align="justify" style="min-height: 335pt;"><div><img src="SQL Server 2008 数据库镜像方案_files/Image [26].png" type="image/png" data-filename="Image.png" alt="graphic" border="0" height="447" width="556"/></div><div><ol style="margin-top: 0mm; margin-bottom: 0mm; margin-left: 0mm; padding-left: 0pt;"><li style="margin-left: 15pt; margin-right: 0pt; padding-left: 3pt; text-indent:0pt; font-family: Calibri; font-size: 10pt; color: #010101;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt; font-family:����; color:#010101; font-weight:Normal; font-style:Normal; font-decoration:Normal">点击下一步，进行见证服务器配置</span></font></li></ol><div align="left" style="margin-left:7mm; margin-right:0mm; text-indent:0mm; margin-top:0.00mm; margin-bottom:0.00mm;min-height: 331pt;"><img src="SQL Server 2008 数据库镜像方案_files/Image [27].png" type="image/png" data-filename="Image.png" alt="graphic" border="0" height="442" width="556"/></div><ol start="2" style="margin-top: 0mm; margin-bottom: 0mm; margin-left: 0mm; padding-left: 0pt;"><li style="margin-left: 15pt; margin-right: 0pt; padding-left: 3pt; text-indent:0pt; font-family: Calibri; font-size: 10pt; color: #010101;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt; font-family:����; color:#010101; font-weight:Normal; font-style:Normal; font-decoration:Normal">点击两次下一步，填入见证服务器地址或机器名及站点名称</span></font></li></ol><div align="left" style="min-height: 335pt;"><img src="SQL Server 2008 数据库镜像方案_files/Image [28].png" type="image/png" data-filename="Image.png" alt="graphic" border="0" height="447" width="556"/></div><ol start="3" style="margin-top: 0mm; margin-bottom: 0mm; margin-left: 0mm; padding-left: 0pt;"><li style="margin-left: 15pt; margin-right: 0pt; padding-left: 3pt; text-indent:0pt; font-family: Calibri; font-size: 10pt; color: #010101;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt; font-family:����; color:#010101; font-weight:Normal; font-style:Normal; font-decoration:Normal">填入服务账户</span></font></li></ol><div align="left" style="margin-left:7mm; margin-right:0mm; text-indent:0mm; margin-top:0.00mm; margin-bottom:0.00mm;min-height: 13pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">同样，在此处如没有域，可不用填；</span></font></div><div align="left" style="min-height: 333pt;"><img src="SQL Server 2008 数据库镜像方案_files/Image [29].png" type="image/png" data-filename="Image.png" alt="graphic" border="0" height="445" width="556"/></div><div align="left" style="min-height: 13pt;"><font color="#010101" face="����" size="2"><span style="font-size:10pt">7、查看摘要信息，点击完成</span></font></div><div align="left" style="min-height: 333pt;"><img src="SQL Server 2008 数据库镜像方案_files/Image [30].png" type="image/png" data-filename="Image.png" alt="graphic" border="0" height="445" width="553"/></div><div align="left" style="min-height: 336pt;"><img src="SQL Server 2008 数据库镜像方案_files/Image [31].png" type="image/png" data-filename="Image.png" alt="graphic" border="0" height="449" width="556"/></div><div align="justify" style="min-height: 301pt;"><div><img src="SQL Server 2008 数据库镜像方案_files/Image [32].png" type="image/png" data-filename="Image.png" alt="graphic" border="0" height="402" width="555"/></div><div><h2 align="justify"><font color="#010101" face="宋体" size="4"><span style="font-size:16pt"><b>（六）、测试自动故障转移</b></span></font></h2><font color="#010101" face="����" size="2"><span style="font-size:10pt">1、当前主体服务器为Hytest01，镜像数据库是Hytest02</span></font><div align="left" style="min-height: 301pt;"><img src="SQL Server 2008 数据库镜像方案_files/Image [33].png" type="image/png" data-filename="Image.png" alt="graphic" border="0" height="402" width="555"/></div><div align="left" style="min-height: 15pt;"><font color="#010101" face="����" size="2"><span style="font-size:10pt">2、将主体服务器Hytest1的网络断开，看数据库是否自动转移到镜像服务器Hytest02上</span></font></div><div align="left" style="min-height: 243pt;"><img src="SQL Server 2008 数据库镜像方案_files/Image [34].png" type="image/png" data-filename="Image.png" alt="graphic" border="0" height="324" width="553"/></div><div align="left" style="min-height: 15pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">镜像设置显示，主体服务器、镜像服务器角色也互换了。</span></font></div><div align="justify" style="min-height: 15pt;"><div><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">至此SQL Server 2008 的镜像高可用配置实例全部完成。</span></font></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></span>
</div></body></html> 