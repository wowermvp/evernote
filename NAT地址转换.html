<html>
<head>
  <title>NAT地址转换</title>
  <basefont face="宋体" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="YXBJ Windows/600718 (zh-CN, DDL); Windows/10.0.0 (Win64);"/>
  <style>
    body, td {
      font-family: 宋体;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="1972"/>
<h1>NAT地址转换</h1>

<div>
<span style="word-wrap: break-word; -webkit-nbsp-mode: space; -webkit-line-break: after-white-space;">
一、NAT概述
<div>     1、NAT（Network Address Translation,网络地址转换）是1944年提出的。当在专用网内部的一些主机本来已经分配到了本地IP地址（即内网IP地址），但现在又想和因特网上的主机通信时，可使用NAT方法。</div><div>     2、NAT的分类</div><div>     静态转换：这种NAT能够在本地地址和本地全局地址之间进行一对一的映射。请记住，使用静态NAT时，必须为网络中的每台主机提供一个公有的因特网IP地址。</div><div>     动态转换：它能将未注册的IP地址映射到注册IP地址池中的一上地址。不像使用静态NAT那样，你无需静态的配置路由器，使基将每个内部地址映射到一个外部地址，但是必须有足够的公有因特网IP地址，让连接到因特网的主机都能够同时发送和接收分组</div><div>     端口多路复用（Port address Translation，PAT）是指改变外出数据包的源端口并进行端口转换，即端口地址转换（PAT，Port Address Translation）。采用端口多路复用方式。内部网络的所有主机均可共享一个合法外部IP地址实现对Internet的访问，从而可以最大限度节约IP地址资源。同时，又可以隐藏网络内部的所有主机，有效避免来自internet的攻击。因此，目前网络中应用最多的就是端口多路复用方式。</div><div>     3、NAT概念</div><div>     <img src="NAT地址转换_files/Image.png" type="image/png" data-filename="Image.png" height="160" style="cursor: default;" width="908"/></div><div>     4、专用概念</div><div>     NAT转换前的地址为本地地址，NAT转换后的地址为全局地址</div><div>          内部本地地址：就是源主机的内网IP地址</div><div>          内部全局地址：就是源主机经过NAT转换后的公网IP地址</div><div>          外部全局地址：就是目标主机没有经过NAT转换的公网IP地址</div><div>          外部本地地址：就是目标主机经过NAT转换后的内网IP地址（如果目的主机在内网，都会转换。如果目的主机就是公网IP地址，则外部全局地址和外部本地地址为同一个IP地址）</div><div>     </div><div>     5、NAT转发原理</div><div>     1）动态NAT</div><div>     <img src="NAT地址转换_files/Image [1].png" type="image/png" data-filename="Image.png" height="509" style="cursor: default;" width="764"/></div><div>     这是NAT转发的基本原理，主机10.1.1.1如果需要访问公网主机，则经过网关路由把源IP地址转换为公网IP地址170.168.2.2（不同的内网主机可以使用不同的公网IP地址，有几个公网IP地址，就能同时有几个内网主机访问公网），然后访问公网主机。返回数据也要经过网关把目标地址转换为10.1.1.1，才能正常通信。在NAT表中，保存有内部本地地址和内部全局地址。</div><div>     2）PAT</div><div>     <img src="NAT地址转换_files/Image [2].png" type="image/png" data-filename="Image.png" height="614" style="cursor: default;" width="820"/></div><div>     所有的内网IP都使用同一个公网IP地址访问公网。在网关路由的NAT表中，通过不同的端口号标记不同的内部本地本地IP。</div><div>二、动态NAT实验</div><div>     <img src="NAT地址转换_files/Image [3].png" type="image/png" data-filename="Image.png" height="115" style="cursor: default;" width="774"/></div><div>     Router#configure terminal</div><div>     Router(config)#hostname NAT</div><div>     NAT(config)#interface f0/0</div><div>     NAT(config-if)#ip address 192.168.1.1 255.255.255.0</div><div>     NAT(config-if)#no shutdown</div><div>     NAT(config-if)#interface s0/1/0</div><div>     NAT(config-if)#ip address 61.1.1.10 255.255.255.0</div><div>     NAT(config-if)#no shutdown</div><div>     </div><div>     Router#configure terminal</div><div>     Router(config)#hostname R1</div><div>     R1(config)#interface s0/1/0</div><div>     R1(config-if)#ip address 61.1.1.20 255.255.255.0</div><div>     R1(config-if)#no shutdown</div><div><br/></div><div>     此时PC是不能ping通R1的</div><div>     R1#debug ip packet                                   <i>#追踪包的去向</i></div><div>     </div><div>     NAT配置：</div><div>     NAT#configure terminal</div><div>     NAT(config)#interface f0/0</div><div>     NAT(config-if)#ip nat inside                         <i>#指定f0/0为内网接口</i></div><div>     NAT(config-if)#interface s0/1/0</div><div>     NAT(config-if)#ip nat outside                       <i>#指定s0/1/0为外网接口</i></div><div><br/></div><div>     NAT(config)#ip nat pool lamp 61.1.1.2 61.1.1.8 netmask 255.255.255.0</div><div>    <i> #定义一个地址池lamp，里面包含61.1.1.2到61.1.1.8共7个可用IP</i></div><div>     <i>#动态NAT是把内网地址一一对应的转变为公网IP地址，所以只能有7个内网地址同时上网</i></div><div><br/></div><div>     NAT(config)#access-list 1 permit 192.168.1.0 0.0.0.255</div><div>    <i> #定义访问控制列表1</i></div><div>     <i>#这里使用访问控制列表进行IP分类，只有此访问控制列表允许的IP才进行转换</i></div><div>     </div><div>     NAT(config)#ip nat inside source list 1 pool lamp</div><div>     <i>#允许列表1中所有IP，使用地址池lamp转换为公网IP</i></div><div>     </div><div>     NAT#debug ip nat                         <i>#动态查看IP地址转换</i></div><div>     IP NAT debugging is on</div><div>     NAT: s=192.168.1.2-&gt;61.1.1.2, d=61.1.1.20[7]</div><div>     <i>#把源地址转换为了地址池中的公网IP</i></div><div>     NAT*: s=61.1.1.20, d=61.1.1.2-&gt;192.168.1.2[3]</div><div>    <i> #返回数据包，把目标地址转换为了内网地址</i></div><div>     </div><div>     R1#debug ip packet                              <i>#动态查看IP地址包</i></div><div>     NAT#show ip nat translations               <i>#查看nat地址表</i></div><div>     </div><div><br/></div><div><br/></div><div>三、PAT</div><div>     <img src="NAT地址转换_files/Image [4].png" type="image/png" data-filename="Image.png" height="115" style="cursor: default;" width="751"/></div><div>     NAT路由器配置</div><div>     NAT#clear ip nat translation *                                                  <i>#清空nat表</i></div><div>     NAT(config)#no ip nat inside source list 1 pool lamp               <i>#清除动态NAT</i></div><div>     NAT(config)#no ip nat pool lamp 61.1.1.2 61.1.1.8 netmask 255.255.255.0     #<i>清除lamp地址池</i></div><div>     </div><div>     NAT#configure terminal</div><div>     NAT(config)#ip nat pool brother 61.1.1.11 61.1.1.11 netmask 255.255.255.0</div><div>     <i>#建立一个仅有1个IP的地址池brother</i></div><div>     NAT(config)#access-list 2 permit 192.168.1.0 0.0.0.255                    <i>#定义访问控制列表2</i></div><div>     </div><div>     NAT(config)#ip nat inside source list 2 pool brother overload</div><div>     <i>#允许列表2中的所有IP，使用地址池brother转换为公网IP，overload关键字定义使用PAT</i></div><div>     </div><div>     NAT#show ip nat translations                         <i>#查看nat地址表</i></div><div>     </div></span>
</div></body></html> 