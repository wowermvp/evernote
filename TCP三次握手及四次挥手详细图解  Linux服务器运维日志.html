<html>
<head>
  <title>TCP三次握手及四次挥手详细图解 | Linux服务器运维日志</title>
  <basefont face="宋体" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="YXBJ Windows/600718 (zh-CN, DDL); Windows/10.0.0 (Win64);"/>
  <style>
    body, td {
      font-family: 宋体;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="1172"/>
<h1>TCP三次握手及四次挥手详细图解 | Linux服务器运维日志</h1>

<div>
<span><div><br/></div><div><br/></div><div style="position: relative; max-width: 728px;"><div style="font-size: 16px"><div style="list-style: none; background: transparent;"><div style="list-style: none; background: url(&quot;https://www.centos.bz/wp-content/themes/forigi2/images/bodybg.png&quot;) rgb(244, 244, 244); font-size: 12px;"><div style="list-style: none; background: transparent;"><div style="list-style: none; background: transparent;"><div style="list-style: none; background: transparent;"><div style="list-style: none; background: transparent;"><div style="list-style: none; background: rgb(255, 255, 255); box-shadow: rgb(221, 221, 221) 0px -1px 10px inset;"><div style="border-top: none; border-right: none; border-left: none; border-image: initial; list-style: none; margin: 0px 0px 6px; padding: 0px 0px 2px; background: transparent; height: auto; width: 100%; border-bottom: 1px dashed rgb(170, 170, 170);"><div style="border: none; list-style: none; margin: 0px; padding: 0px; background: transparent; text-align: right; float: right; width: 28px; font-size: 12px;"><span style="word-wrap: break-word; -webkit-nbsp-mode: space; -webkit-line-break: after-white-space;"><a href="https://www.centos.bz/2012/08/tcp-establish-close/#comments" rel="nofollow" style="border: none; list-style: none; margin: 0px; padding: 0px; background: transparent; float: right; font-size: 12px; font-family: 微软雅黑; font-stretch: normal; font-style: italic; font-variant: normal; font-weight: 700; line-height: 14px; color: rgb(164, 0, 0); text-decoration: none;" title="《TCP三次握手及四次挥手详细图解》上的评论">5+</a></span></div><div style="border: none; list-style: none; margin: 0px 10px 0px 0px; padding: 0px; background: transparent; text-align: center; float: left; text-shadow: none; width: 46px; box-shadow: rgb(102, 102, 110) 1px 1px 5px;"><div style="border-bottom: none; border-image: initial; list-style: none; margin: 0px; padding: 0px; background: rgb(243, 253, 250); font-size: 24px; border-top: 1px solid rgb(226, 255, 241); border-right: 1px solid rgb(226, 255, 241); border-left: 1px solid rgb(226, 255, 241);"><span style="word-wrap: break-word; -webkit-nbsp-mode: space; -webkit-line-break: after-white-space;"><span style="font-size: 24px; font-family: 微软雅黑; color: rgb(112, 0, 0); font-stretch: normal; font-style: normal; font-variant: normal; font-weight: 700; line-height: 30px;">13</span></span></div><div style="border-top: none; border-image: initial; list-style: none; margin: 0px; padding: 0px; background: rgb(102, 102, 110); font-size: 12px; border-right: 1px solid rgb(85, 85, 94); border-bottom: 1px solid rgb(85, 85, 94); border-left: 1px solid rgb(85, 85, 94);"><span style="border: none; list-style: none; margin: 0px; padding: 0px; background: transparent; font-size: 12px; font-family: 微软雅黑; color: rgb(255, 255, 255); font-stretch: normal; font-style: normal; font-variant: normal; font-weight: normal; line-height: 16px;">2012</span><span style="font-size: 12px; font-family: 微软雅黑; color: rgb(255, 255, 255); font-stretch: normal; font-style: normal; font-variant: normal; font-weight: normal; line-height: 16px;">.</span><span style="border: none; list-style: none; margin: 0px; padding: 0px; background: transparent; font-size: 12px; font-family: 微软雅黑; color: rgb(255, 255, 255); font-stretch: normal; font-style: normal; font-variant: normal; font-weight: normal; line-height: 16px;">08</span></div></div><h1 style="border: none; list-style: none; margin: 0px; padding: 2px 0px 0px; background: transparent; font-size: 16px; letter-spacing: -1px;"><span style="font-size: 16px; font-family: 微软雅黑; color: rgb(164, 0, 0); font-stretch: normal; font-style: normal; font-variant: normal; font-weight: 700; line-height: 20px;">TCP三次握手及四次挥手详细图解</span></h1><div style="border: none; list-style: none; margin: 5px 0px 0px; padding: 0px; background: transparent;"><span style="font-size: 12px; font-family: 微软雅黑; color: rgb(51, 51, 62); font-stretch: normal; font-style: normal; font-variant: normal; font-weight: normal; line-height: 22px;">作者:</span><a href="https://www.centos.bz/author/admin/" rel="author" style="border: none; list-style: none; margin: 0px; padding: 0px; background: transparent; font-size: 12px; font-family: 微软雅黑; font-stretch: normal; font-style: normal; font-variant: normal; font-weight: normal; line-height: 22px; color: rgb(34, 34, 34); text-decoration: none;" title="由朱 茂海发布">朱 茂海</a> <span style="font-size: 12px; font-family: 微软雅黑; color: rgb(51, 51, 62); font-stretch: normal; font-style: normal; font-variant: normal; font-weight: normal; line-height: 22px;">/分类:</span><a href="https://www.centos.bz/category/networking-basics/" rel="category tag" style="border: none; list-style: none; margin: 0px; padding: 0px; background: transparent; font-size: 12px; font-family: 微软雅黑; font-stretch: normal; font-style: normal; font-variant: normal; font-weight: normal; line-height: 22px; color: rgb(34, 34, 34); text-decoration: none;" title="查看网络基础中的全部文章">网络基础</a><span style="font-size: 12px; font-family: 微软雅黑; color: rgb(51, 51, 62); font-stretch: normal; font-style: normal; font-variant: normal; font-weight: normal; line-height: 22px;"> </span></div></div><div style="border: none; list-style: none; margin: 0px; padding: 0px; background: transparent; font-size: 13px;"><div style="border-top: none; border-right: none; border-left: none; border-image: initial; list-style: none; margin: 0px 0px 5px; padding: 3px 6px; background: transparent; border-bottom: 1px dashed rgb(170, 170, 170);"><div style="border: none; list-style: none; margin: 0px; padding: 0px; background: transparent;"><span style="font-size: 13px; font-family: 微软雅黑; color: rgb(34, 34, 34); font-stretch: normal; font-style: normal; font-variant: normal; font-weight: normal; line-height: 22px;">相对于SOCKET开发者,TCP创建过程和链接折除过程是由TCP/IP协议栈自动创建的.因此开发者并不需要控制这个过程.但是对于理解TCP底层运作机制,相当有帮助.</span></div><div style="border: none; list-style: none; margin: 0px; padding: 0px; background: transparent;"><span style="font-size: 13px; font-family: 微软雅黑; color: rgb(34, 34, 34); font-stretch: normal; font-style: normal; font-variant: normal; font-weight: normal; line-height: 22px;">而且对于有网络协议工程师之类笔试,几乎是必考的内容.企业对这个问题热情之高,出乎我的意料：-）。有时上午面试前强调这个问题，并重复讲一次，下午几乎每一个人都被问到这个问题。</span></div><div style="border: none; list-style: none; margin: 0px; padding: 0px; background: transparent;"><span style="font-size: 13px; font-family: 微软雅黑; color: rgb(34, 34, 34); font-stretch: normal; font-style: normal; font-variant: normal; font-weight: normal; line-height: 22px;">因此在这里详细解释一下这两个过程。</span></div><div style="border: none; list-style: none; margin: 0px; padding: 0px; background: transparent;"><span style="font-size: 13px; font-family: 微软雅黑; color: rgb(34, 34, 34); font-stretch: normal; font-style: normal; font-variant: normal; font-weight: bold; line-height: 22px; background: transparent; border: none; list-style: none; margin: 0px; padding: 0px;">TCP三次握手</span></div><div style="border: none; list-style: none; margin: 0px; padding: 0px; background: transparent;"><span style="font-size: 13px; font-family: 微软雅黑; color: rgb(34, 34, 34); font-stretch: normal; font-style: normal; font-variant: normal; font-weight: normal; line-height: 22px;">所谓三次握手(Three-way Handshake)，是指建立一个TCP连接时，需要客户端和服务器总共发送3个包。</span></div><div style="border: none; list-style: none; margin: 0px; padding: 0px; background: transparent;"><div><span style="font-size: 13px; font-family: 微软雅黑; color: rgb(34, 34, 34); font-stretch: normal; font-style: normal; font-variant: normal; font-weight: normal; line-height: 22px;">三次握手的目的是连接服务器指定端口，建立TCP连接,并同步连接双方的序列号和确认号并交换 TCP 窗口大小信息.在socket编程中，客户端执行connect()时。将触发三次握手。</span></div></div><div style="border: 1px solid rgb(231, 231, 231); list-style: none; margin: 10px auto; padding: 5px; background: transparent; max-width: 100%; clear: both;"><span style="font-size: 13px; font-family: 微软雅黑; color: rgb(34, 34, 34); font-stretch: normal; font-style: normal; font-variant: normal; font-weight: normal; line-height: 22px;"><img src="TCP三次握手及四次挥手详细图解  Linux服务器运维日志_files/100327002629.png" type="image/png" data-filename="100327002629.png" height="537" style="cursor: default;" width="714"/></span></div><div><br/></div><div><span style="font-size: 13px; font-family: 微软雅黑; color: rgb(34, 34, 34); font-stretch: normal; font-style: normal; font-variant: normal; font-weight: normal; line-height: 22px;">第一次握手:</span></div><div><span style="font-size: 13px; font-family: 微软雅黑; color: rgb(34, 34, 34); font-stretch: normal; font-style: normal; font-variant: normal; font-weight: normal; line-height: 22px;">客户端发送一个TCP的SYN标志位置1的包指明客户打算连接的服务器的端口，以及初始序号X,保存在包头的序列号(Sequence Number)字段里。</span></div><div style="border: 1px solid rgb(231, 231, 231); list-style: none; margin: 10px auto; padding: 5px; background: transparent; max-width: 100%; clear: both;"><span style="font-size: 13px; font-family: 微软雅黑; color: rgb(34, 34, 34); font-stretch: normal; font-style: normal; font-variant: normal; font-weight: normal; line-height: 22px;"><img src="TCP三次握手及四次挥手详细图解  Linux服务器运维日志_files/100327002911.png" type="image/png" data-filename="100327002911.png" height="239" style="cursor: default;cursor: default;cursor: default;" width="548"/></span></div><div><br/></div><div><span style="font-size: 13px; font-family: 微软雅黑; color: rgb(34, 34, 34); font-stretch: normal; font-style: normal; font-variant: normal; font-weight: normal; line-height: 22px;">第二次握手:</span></div><div><span style="font-size: 13px; font-family: 微软雅黑; color: rgb(34, 34, 34); font-stretch: normal; font-style: normal; font-variant: normal; font-weight: normal; line-height: 22px;">服务器发回确认包(ACK)应答。即SYN标志位和ACK标志位均为1同时，将确认序号(Acknowledgement Number)设置为客户的I S N加1以.即X+1。</span></div><div style="border: 1px solid rgb(231, 231, 231); list-style: none; margin: 10px auto; padding: 5px; background: transparent; max-width: 100%; clear: both;"><span style="font-size: 13px; font-family: 微软雅黑; color: rgb(34, 34, 34); font-stretch: normal; font-style: normal; font-variant: normal; font-weight: normal; line-height: 22px;"><img src="TCP三次握手及四次挥手详细图解  Linux服务器运维日志_files/100327003054.png" type="image/png" data-filename="100327003054.png" height="233" style="cursor: default;cursor: default;cursor: default;" width="541"/></span></div><div style="border: none; list-style: none; margin: 0px; padding: 0px; background: transparent;"><div><span style="font-size: 13px; font-family: 微软雅黑; color: rgb(34, 34, 34); font-stretch: normal; font-style: normal; font-variant: normal; font-weight: normal; line-height: 22px;">第三次握手.</span></div><div><span style="font-size: 13px; font-family: 微软雅黑; color: rgb(34, 34, 34); font-stretch: normal; font-style: normal; font-variant: normal; font-weight: normal; line-height: 22px;">客户端再次发送确认包(ACK) SYN标志位为0,ACK标志位为1.并且把服务器发来ACK的序号字段+1,放在确定字段中发送给对方.并且在数据段放写ISN的+1</span></div></div><div style="border: 1px solid rgb(231, 231, 231); list-style: none; margin: 10px auto; padding: 5px; background: transparent; max-width: 100%; clear: both;"><a href="http://www.centos.bz/wp-content/uploads/2012/08/100327003214.png" rel="4 of 6" rev="3" style="border: none; list-style: none; margin: 0px; padding: 0px; background: transparent; font-size: 13px; font-family: 微软雅黑; font-stretch: normal; font-style: normal; font-variant: normal; font-weight: normal; line-height: 22px; color: rgb(164, 0, 0); text-decoration: none;"><img src="TCP三次握手及四次挥手详细图解  Linux服务器运维日志_files/100327003214.png" type="image/png" data-filename="100327003214.png" height="237" style="cursor: default;cursor: default;cursor: default;" width="541"/></a></div><div><br/></div><div><span style="font-size: 13px; font-family: 微软雅黑; color: rgb(34, 34, 34); font-stretch: normal; font-style: normal; font-variant: normal; font-weight: bold; line-height: 22px; background: transparent; border: none; list-style: none; margin: 0px; padding: 0px;">SYN攻击</span></div><div><span style="font-size: 13px; font-family: 微软雅黑; color: rgb(34, 34, 34); font-stretch: normal; font-style: normal; font-variant: normal; font-weight: normal; line-height: 22px;">在三次握手过程中，服务器发送SYN-ACK之后，收到客户端的ACK之前的TCP连接称为半连接(half-open connect).此时服务器处于Syn_RECV状态.当收到ACK后，服务器转入ESTABLISHED状态.</span></div><div><span style="font-size: 13px; font-family: 微软雅黑; color: rgb(34, 34, 34); font-stretch: normal; font-style: normal; font-variant: normal; font-weight: normal; line-height: 22px;">Syn攻击就是 攻击客户端 在短时间内伪造大量不存在的IP地址，向服务器不断地发送syn包，服务器回复确认包，并等待客户的确认，由于源地址是不存在的，服务器需要不断的重发直 至超时，这些伪造的SYN包将长时间占用未连接队列，正常的SYN请求被丢弃，目标系统运行缓慢，严重者引起网络堵塞甚至系统瘫痪。</span></div><div><span style="font-size: 13px; font-family: 微软雅黑; color: rgb(34, 34, 34); font-stretch: normal; font-style: normal; font-variant: normal; font-weight: normal; line-height: 22px;">Syn攻击是一个典型的</span><a href="https://www.centos.bz/tag/ddos/" style="border: none; list-style: none; margin: 0px; padding: 0px; background: transparent; font-size: 13px; font-family: 微软雅黑; font-stretch: normal; font-style: normal; font-variant: normal; font-weight: normal; line-height: 22px; color: rgb(164, 0, 0); text-decoration: none;" title="DDOS">DDOS</a><span style="font-size: 13px; font-family: 微软雅黑; color: rgb(34, 34, 34); font-stretch: normal; font-style: normal; font-variant: normal; font-weight: normal; line-height: 22px;">攻击。检测SYN攻击非常的方便，当你在服务器上看到大量的半连接状态时，特别是源IP地址是随机的，基本上可以断定这是一次SYN攻击.在</span><a href="http://www.centos.bz/" style="border: none; list-style: none; margin: 0px; padding: 0px; background: transparent; font-size: 13px; font-family: 微软雅黑; font-stretch: normal; font-style: normal; font-variant: normal; font-weight: normal; line-height: 22px; color: rgb(164, 0, 0); text-decoration: none;" title="Linux">Linux</a><span style="font-size: 13px; font-family: 微软雅黑; color: rgb(34, 34, 34); font-stretch: normal; font-style: normal; font-variant: normal; font-weight: normal; line-height: 22px;">下可以如下命令检测是否被Syn攻击</span></div><div><span style="font-size: 13px; font-family: 微软雅黑; color: rgb(34, 34, 34); font-stretch: normal; font-style: normal; font-variant: normal; font-weight: normal; line-height: 22px;">netstat -n -p TCP | grep SYN_RECV</span></div><div><span style="font-size: 13px; font-family: 微软雅黑; color: rgb(34, 34, 34); font-stretch: normal; font-style: normal; font-variant: normal; font-weight: normal; line-height: 22px;">一般较新的TCP/IP协议栈都对这一过程进行修正来防范Syn攻击，修改tcp协议实现。主要方法有SynAttackProtect保护机制、SYN cookies技术、增加最大半连接和缩短超时时间等.</span></div><div><span style="font-size: 13px; font-family: 微软雅黑; color: rgb(34, 34, 34); font-stretch: normal; font-style: normal; font-variant: normal; font-weight: normal; line-height: 22px;">但是不能完全防范syn攻击。</span></div><div><span style="font-size: 13px; font-family: 微软雅黑; color: rgb(34, 34, 34); font-stretch: normal; font-style: normal; font-variant: normal; font-weight: bold; line-height: 22px; background: transparent; border: none; list-style: none; margin: 0px; padding: 0px;">TCP 四次挥手</span></div><div><span style="font-size: 13px; font-family: 微软雅黑; color: rgb(34, 34, 34); font-stretch: normal; font-style: normal; font-variant: normal; font-weight: normal; line-height: 22px;">TCP的连接的拆除需要发送四个包，因此称为四次挥手(four-way handshake)。客户端或服务器均可主动发起挥手动作，在socket编程中，任何一方执行close()操作即可产生挥手操作。</span></div><p style="border:none;list-style:none;margin:0px;padding:0px;font-family:微软雅黑;background:transparent;"></p><div style="border: 1px solid rgb(231, 231, 231); list-style: none; margin: 10px auto; padding: 5px; background: transparent; max-width: 100%; clear: both;"><a href="http://www.centos.bz/wp-content/uploads/2012/08/100327022731.jpg" rel="5 of 6" rev="4" style="border: none; list-style: none; margin: 0px; padding: 0px; background: transparent; font-size: 13px; font-family: 微软雅黑; font-stretch: normal; font-style: normal; font-variant: normal; font-weight: normal; line-height: 22px; color: rgb(164, 0, 0); text-decoration: none;"><img src="TCP三次握手及四次挥手详细图解  Linux服务器运维日志_files/100327022731.jpg" type="image/jpeg" data-filename="100327022731.jpg" height="532" style="cursor: default;cursor: default;cursor: default;" width="717"/></a></div><div style="border: none; list-style: none; margin: 0px; padding: 0px; background: transparent;"><div><span style="font-size: 13px; font-family: 微软雅黑; color: rgb(34, 34, 34); font-stretch: normal; font-style: normal; font-variant: normal; font-weight: normal; line-height: 22px;">参见</span><a href="https://www.centos.bz/tag/wireshark/" style="border: none; list-style: none; margin: 0px; padding: 0px; background: transparent; font-size: 13px; font-family: 微软雅黑; font-stretch: normal; font-style: normal; font-variant: normal; font-weight: normal; line-height: 22px; color: rgb(164, 0, 0); text-decoration: none;" title="wireshark">wireshark</a><span style="font-size: 13px; font-family: 微软雅黑; color: rgb(34, 34, 34); font-stretch: normal; font-style: normal; font-variant: normal; font-weight: normal; line-height: 22px;">抓包，实测的抓包结果并没有严格按挥手时序。我估计是时间间隔太短造成。</span></div></div><div style="border: 1px solid rgb(231, 231, 231); list-style: none; margin: 10px auto; padding: 5px; background: transparent; max-width: 100%; clear: both;"><a href="http://www.centos.bz/wp-content/uploads/2012/08/100327023334.png" rel="6 of 6" rev="5" style="border: none; list-style: none; margin: 0px; padding: 0px; background: transparent; font-size: 13px; font-family: 微软雅黑; font-stretch: normal; font-style: normal; font-variant: normal; font-weight: normal; line-height: 22px; color: rgb(164, 0, 0); text-decoration: none;"><img src="TCP三次握手及四次挥手详细图解  Linux服务器运维日志_files/100327023334.png" type="image/png" data-filename="100327023334.png" height="448" style="cursor: default;cursor: default;cursor: default;" width="799"/></a></div><div><br/></div></div><div style="border: none; list-style: none; margin: 0px; padding: 0px; background: transparent; font-size: 83.3%;"><span style="font-size: 83.3%; font-family: 微软雅黑; color: rgb(34, 34, 34); font-stretch: normal; font-style: normal; font-variant: normal; font-weight: normal; line-height: 22px;">转载请标明文章来源:《</span><a href="https://www.centos.bz/2012/08/tcp-establish-close/" style="border: none; list-style: none; margin: 0px; padding: 0px; background: transparent; font-size: 83.3%; font-family: 微软雅黑; font-stretch: normal; font-style: normal; font-variant: normal; font-weight: normal; line-height: 22px; color: rgb(164, 0, 0); text-decoration: none;">https://www.centos.bz/2012/08/tcp-establish-close/</a><span style="font-size: 83.3%; font-family: 微软雅黑; color: rgb(34, 34, 34); font-stretch: normal; font-style: normal; font-variant: normal; font-weight: normal; line-height: 22px;">》</span></div></div></div></div></div></div></div></div></div></div></div></span>
</div></body></html> 